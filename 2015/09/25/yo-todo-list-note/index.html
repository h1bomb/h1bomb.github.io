<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！</title>
  <meta name="author" content="H1bomb">
  
  <meta name="description" content="title: todos用yo来实现的说明
本文档的目的是通过一个todos的例子讲下如何用yo进行前端开发，包含开发流程全过程，涵盖：开发，构建，测试，调试，部署。规范前端开发的工作流，后续会补充单元测试的部分。
中间使用到的工具和框架
服务端：

yo（express，一些必要的中间件）
npm">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"></h1>
  

      
      <time datetime="2015-09-25T00:25:32.000Z">Sep 25 2015</time>
      
    </header>
    <div class="entry">
      
        <h1 id="title:_todos用yo来实现的说明">title: todos用yo来实现的说明</h1>
<p>本文档的目的是通过一个todos的例子讲下如何用yo进行前端开发，包含开发流程全过程，涵盖：开发，构建，测试，调试，部署。规范前端开发的工作流，后续会补充单元测试的部分。</p>
<h2 id="中间使用到的工具和框架">中间使用到的工具和框架</h2>
<h3 id="服务端：">服务端：</h3>
<ul>
<li>yo（express，一些必要的中间件）</li>
<li>npm（安装node模块）</li>
</ul>
<h3 id="客户端：">客户端：</h3>
<ul>
<li>sea.js(客户端依赖包处理)</li>
<li>SPM（客户端依赖包管理）</li>
<li>gulp（项目构建，js，css，预处理，合并，压缩，部署）</li>
<li>compass（css预编译）</li>
<li>npm（工具依赖管理）</li>
</ul>
<h2 id="目录结构：">目录结构：</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">yo.todo</div><div class="line"> <span class="string">|_client  客户端目录</span></div><div class="line"> <span class="string">|  |_js   前端js源码目录</span></div><div class="line"> <span class="string">|  |_sass sass源码目录</span></div><div class="line"> <span class="string">|  |_index.js  前端js的入口文件</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（依赖包）</span></div><div class="line"> <span class="string">|  |_gulpfile.js  项目构建gulp脚本</span></div><div class="line"> <span class="string">|_server  服务端目录</span></div><div class="line"> <span class="string">|  |_adapters  接口适配业务代码目录</span></div><div class="line"> <span class="string">|  |_interface  接口配置文件目录</span></div><div class="line"> <span class="string">|  |_stub  后端桩代码目录</span></div><div class="line"> <span class="string">|  |_views 视图目录</span></div><div class="line"> <span class="string">|  |_app.js  应用入口文件</span></div><div class="line"> <span class="string">|  |_staticConfig.js 静态文件路径配置</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（服务端端）</span></div><div class="line"> <span class="string">|_public  静态资源目录（用于开发，测试阶段）</span></div><div class="line">    <span class="string">|_css</span></div><div class="line">    <span class="string">|_sea.js 依赖seajs</span></div></pre></td></tr></table></figure>

<h2 id="服务初始化的过程：">服务初始化的过程：</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:700px; height:500px;" src="https://www.processon.com/embed/55fd7ef8e4b00fa66f1009b7"></iframe>

<h2 id="请求调用过程">请求调用过程</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:670px; height:320px;" src="https://www.processon.com/embed/55fe57eae4b00fa66f125212"></iframe>

<h2 id="开发步骤">开发步骤</h2>
<p>准备：</p>
<ul>
<li>安装必要的开发工具,当然先得安装node.js,具体参考<a href="https://nodejs.org/" target="_blank" rel="external">这里</a>。</li>
<li>安装compass,先安装ruby，参考<a href="http://www.ruanyifeng.com/blog/2012/11/compass.html" target="_blank" rel="external">这里</a></li>
<li>安装spm,运行<code>npm install spm@3.4.3 -g</code>（spm3.4.3之后使用了webpack，所以暂时用3.4.3）。</li>
<li>安装gulp，运行<code>npm install gulp -g</code>(如果安装了cnpm，可以替代npm)。</li>
<li>安装slush，运行<code>npm install slush -g</code>（用于创建空项目）。</li>
<li>安装slush-yo,运行<code>npm install slush-yo -g</code>(yo项目模板)。</li>
</ul>
<h3 id="新建一个空项目">新建一个空项目</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir todos</div><div class="line">slush yo</div><div class="line">cd client</div><div class="line">spm <span class="operator"><span class="keyword">install</span></span></div><div class="line">npm <span class="keyword">install</span></div><div class="line">cd <span class="keyword">server</span></div><div class="line">npm <span class="keyword">install</span></div></pre></td></tr></table></figure>

<p>在mac或者ubuntu上需要用<code>sudo</code>。</p>
<p>运行空项目：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis-<span class="keyword">server</span> -port <span class="number">7777</span></div><div class="line"></div><div class="line">node app</div></pre></td></tr></table></figure>

<p>可以看到如图：<br><img src="http://7mj4k1.com1.z0.glb.clouddn.com/0416BFD2-66BD-4DAA-9246-33ED700FDCE1.png" alt="运行成功"></p>
<h3 id="编写服务接口配置">编写服务接口配置</h3>
<p>需要存储todo list的服务，这个例子数据和状态主要保存服务端，</p>
<ul>
<li>添加一个todo;</li>
<li>编辑一个todo;</li>
<li>获取todo列表；</li>
<li>切换todo的状态；</li>
<li>删除todo；</li>
<li>清除已完成的todo；</li>
</ul>
<p>代码如下：</p>
<p>server/stub/router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list = [];</div><div class="line"><span class="keyword">var</span> toggleAll = <span class="literal">false</span>;</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{</div><div class="line"></div><div class="line">    <span class="comment">//添加</span></div><div class="line">    app.post(<span class="string">'/todo'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (req.body.todo) {</div><div class="line">            list.push({</div><div class="line">                id: uuid(),</div><div class="line">                todo: req.body.todo,</div><div class="line">                state: <span class="number">0</span></div><div class="line">            });</div><div class="line">            res.send(ret(<span class="literal">true</span>));</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            res.send(ret(<span class="literal">false</span>));</div><div class="line">        }</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//编辑保存</span></div><div class="line">    app.put(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> saved = <span class="literal">false</span>,</div><div class="line">            state;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    setval(req.body.todo, req.body.state, list[i]);</div><div class="line">                    saved = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(saved));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//首页</span></div><div class="line">    app.get(<span class="string">'/todos'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> data = ret(<span class="literal">true</span>, list);</div><div class="line">        res.send(data);</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//删除</span></div><div class="line">    app.delete(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> isDel = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    list.splice(i, <span class="number">1</span>);</div><div class="line">                    isDel = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(isDel));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//切换状态</span></div><div class="line">    app.put(<span class="string">'/todos/toggleall'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (!toggleAll) {</div><div class="line">                list[i].state = <span class="number">1</span>;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                list[i].state = <span class="number">0</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        toggleAll = !toggleAll;</div><div class="line">        res.send(ret(<span class="literal">true</span>));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//清除完成项</span></div><div class="line">    app.delete(<span class="string">'/todos/completed'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> unCompleted = [];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (list[i].state === <span class="number">0</span>) {</div><div class="line">                unCompleted.push(list[i]);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        list = unCompleted;</div><div class="line">        <span class="keyword">return</span> res.send(ret(<span class="literal">true</span>, list));</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>

<p>可以用postman类似的http客户端测试下服务：</p>
<p><img src="http://7wy47w.com1.z0.glb.clouddn.com/C031899C-515A-455E-9013-D5126B1ABDAE.png" alt="postman"></p>
<h3 id="编写前端view对应后端服务的接口配置和接口适配">编写前端view对应后端服务的接口配置和接口适配</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">exports.domain = <span class="string">'http://localhost:3000'</span>;</div><div class="line">exports.res =</div><div class="line">    [{</div><div class="line">    route: <span class="string">'/'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    params: []</div><div class="line">}, {</div><div class="line">    route: <span class="string">'/:state'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    adapter: <span class="string">'index'</span>,</div><div class="line">    params: []</div><div class="line">}];</div></pre></td></tr></table></figure>

<p>目前的todo的view只有一个，为了使不同状态的匹配加了”/:state”的路由。<br>后端映射到同一个接口。</p>
<p>后端服务也许无法满足你前端展示的要求，所以，会在适配层，加一些返回数据结构的处理。<br>适配层的业务注入规约：会找到interface的路由作为注入的原则（路由名称+请求方法），或者指定路由的适配的业务模块。<br>代码如下（server/adapters/index.js）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">exports.get = <span class="function"><span class="keyword">function</span><span class="params">(data, req, res)</span> </span>{</div><div class="line">    <span class="keyword">var</span> states = [<span class="string">'active'</span>, <span class="string">'completed'</span>];</div><div class="line">    <span class="keyword">var</span> curState = <span class="string">'all'</span>;</div><div class="line">    <span class="keyword">var</span> curStateVal = <span class="number">3</span>;</div><div class="line">    data.completedTodos = <span class="literal">false</span>; <span class="comment">//完成的todos</span></div><div class="line">    data.activeTodoWord = <span class="string">'items'</span>;<span class="comment">//todo单位的单复数</span></div><div class="line">    data.activeTodoCount = <span class="number">0</span>;<span class="comment">//当前未完成todo</span></div><div class="line">    data.allCount = data.data.length;<span class="comment">//所有的todo数量</span></div><div class="line">    data.module = <span class="string">'todos'</span>;<span class="comment">//js的入口模块</span></div><div class="line">    <span class="keyword">var</span> curData = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; states.length; j++) { <span class="comment">//判断过滤条件</span></div><div class="line">        <span class="keyword">if</span> (states[j] === req.proxyParams.params.state) {</div><div class="line">            curState = states[j];</div><div class="line">            curStateVal = j;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            curState = <span class="string">'all'</span>;</div><div class="line">            curStateVal = <span class="number">3</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    data[curState] = <span class="literal">true</span>; <span class="comment">//设置当前的过滤条件</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.data.length; i++) {</div><div class="line">        <span class="keyword">if</span> (data.data[i].state === <span class="number">1</span>) { <span class="comment">//设置是否有完成</span></div><div class="line">            data.completedTodos = <span class="literal">true</span>;</div><div class="line">            data.data[i].completed = <span class="literal">true</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            data.activeTodoCount++; <span class="comment">//设置todo的数据</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (data.data[i].state === curStateVal) {</div><div class="line">            curData.push(data.data[i]); <span class="comment">//过滤数据</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (curStateVal !== <span class="number">3</span>) { <span class="comment">//设置过滤后的数据</span></div><div class="line">        data.data = curData;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.activeTodoCount === <span class="number">1</span>) { <span class="comment">//设置展示单复数</span></div><div class="line">        data.activeTodoWord = <span class="string">'item'</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="编写模板">编写模板</h3>
<p>拆解页面结构：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">layout</div><div class="line">  <span class="command">\_</span>header</div><div class="line">  <span class="command">\_</span>todo</div><div class="line">    <span class="command">\_</span>header</div><div class="line">    <span class="command">\_</span>section</div><div class="line">    <span class="command">\_</span>footer</div><div class="line">    <span class="command">\_</span>bottom</div><div class="line">  <span class="command">\_</span>footer</div></pre></td></tr></table></figure>

<p>其中，header，todo/header,todo/section,todo/footer,todo/bottom,footer都是partials<br>采用handlebars模板编写。<br>当前后端返回数据时，在前端进行数据绑定生成HTML。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/78F31156-3915-4DBB-847C-FFF611125C2C.png" alt="没有样式的视图"></p>
<h3 id="编写css样式">编写css样式</h3>
<p>编写样式采用compass的方式，用compass watch，实时编译成css。</p>
<p>到client目录，直接<code>compass watch</code></p>
<p>可以按照partials，拆分样式。<br>配置生成文件，在config.rb,或者使用gulp进行的构建。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/B9B70361-8948-411C-908F-00B503DDB8B2.png" alt="添加样式后"></p>
<h3 id="编写JS前端逻辑">编写JS前端逻辑</h3>
<p>前端需要操作服务端的todo的内容，并且展现，主要是增删查改这些操作，同时绑定相关的事件。这个例子里面使用jquery和pjax等，所以需要在<code>client</code>下的<code>package.json</code>,添加依赖包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">"spm"</span>: {</div><div class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: {</div><div class="line">    <span class="string">"jquery"</span>: <span class="string">"1.8.3"</span>,</div><div class="line">    <span class="string">"jquery-pjax-183"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">    <span class="string">"nprogress-183"</span>: <span class="string">"0.1.6"</span>,</div><div class="line">    <span class="string">"import-style"</span>: <span class="string">"1.0.0"</span></div><div class="line">  },</div><div class="line"> ...</div></pre></td></tr></table></figure>

<p>需要执行<code>spm install</code>。</p>
<p>前端的主要逻辑在<code>js/todos.js</code>里面，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * todos</div><div class="line"> *</div><div class="line"> * todos的前端代码</div><div class="line"> * 只提交todo的操作，服务端维护todo状态</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</div><div class="line"><span class="keyword">var</span> NProgress = <span class="built_in">require</span>(<span class="string">'nprogress-183'</span>);</div><div class="line"><span class="built_in">require</span>(<span class="string">'jquery-pjax-183'</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 初始化Pjax</div><div class="line"> *</div><div class="line"> * @return void</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initPjax</span><span class="params">()</span> </span>{</div><div class="line">    $(<span class="built_in">document</span>).pjax(<span class="string">'a'</span>, <span class="string">'#pjax-container'</span>);</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.start();</div><div class="line">    });</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.done();</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> ENTER_KEY = <span class="number">13</span>; <span class="comment">//回车键</span></div><div class="line"><span class="keyword">var</span> ESCAPE_KEY = <span class="number">27</span>; <span class="comment">//esc键</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> $newTodoInput = $(<span class="string">"#new-todo"</span>), <span class="comment">//新建一个todo</span></div><div class="line">    $listLi = $(<span class="string">"#todo-list li"</span>), <span class="comment">//列表单元</span></div><div class="line">    $listToggle = $(<span class="string">"#todo-list .toggle"</span>), <span class="comment">//切换todo状态</span></div><div class="line">    $listLiEdit = $(<span class="string">"#todo-list .edit"</span>), <span class="comment">//编辑输入</span></div><div class="line">    $toggleall = $(<span class="string">"#toggle-all"</span>), <span class="comment">//切换所有的todo状态</span></div><div class="line">    $listDestroy = $(<span class="string">"#todo-list .destroy"</span>), <span class="comment">//删除todo</span></div><div class="line">    $clearCompleted = $(<span class="string">"#clear-completed"</span>); <span class="comment">//清除完成的</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 界面操作对象</div><div class="line"> * @type {Object}</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> actions = {</div><div class="line">    toggleAll: {</div><div class="line">        url: <span class="string">'/todos/toggleall'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $toggleall</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    add: {</div><div class="line">        url: <span class="string">'/todo'</span>,</div><div class="line">        method: <span class="string">'POST'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $newTodoInput,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    actions.add.data = {</div><div class="line">                        todo: $(e.target).val() + <span class="string">''</span></div><div class="line">                    };</div><div class="line">                    $(e.target).val(<span class="string">''</span>);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    edit: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">var</span> state = elem.parents(<span class="string">'li'</span>).find(<span class="string">'.toggle'</span>).attr(<span class="string">'checked'</span>) ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.data = {</div><div class="line">                todo: elem.parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(),</div><div class="line">                state: state</div><div class="line">            };</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listToggle</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'dblclick'</span>,</div><div class="line">            elem: $listLi,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> $input = $(e.target).closest(<span class="string">'li'</span>).addClass(<span class="string">'editing'</span>).find(<span class="string">'.edit'</span>);</div><div class="line">                $input.val($input.val()).focus();</div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> val = e.target.value;</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line"></div><div class="line">                    $(e.target).parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(val);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (e.which === ESCAPE_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">        }, {</div><div class="line">            event: <span class="string">'blur'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                $(e.target).parents(<span class="string">'li'</span>).removeClass(<span class="string">'editing'</span>);</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    remove: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listDestroy,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    clearCompleted: {</div><div class="line">        url: <span class="string">'/todos/completed'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $clearCompleted</div><div class="line">        }]</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 事件绑定操作</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">()</span> </span>{</div><div class="line">    $.each(actions, <span class="function"><span class="keyword">function</span><span class="params">(key, value)</span> </span>{</div><div class="line">        $.each(value.eventHandle, <span class="function"><span class="keyword">function</span><span class="params">(index, hb)</span> </span>{</div><div class="line">            hb.elem.live(hb.event, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> isSend = <span class="literal">false</span>;</div><div class="line">                <span class="keyword">if</span> (hb.handle) {</div><div class="line">                    isSend = hb.handle(e);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    isSend = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">if</span> (isSend) {</div><div class="line">                    <span class="keyword">if</span> (value.before) {</div><div class="line">                        value.before($(e.target));</div><div class="line">                    }</div><div class="line">                    send(value);</div><div class="line">                }</div><div class="line">            });</div><div class="line">        });</div><div class="line">    });</div><div class="line">    initPjax();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 发送操作信息</div><div class="line"> * @param  {Object} hb</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">(hb)</span> </span>{</div><div class="line">    <span class="keyword">var</span> url = hb.url + (hb.params || <span class="string">''</span>);</div><div class="line">    $.ajax({</div><div class="line">        url: url,</div><div class="line">        type: hb.method,</div><div class="line">        data: hb.data ? hb.data : <span class="literal">null</span>,</div><div class="line">        dataType: <span class="string">"json"</span></div><div class="line">    }).done(<span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (data.opts) {</div><div class="line">            $.pjax.reload(<span class="string">'#pjax-container'</span>);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            alert(<span class="string">'something wrong!'</span>);</div><div class="line">        }</div><div class="line">    }).fail(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        alert(<span class="string">'something wrong!'</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">bind();</div></pre></td></tr></table></figure>

<h3 id="整理联调">整理联调</h3>
<p>代码编写完成后，可以通过<code>gulp start</code>,进行代码联调。<br>看看有没有问题，修复开发过程中疏漏的点。在yo中，如果是开发环境，会自动启用smp的服务，对于拆散js的组合调用，可以用chrome dev tool进行前端调试，后端调试，可以使用<code>npm install -g node-inspector</code>,用<code>node-debug app.js</code>进行服务端的代码调试。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/EE3F2819-9B70-4DF3-88F1-AB171750DD97.png" alt="chrome dev tool"></p>
<p>服务端的express传参，和变量数据，可以通过<code>express-debug</code>查看<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/99C72E62-EC9C-4357-89B6-43902ACA9E34.png" alt="express-debug"></p>
<h3 id="构建项目">构建项目</h3>
<p>到此为止，已经把todos的功能已全部实现但是，工作流程，才走了一半，后面将会执行构建，将现有的项目，部署到测试环境，当测试环境测试没有问题，讲发布到生产。</p>
<p>而做这些事情，可以由gulp来完成，gulp可以编写管道式的构建过程，高效的将需要的自动化过程执行。<br>目前前端的gulp涉及如下的任务：</p>
<ul>
<li>运行server</li>
<li>compass的实时预处理</li>
<li>js的合并和库文件的合并</li>
<li>样式的合并</li>
<li>部署到CDN</li>
</ul>
<p>代码清单详见：client/gulpfile.js。</p>
<h4 id="测试代码打包">测试代码打包</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp</div></pre></td></tr></table></figure>

<p>测试环境运行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ..</div><div class="line">NODE_ENV=test node server/app</div></pre></td></tr></table></figure>

<h4 id="生产环境发布和运行">生产环境发布和运行</h4>
<p>把代码部署到CDN</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp dist</div></pre></td></tr></table></figure>

<p>运行生产环境,需要保证服务不会挂掉，所以需要使用MP2来进行进程守护，以及服务监控和治理。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ..</div><div class="line">NODE_ENV=production pm2 <span class="operator"><span class="keyword">start</span> <span class="keyword">server</span>/app</span></div></pre></td></tr></table></figure>

<h2 id="后续补充工作流">后续补充工作流</h2>
<ul>
<li>单元测试</li>
<li>持续集成</li>
<li>代码检查</li>
</ul>
<h2 id="后续待做事项">后续待做事项</h2>
<ul>
<li>组件化</li>
<li>前后端分离（接口规范）</li>
<li>docker化</li>
</ul>

      
    </div>
    
    <footer>
      <div class="alignleft">
      
      
      </div>
      <div class="clearfix"></div>
    </footer>
    
  </div>
</article>


<section id="comment">
  
            <!-- Duoshuo Comment BEGIN -->
            <div class="ds-thread"></div>
            <script type="text/javascript">
                var duoshuoQuery = {short_name:"uupup"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';ds.async = true;
                    ds.src = 'http://static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
            <!-- Duoshuo Comment END -->
      
  
</section>

</div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2015 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
