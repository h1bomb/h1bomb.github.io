<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！</title>
  <meta name="author" content="H1bomb">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/17/measuring-javascript-functions-performance/">测量javascript函数的性能[译]</a></h1>
  

      
      <time datetime="2015-09-17T00:16:58.000Z">Sep 17 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址:<a href="http://www.sitepoint.com/measuring-javascript-functions-performance/" target="_blank" rel="external">http://www.sitepoint.com/measuring-javascript-functions-performance</a></p>
<p>性能总是软件中扮演了重要的角色。在网络上，性能是尤为重要，如果我们提供缓慢的网页给用户，我们的用户可以轻松更改网站去访问我们的竞争对手的网站。作为一个专业的web开发者，我们不得不把这个问题考虑在内。很多老的网络性能优化的最佳实践，就像请求最小化，使用CDN，不写渲染代码块，如今还是管用的。然而，越来越多的web应用在使用Javascript，验证我们的代码是快的是很重要的。</p>
<p>假如你有一个正在运行的函数，但是你怀疑这个函数运行没有足够快，同时你计划着要改进这个函数。如何证明你的假设呢？什么是当今测试函数性能的最贱实践呢？一般来说，最好实现这个任务的方式是使用函数内建的<code>performance.now()</code>来测量在你执行函数前后的时间。</p>
<p>在这篇文章我们将会讨论如何测量代码执行时间和避免一些常见的坑的技术。</p>
<p><code>Performance.now()</code><br>高精度计时接口提供的一个方法，名字叫<code>now()</code>的可以返回一个DOM高精度时间戳对象。提供了一个浮点小数反映当前时间毫秒到毫秒的千分之一的时间戳。分别，这些数据没有添加过多的值来提供你分析，但是两个不同的数字之间的差值可以描述所消耗多少时间。</p>
<p>事实上它比内置的日期对象更准确,并且是‘单调’的。意味着，简单来说，是不会受到系统的影响（像你的笔记本操作系统）周期性地校正系统时间。在更简单来说，定义的两个日期实例计算出的插值并不表示所有消耗的时间。</p>
<p>“单调”的数学定义式是（一个函数或数量）不同的方式进行不是增加就是减少。</p>
<p>另一种方式的解释，可以尝试想象下这一年之中当时钟前进或后退。例如，当时钟在的你的国家由于需要提高白天的日照，从而把时间跳过一小时，如果你创建时间实例在这个时间回退一小时之前，另一个时间实例在这个之后，将会看到不同内容就像“1小时3秒123毫秒”。如果使用两个<code>performance.now()</code>实例，会是”3秒123毫秒456789千分之一毫秒”。</p>
<p>在这个章节，我不会讲这些API的详情。所以如果你要看更多关于如何使用，我建议你去看下<a href="http://www.sitepoint.com/discovering-the-high-resolution-time-api/" target="_blank" rel="external">探索高精度计时API</a>这个文章。</p>
<p>现在你已经知道了什么是高精度计时API和如何使用，让我们深入探讨一些潜在的问题。但在这之前，我们定义一个叫<code>makeHash()</code>的函数来用于我本文的其余部分的介绍。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHash</span><span class="params">(source)</span> </span>{</div><div class="line">  <span class="keyword">var</span> hash = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (source.length === <span class="number">0</span>) <span class="keyword">return</span> hash;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) {</div><div class="line">    <span class="keyword">var</span> char = source.charCodeAt(i);</div><div class="line">    hash = ((hash&lt;&lt;<span class="number">5</span>)-hash)+char;</div><div class="line">    hash = hash & hash; <span class="comment">// 转化到32的整形</span></div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>执行这个函数像如下的测量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> result = makeHash(<span class="string">'Peter'</span>);</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>如果你在浏览器里运行，你应该可以看到像如下的结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>运行的例子如下：</p>
<iframe id="cp_embed_YXmdNJ" src="//codepen.io/SitePoint/embed/YXmdNJ?height=350&amp;theme-id=6441&amp;slug-hash=YXmdNJ&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>通过这个例子，来开始我们的讨论</p>
<p>陷阱 #1 - 不小心测量了不重要的事情<br>在这个例子里，你能在<code>performance.now()</code>之间只做一件事并且其他的函数调用<code>makeHash()</code>,并指定其值设置为一个变量的结果。我们需要执行该功能，没有别的时间。这个测量详细如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(makeHash(<span class="string">'Peter'</span>));  <span class="comment">// bad idea!</span></div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_PqMXWv" src="//codepen.io/SitePoint/embed/PqMXWv?height=350&amp;theme-id=6441&amp;slug-hash=PqMXWv&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>在这个例子里，我们将会测试<code>makeHash(&#39;Peter&#39;)</code>调用所消耗的时间，多长在发送和打印输出在控制台。我们不知道多久这两个操作分别的时间消耗。你只知道一起的时间。它需要发送和打印输出的时间将很大程度上取决于浏览器，甚至取决于当时正在进行什么。</p>
<p>也许你完全知道的console.log是不可预测的消耗时间。但它是将执行多个功能同样是错误，即使各功能不涉及任何的I/O。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> name = <span class="string">'Peter'</span>;</div><div class="line"><span class="keyword">var</span> result = makeHash(name.toLowerCase()).toString();</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>同样，我们不知道的执行时间是如何分布的。变量赋值是<code>toLowerCase（）</code>的调用，还是<code>toString（）</code>的调用？</p>
<p>Pitfall #2 – Measuring only Once<br>Another common mistake is to make just one measurement, summarize the time taken and draw conclusions based on that. It’s likely to be totally different at different times. The execution time greatly depends on various factors:</p>
<p>Time for the compiler to warm up (e.g. time to compile the code into byte code)<br>The main thread being busy doing other things we didn’t realize were going on<br>Your computer’s CPU(s) being busy with something that slows down your whole browser<br>An incremental improvement is to execute the function repeatedly, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">}</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, ((t1 - t0) / <span class="number">10</span>).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate'</span>);</div></pre></td></tr></table></figure>

<p>A live demo of this example is shown below:</p>
<p>See the Pen Qbezpj by SitePoint (@SitePoint) on CodePen.</p>
<p>The risk with this approach is that our browser’s JavaScript engine might make sub-optimizations which means that the second time the function is called with the same input, it can benefit from remembering the first output and simply use that again. To solve this issue, you can use many different input strings instead of repeatedly sending in the same input string (e.g. ‘Peter’). Obviously, the problem with testing with different inputs is that naturally the function we’re measuring takes different amounts of time. Perhaps some of the inputs cause longer execution time than others.</p>
<p>Pitfall #3 – Relying too Much on the Average<br>In the last section we learned that it’s a good practice to run something repeatedly, ideally with different inputs. However, we have to remember that the problem with different inputs is that the execution might take much longer than all the other inputs. So let’s take a step back and send in the same input. Suppose that we send in the same input ten times and for each, print out how long that took. The output might look something like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0234</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0200</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0281</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0162</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0245</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0677</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0289</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0240</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0311</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>Note how the very first time, the number is totally different from the other nine times. Most likely, that’s because the JavaScript engine in our browser makes some sub-optimizations and needs some warm-up. There’s little we can do to avoid that but there are some good remedies we can consider to prevent a faulty conclusion.</p>
<p>One way is to calculate the average of the last nine times. Another more practical way is to collect all results and calculate a median. Basically, it’s all the results lined up, sorted in order and picking the middle one. This is where performance.now() is so useful, because you get a number you can do whatever with.</p>
<p>Let’s try again but this time we’ll use a median function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> numbers = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  <span class="keyword">var</span> t0 = performance.now();</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">  <span class="keyword">var</span> t1 = performance.now();</div><div class="line">  numbers.push(t1 - t0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Median time'</span>, median(numbers).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>Pitfall #4 – Comparing Functions in a Predictable Order<br>We’ve understood that it’s always a good idea to measure something many times and take the average. Moreover, the last example taught us that it’s preferable to use the median instead of the average.</p>
<p>Now, realistically, a good use of measuring function execution time is to learn which of several functions is faster. Suppose we have two functions that take the same type of input and yield the same result but internally they work differently.</p>
<p>Let’s say we want to have a function that returns true or false if a certain string is in an array of other strings, but does this case insensitively. In other words we can’t use Array.prototype.indexOf because it’s not case insensitive. Here’s one such implementation:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>Immediately we notice that this can be improved because the haystack.forEach loop always goes through all the elements even if we have an early match. Let’s try to write a better version using a good old for loop.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>Now let’s see which one is the fastest. We do this by running each function 10 times and collecting all the measurements:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn1</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn2</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">measureFunction</span><span class="params">(func)</span> </span>{</div><div class="line">  <span class="keyword">var</span> letters = <span class="string">'a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z'</span>.split(<span class="string">','</span>);</div><div class="line">  <span class="keyword">var</span> numbers = [];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; letters.length; i++) {</div><div class="line">    <span class="keyword">var</span> t0 = performance.now();</div><div class="line">    func(letters, letters[i]);</div><div class="line">    <span class="keyword">var</span> t1 = performance.now();</div><div class="line">    numbers.push(t1 - t0);</div><div class="line">  }</div><div class="line">  <span class="built_in">console</span>.log(func.name, <span class="string">'took'</span>, median(numbers).toFixed(<span class="number">4</span>));</div><div class="line">}</div><div class="line"></div><div class="line">measureFunction(isIn1);</div><div class="line">measureFunction(isIn2);</div></pre></td></tr></table></figure>

<p>We run that and get following output:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line">isIn1 took <span class="number">0.0050</span></div><div class="line">isIn2 took <span class="number">0.0150</span></div></pre></td></tr></table></figure>

<p>A live demo of this example is shown below:</p>
<p>See the Pen YXmdZJ by SitePoint (@SitePoint) on CodePen.</p>
<p>What the heck has just happened? The first function was three times faster. That was not supposed to happen!</p>
<p>The explanation is simple but subtle. The first function which uses haystack.forEach benefits from some low-level optimizations in the browser’s JavaScript engine that we don’t get when we use an array index technique. It proves our point: you never know until you measure it!</p>
<p>Conclusions<br>In our attempt to demonstrate how to use performance.now() to get an accurate execution time in JavaScript, we stumbled across a benchmarking scenario where our intuition turned out to be quite the opposite of what our empirical results conclude. The point is that, if you want to write faster web apps your JavaScript code needs to be optimized. Because computers are (almost) living breathing things, they are unpredictable and surprising. The most reliable way to know that our code improvements yield faster execution, is to measure and compare.</p>
<p>The other reason we never know which code is faster, if we have multiple ways of doing the same thing, is because context matters. In the previous section we perform a case insensitive string search looking for one string among 26 other strings. It’s likely that the conclusion would be totally different if we instead had to look for one string among 100,000 other strings.</p>
<p>The list above isn’t exhaustive as there are more pitfalls to be aware of. For example, measuring unrealistic scenarios or only measuring on one JavaScript engine. But the sure thing is that a great asset for JavaScript developers who want to write faster and better web apps is performance.now(). Last but not least, remember that measuring execution time only yields one dimension of “better code”. There’s also memory and code complexity considerations to bear in mind.</p>
<p>What about you? Have you ever used this function to test your code’s performance? If not, how do you proceed in this stage? Please share your thoughts in the comments below. Let’s start a discussion!</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/13/Render-HTML-From-Client-Or-Server/">服务端或客户端生成HTML的设计思想</a></h1>
  

      
      <time datetime="2015-09-13T03:53:49.000Z">Sep 13 2015</time>
      
    </header>
    <div class="entry">
      
        <p>如果说web前端主要是由：HTML,CSS,JavaScript这些技术的组合，那么HTML的生成，可以由服务端或者客户端去渲染，取决于数据和HTML的绑定在哪个端去执行。</p>
<p>当是SPA（Single Page Application）形态的应用时：天然的使HTML的生成或则说DOM生成可以由前端完成，大量的路由逻辑，界面逻辑都在浏览器端完成。主要是服务端提供“服务接口+数据响应”，浏览器端调用“服务接口”，数据绑定到视图渲染（可以是DOM生成或者HTML生成并修改DOM），以及路由视图的跳转。</p>
<p>SPA有一个问题需要解决，那就是如何做SEO，主要问题是两个：一个是URL友好，一个响应HTML结构语义化。</p>
<p>解决办法：</p>
<ol>
<li>url友好</li>
</ol>
<p>url友好，在SPA的大部分前端界面跳转都相对映射的URL（当然如果使用一些前端框架也实现了URL变化，如Angular，React-Router，vue-router），除非把url的变化考虑进去，使用Hash，或者HMTL5的history的push state接口，来改变url。</p>
<p>现有的大部分SPA的前端框架都有前端url路由功能，所以实现这个，难度不大。</p>
<ol>
<li>响应HTML结构语义化 </li>
</ol>
<p>如果数据在客户端绑定并渲染视图，在对于大多数搜索引擎的爬虫无法理解在客户端渲染的DOM，所以最好在服务端生成HTML。</p>
<p>针对SPA，如比较目前比较通用的有类似<a href="http://prerender.io/" target="_blank" rel="external">Prerender.io</a>，<a href="http://www.brombone.com/" target="_blank" rel="external">brombone</a>，<a href="http://www.seo4ajax.com/" target="_blank" rel="external">seojs</a>的服务，原理是：</p>
<ul>
<li>当一个搜索引擎的爬虫访问你的应用程序并且看到<code>&lt;meta name=&quot;fragment&quot; content=&quot;!&quot;&gt;</code>时，它会在你的URL中添加一个<code>?_escaped_fragment_=tag</code>。</li>
<li>你的服务器将会拦截这个请求，并把它发送给一个用来处理这个特殊的爬虫请求的中间件。在这篇文章中，我们选用Prerender.io，因此，下一步是针对Prerender.io的。</li>
<li>Prerender.io 将会检查请求的页面是否有一个现存的快照（或者缓存的页面），如果有，它会将这个页面响应给爬虫，如果没有的话，他会调用PhantomJS(一个服务端渲染DOM的中间键)来渲染这个完整页面，并将它响应给爬虫。</li>
</ul>
<p>优点：这个的做法的好处是和语言无关，比较解耦，可以和不同的后端语言结合使用。可以单独部署一组SEO的服务器来应对爬虫的访问，对于用户访问影响不大。</p>
<p>缺点：PhantomJS在生成界面的时候，比较消耗服务器资源，同时时间较长，需要做生成界面的缓存，以及页面缓存的更新。</p>
<p>SPA大量在现有互联网的使用，即将到来，只是现在囿于低版本IE浏览器的制约，约束在浏览器的发展。尽管现有前端框架都有优雅降级的做法，但是在大量低版本IE的用户面前，目前是无法大规模使用的。</p>
<p>主要原因：</p>
<ol>
<li>低版本IE(6,7,8)对于ES5的支持(Object.defineProperty)，甚至ES6的支持。</li>
<li>低版本IE(6,7,8)对CSS,DOM不是按照标准去理解的。</li>
<li>低版本IE(6,7,8)JS引擎性能较差，对于重度依赖Javascript的SPA会有性能瓶颈或编码不慎会导致无故内存泄露。</li>
</ol>
<p>但是还是比较看好SPA在浏览器的发展，毕竟新版的IE，以及其他的现代浏览器已经不存在以上的问题了，只是时间问题了。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/12/7-Reasons-to-Upgrade-to-Node-v4-Now/">现在升级到Node V4的七个理由</a></h1>
  

      
      <time datetime="2015-09-12T15:36:53.000Z">Sep 12 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html" target="_blank" rel="external">http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html</a></p>
<p>今天<a href="https://nodejs.org/en/blog/release/v4.0.0/" target="_blank" rel="external">Node v4</a>发布了。这是第一个在io.js合并后的<br>第一个稳定版本，给我们带来了一堆亮点，如新的ES6语法的添加。虽然有已经增加了很好的ES6的描述，但是这篇文章展示了如何使用它们！</p>
<p>特别是，我要去以下ES6补充的地址看看：</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">Template Strings</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">Classes</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">Arrow Functions</a><br><a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">Object Literals</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="external">Promises</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_6_support_in_Mozilla#Additions_to_the_String_object" target="_blank" rel="external">String Methods</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">let and const</a></p>
<h2 id="1-_Template_Strings(模板字符串)">1. Template Strings(模板字符串)</h2>
<p>如果你要用Javascript创建多行字符串，你或许会像下面的做法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = [</div><div class="line">    <span class="string">'The quick brown fox'</span>,</div><div class="line">    <span class="string">'jumps over'</span>,</div><div class="line">    <span class="string">'the lazy dog'</span></div><div class="line">].join(<span class="string">'\n'</span>);</div></pre></td></tr></table></figure>

<p>虽然这适用于少量的文字，但会多个语句变得混乱。因此，聪明的开发者想出了一个叫hack called multiline的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> multiline = <span class="built_in">require</span>(<span class="string">'multiline'</span>);</div><div class="line"><span class="keyword">var</span> message = multiline(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{<span class="comment">/*</span></div><div class="line">    The quick brown fox</div><div class="line">    jumps over</div><div class="line">    the lazy dog</div><div class="line">*/});</div></pre></td></tr></table></figure>

<p>幸运的是，ES6给我们带来了模板字符串：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = `</div><div class="line">    The quick brown fox</div><div class="line">        jumps over</div><div class="line">        the lazy dog</div><div class="line">`;</div></pre></td></tr></table></figure>

<p>在这个特性里，还可以进行字符串的赋值操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> name = <span class="string">'Schroedinger'</span>;</div><div class="line"></div><div class="line"><span class="comment">// stop doing this ...</span></div><div class="line"><span class="keyword">var</span> message = <span class="string">'Hello '</span> + name + <span class="string">', how is your cat?'</span>;</div><div class="line"><span class="keyword">var</span> message = [<span class="string">'Hello '</span>, name, <span class="string">', how is your cat?'</span>].join(<span class="string">''</span>);</div><div class="line"><span class="keyword">var</span> message = <span class="built_in">require</span>(<span class="string">'util'</span>).format(<span class="string">'Hello %s, how is your cat?'</span>, name);</div><div class="line"></div><div class="line"><span class="comment">// and instead do that ...</span></div><div class="line"><span class="keyword">var</span> message = `Hello ${name}, how is your cat?`;</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">查看更多template strings的详情在MDN</a>.</p>
<h2 id="2-_Classes（类）">2. Classes（类）</h2>
<p>定义类ES5看起来有些奇怪，还需要一定的时间去习惯：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Pet = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    <span class="keyword">this</span>._name = name;</div><div class="line">};</div><div class="line"></div><div class="line">Pet.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(Pet.prototype, <span class="string">'name'</span>, {</div><div class="line">  get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">  }</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> Cat = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    Pet.call(<span class="keyword">this</span>, name);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'util'</span>).inherits(Cat, Pet);</div><div class="line"></div><div class="line">Cat.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    Pet.prototype.sayHello.call(<span class="keyword">this</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">};</div></pre></td></tr></table></figure>


<p>幸运的是，在Node中我们可以使用新的ES6语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Pet {</div><div class="line">    constructor(name) {</div><div class="line">        <span class="keyword">this</span>._name = name;</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">    }</div><div class="line">    get name() {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class</span> Cat extends Pet {</div><div class="line">    constructor(name) {</div><div class="line">        super(name);</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        super.sayHello();</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>一个extends关键字，constructors，调用父类和属性。多好？<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">更多在MDN有完整的指南</a></p>
<h2 id="3-_Arrow_Functions(箭头函数)">3. Arrow Functions(箭头函数)</h2>
<p>动态的绑定函数调用的结合总是会引起一些混乱，人们在多个方面围绕它的工作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        self.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    }.bind(<span class="keyword">this</span>));</div><div class="line">};</div></pre></td></tr></table></figure>

<p>现在只需要使用箭头函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach((listener) =&gt; {</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">查看arrow functions更多详情</a>.</p>
<h2 id="4-_Object_Literals(对象直接量)">4. Object Literals(对象直接量)</h2>
<p>当使用对象直接量，你可以使用很不错的快捷方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> age = <span class="number">10</span>, name = <span class="string">'Petsy'</span>, size = <span class="number">32</span>;</div><div class="line"></div><div class="line"><span class="comment">// instead of this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age: age,</div><div class="line">    name: name,</div><div class="line">    size: size</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// ... do this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age,</div><div class="line">    name,</div><div class="line">    size</div><div class="line">};</div></pre></td></tr></table></figure>

<p>此外，您现在可以轻松的<a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">将函数添加到您的对象直接量上</a>。</p>
<h2 id="5-_Promises">5. Promises</h2>
<p>可以替换掉用第三方的像bluebird和Q的依赖，直接使用原生的promises。就像如下的api：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Promise(<span class="function"><span class="keyword">function</span> <span class="params">(resolve, reject)</span> </span>{});</div><div class="line"><span class="keyword">var</span> p2 = Promise.resolve(<span class="number">20</span>);</div><div class="line"><span class="keyword">var</span> p3 = Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>());</div><div class="line"><span class="keyword">var</span> p4 = Promise.all(p1, p2);</div><div class="line"><span class="keyword">var</span> p5 = Promise.race(p1, p2);</div><div class="line"></div><div class="line"><span class="comment">// and obviously</span></div><div class="line">p1.then(() =&gt; {}).catch(() =&gt; {});</div></pre></td></tr></table></figure>

<h2 id="6-_String_Methods">6. String Methods</h2>
<p>我们还可以使用一些新的字符串工具方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// replace `indexOf()` in a number of cases</span></div><div class="line">name.startsWith(<span class="string">'a'</span>)</div><div class="line">name.endsWith(<span class="string">'c'</span>);</div><div class="line">name.includes(<span class="string">'b'</span>);</div><div class="line"></div><div class="line"><span class="comment">// repeat the string three times</span></div><div class="line">name.repeat(<span class="number">3</span>);</div></pre></td></tr></table></figure>

<p>去告诉那些写ruby的孩子！字符串现在还更好的支持unicode的处理。</p>
<h2 id="7-_let_and_const">7. let and const</h2>
<p>猜下这个在如下函数调用后返回的值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">var</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; undefined</span></div></pre></td></tr></table></figure>

<p>是的，undefined。替换掉var，使用let你可以保证预期的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">let</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; 20</span></div></pre></td></tr></table></figure>

<p>理由是：var是函数作用域级的，然而let是块作用域级别的（这是人们所希望）。因为这个，说let是安全的var。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">你可以在MDN上获取更多关于let的信息</a>。</p>
<p>新增：Node现在支持const关键字，从而阻止您重新赋给一个不同的值相同的引用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> MY_CONST = <span class="number">42</span>; <span class="comment">// no, no</span></div><div class="line"><span class="keyword">const</span> MY_CONST = <span class="number">42</span>; <span class="comment">// yes, yes</span></div><div class="line"></div><div class="line">MY_CONST = <span class="number">10</span> <span class="comment">// with const, this is no longer possible</span></div></pre></td></tr></table></figure>

<p>综述所述</p>
<p>Node v4带来了更多的ES6的特性，同时我也希望这些7个例子已经使你信服升级和使用最新版本了。</p>
<p>这些更多的语言特性（像 maps/sets, symbols , generators,等）。请确保你已经查看过ES6补充的NodeV4概述。快乐升级！</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/11/40-npm-modules-we-can-t-live-without/">40个我们不可或缺的NPM包[译]</a></h1>
  

      
      <time datetime="2015-09-11T00:15:14.000Z">Sep 11 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a" target="_blank" rel="external">https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a</a></p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Cv7F9UtBMhsrcV2_rwqEgA.png" alt="npm picture"></p>
<p>Croissant按照字母顺序分享了他们用到的40个不可或缺的NPM模块：</p>
<p>agenda</p>
<p>这是一个类似于“cron”的作业，如每隔几分钟做一些事情。</p>
<p>agenda-ui</p>
<p>可视化的界面，用于管理agenda的作业，就像麦当劳的订单界面，让员工知道订单的状态。</p>
<p>async</p>
<p>用于对多个异步一次处理，主要用于异步编程，尽管我们也开始迁移到”q”,但是我们任然在一些地方使用，像“waterfall”和“each”对于一行数据在多数据相互依赖操作，会用到。</p>
<p>aws-sdk</p>
<p>我们用于上传文件到AWS S3上。</p>
<p>bcryptjs</p>
<p>担心你的密码的安全性？不用了！该算法是行业标准。即使我们遭受过黑客攻击，您的密码将仍然只是字母和符号混合的字符串。只要你的密码不是一个简单字典中的单词，虽然，因为如果有人没有得到这个数据，他们可以尝试在字典中的所有单词进行暴力破解。</p>
<p>body-parser</p>
<p>我们使用ExpressJS，所以我们需要序列化那些JSON的响应。</p>
<p>braintree</p>
<p>用于支付的一个智能（支付网关）依赖包。（国内用到不多）</p>
<p>chai</p>
<p>我们使用这个用于集成测试。（一个断言库）</p>
<p>compression</p>
<p>另一个像Express一样，你需要的包。用于压缩服务的响应，让数据在网络上传输更快。好东西。</p>
<p>express</p>
<p>这是个大魔法师。这是一个ExpressJS和NodeJS的web服务的核心模块，让我们可以不用写了大量的样板HTTP服务器代码。带来了一些很酷的特性，如指定一个静态目录作为一个简单的文件服务器，当然，以从它的充满活力的社区，创建的许多插件，可以很容易使用。</p>
<p>forever</p>
<p>如果一个node进程或者express服务崩溃了怎么办？这个小家伙会在后台为你重新启动。这实在是太聪明 - 你可以指定运行多久失败需要重新启动。这可以防止重启一遍又一遍自动失败进程。</p>
<p>fs-extra</p>
<p>当“fs”模块不够用时，“fs-extra”给你想要的更多功能。我们真的只是用它来满足使一个嵌套的文件夹如果在父文件夹不存在创建的能力。出于某种原因，对于“fs”来说，这是过分的要求。</p>
<p>gm</p>
<p>这个模块是一种法术。GraphicsMagick是一个包装已经由来已久的被用于许多图像操纵的很经典ImageMagick的C库。我们使用对上传图片的尺寸缩放和切图操作。你知道的那些放在AWS美丽场馆我们，我们会对它们用这个处理。</p>
<p>gulp</p>
<p>Gulp总是在我们编码背后运行着。它会自动的压缩我们的javascript和css文件。我们把它用于测试运行。它也有很多的包（如果你要找的话）！有人说它像“grunt”，其实是流运行的。</p>
<p>gulp-angular-templatecache</p>
<p>之前我们提到用Angular吗？我们是用Angular的。这个gulp插件允许我们在所有的HTML模板为一个文件以便更快的加载网站。Angular在加载页面时可以使用这些模板。</p>
<p>gulp-concat</p>
<p>记得我们前面谈到的呗？这需要找下。用于合并文件。</p>
<p>gulp-csso</p>
<p>做css最小化的。</p>
<p>gulp-istanbul</p>
<p>一个运行istanbul的单元测试覆盖率的gulp插件。</p>
<p>gulp-livereload</p>
<p>前端开发者的必备，可以连接你的浏览器当每一次文件修改它会刷新页面。做得好，gulp。</p>
<p>gulp-mocha</p>
<p>用于测试，这个插件封装了mocha，我们可以智能的进行测试，就像保证接口端可以正常运行。</p>
<p>gulp-plumber</p>
<p>由于我们所有事情用gulp的流和管道，我们需要一个小小的库，万一像gulp-csso运行失败，可以保证其他运行平滑。</p>
<p>gulp-sass</p>
<p>你以为我们使用CSS？ 再想一想。你看到的一切曾经是一个轻量的，顶尖的，SCSS（又名Sass）文件。Gulp 监听和编译每当我们作出改变时编译我们出主要的CSS的输出..超级快！</p>
<p>gulp-uglify</p>
<p>最后但并非最不重要的，这一插件确实不错的压缩前端JavaScript代码，所以我们可以超快速和超安全传输给你。</p>
<p>jwt-simple</p>
<p>JWT(JSON Web Token) 编码和解码的node包.</p>
<p>lodash</p>
<p>有用的Javascript的工具集，pick, omit, contains对于接口服务器响应时间大大缩短。</p>
<p>mime-types</p>
<p>用于跟踪文件扩展名的库，一个jpg图片文件得到的结果如“image/jpeg”。</p>
<p>mocha</p>
<p>mocha是一个测试平台，可以使用BDD的方式测试，使用“describe”和“it”，没有比这更简单的Javascript的测试了。 </p>
<p>moment</p>
<p>人性化的时间格式。</p>
<p>moment-timezone</p>
<p>moment的时区转化</p>
<p>mongoose</p>
<p>我们提到我们用MongoDB的？我们使用MongoDB的。Mongoose一直我们的团队所熟知，让我们总能看到一眼我们的数据结构是什么。没有它，你可能最终与各种数据库中的对象，造成谁知道什么样的混乱的后端和前端的。</p>
<p>morgan</p>
<p>express的http的访问日志中间件。</p>
<p>newrelic</p>
<p>New Relic是一家给你的应用提供信息的很酷的公司。你可以很简单的加一个包到你服务的第一行，然后去他们的网站观察神奇的事情发生。我们使用它来获取在产品化的服务上发生的错误。</p>
<p>nodemailer</p>
<p>如果你需要发邮件，不需要你自个发-使用一个邮件传输服务，就像SendGird。这个有一些很好的特性，就像给邮件封装一个漂亮的模板。Nodemailer就是一个让我们发生简单信息到SendGird的包。</p>
<p>prerender-node</p>
<p>还记得我们是用Angular吗？这个是用于因为搜索引擎无法解析Angular才用的。带来了陈显的援助，使用这个包，网络爬虫可以更容易的看到一个不是Angular版本的网站因为prerenderer让它发生变化。关闭JavaScript在Web浏览器您再次浏览Croissant，你就会明白我们的意思。</p>
<p>protractor</p>
<p>protractor是一个端对端的测试框架，可以在浏览器里面进行自动化的执行任务和测试</p>
<p>q</p>
<p>async是不错的瀑布楼和映射操作同时，“q”是不错的使用promises的库，通过它，我们意味着使用普通回调函数以及封装成“q”的promise语法。让我们像使用普通回调方式一样使用链式的异步函数，解决“callback hell”。</p>
<p>request</p>
<p>每当一旦我们需要使用http请求来扩展服务时，我们总是使用这个包即时在NodeJS初期，在内部使用扩展服务。</p>
<p>slug</p>
<p>这个是一个转化“Hello There” 到“hello-there”的库，完美的动态的转化标题成友好的链接。</p>
<p>stripe</p>
<p>值得时间考验。Stripe是我们的信用卡支付流程。这个足够好来存储用户的信用卡信息以PCI-compliant方式。我们使用它们的SDK存储卡到文件和支付。</p>
<p>supertest-as-promised</p>
<p>这个是我们核心的智能测试。使用promises让我么会能很容易导出某种响应状态码，同时使用响应数据在下一次测试中，我们在chai里使用。</p>
<p>这样啦，你有了我们的好东西的清单。我们总是会开放的问题，意见和建议。请友善些:)</p>
<p>Dave<br>Co-founder &amp; CEO, Croissant</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/03/Co-Generator-Usage/">Generator库：co的用法</a></h1>
  

      
      <time datetime="2015-09-03T09:41:11.000Z">Sep 3 2015</time>
      
    </header>
    <div class="entry">
      
        <p>什么是Generator？</p>
<p>Generator是ES6里面新增的语法特性，是异步编程的一个语法级的解决方案。Generator在内部封装的多个状态，在执行Generator函数的时候，会返回一个遍历状态的迭代器对象。表现形式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span><span class="params">()</span> </span>{  <span class="comment">//*是Generator一个语法表示</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span>;<span class="comment">//yield 是返回状态的值</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'world'</span>;</div><div class="line">  <span class="keyword">return</span> <span class="string">'ending'</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> hw = helloWorldGenerator();</div><div class="line"></div><div class="line"></div><div class="line">hw.next();  <span class="comment">//在每次执行迭代器对象时，会返回当前获取的状态信息。</span></div><div class="line"><span class="comment">// { value: 'hello', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'world', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'ending', done: true }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: undefined, done: true }</span></div></pre></td></tr></table></figure>

<blockquote>
<p>Generator与协程<br>协程（coroutine）是一种程序运行的方式，可以理解成“协作的线程”或“协作的函数”。协程既可以用单线程实现，也可以用多线程实现。前者是一种特殊的子例程，后者是一种特殊的线程。</p>
<p>（1）协程与子例程的差异</p>
<p>传统的“子例程”（subroutine）采用堆栈式“后进先出”的执行方式，只有当调用的子函数完全执行完毕，才会结束执行父函数。协程与其不同，多个线程（单线程情况下，即多个函数）可以并行执行，但是只有一个线程（或函数）处于正在运行的状态，其他线程（或函数）都处于暂停态（suspended），线程（或函数）之间可以交换执行权。也就是说，一个线程（或函数）执行到一半，可以暂停执行，将执行权交给另一个线程（或函数），等到稍后收回执行权的时候，再恢复执行。这种可以并行执行、交换执行权的线程（或函数），就称为协程。</p>
<p>从实现上看，在内存中，子例程只使用一个栈（stack），而协程是同时存在多个栈，但只有一个栈是在运行状态，也就是说，协程是以多占用内存为代价，实现多任务的并行。</p>
<p>（2）协程与普通线程的差异</p>
<p>不难看出，协程适合用于多任务运行的环境。在这个意义上，它与普通的线程很相似，都有自己的执行上下文、可以分享全局变量。它们的不同之处在于，同一时间可以有多个线程处于运行状态，但是运行的协程只能有一个，其他协程都处于暂停状态。此外，普通的线程是抢先式的，到底哪个线程优先得到资源，必须由运行环境决定，但是协程是合作式的，执行权由协程自己分配。</p>
<p>由于ECMAScript是单线程语言，只能保持一个调用栈。引入协程以后，每个任务可以保持自己的调用栈。这样做的最大好处，就是抛出错误的时候，可以找到原始的调用栈。不至于像异步操作的回调函数那样，一旦出错，原始的调用栈早就结束。</p>
<p>Generator函数是ECMAScript 6对协程的实现，但属于不完全实现。Generator函数被称为“半协程”（semi-coroutine），意思是只有Generator函数的调用者，才能将程序的执行权还给Generator函数。如果是完全执行的协程，任何函数都可以让暂停的协程继续执行。</p>
<p>如果将Generator函数当作协程，完全可以将多个需要互相协作的任务写成Generator函数，它们之间使用yield语句交换控制权。</p>
</blockquote>
<p>co是什么？</p>
<p>co是tj写的一个用于 Generator 函数的自动执行的函数库。最新是4.0版本，支持promise等一些新特性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// yield any promise</span></div><div class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// resolve multiple promises in parallel</span></div><div class="line">  <span class="keyword">var</span> a = Promise.resolve(<span class="number">1</span>);</div><div class="line">  <span class="keyword">var</span> b = Promise.resolve(<span class="number">2</span>);</div><div class="line">  <span class="keyword">var</span> c = Promise.resolve(<span class="number">3</span>);</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</div><div class="line">  <span class="built_in">console</span>.log(res);</div><div class="line">  <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="comment">// errors can be try/catched</span></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="keyword">try</span> {</div><div class="line">    <span class="keyword">yield</span> Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'boom'</span>));</div><div class="line">  } <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="built_in">console</span>.error(err.message); <span class="comment">// "boom"</span></div><div class="line"> }</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(err)</span> </span>{</div><div class="line">  <span class="comment">// log any uncaught errors</span></div><div class="line">  <span class="comment">// co will not throw any errors you do not handle!!!</span></div><div class="line">  <span class="comment">// HANDLE ALL YOUR ERRORS!!!</span></div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>数组方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [</div><div class="line">    Promise.resolve(<span class="number">1</span>),</div><div class="line">    Promise.resolve(<span class="number">2</span>),</div><div class="line">    Promise.resolve(<span class="number">3</span>),</div><div class="line">  ];</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>对象方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> {</div><div class="line">    <span class="number">1</span>: Promise.resolve(<span class="number">1</span>),</div><div class="line">    <span class="number">2</span>: Promise.resolve(<span class="number">2</span>),</div><div class="line">  };</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; { 1: 1, 2: 2 }</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>co(fn*).then( val =&gt; )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">}, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>var fn = co.wrap(fn*)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fn = co.wrap(<span class="function"><span class="keyword">function</span>* <span class="params">(val)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(val);</div><div class="line">});</div><div class="line"></div><div class="line">fn(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line"></div><div class="line">});</div></pre></td></tr></table></figure>


      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/02/Bluebird-Promise-Usage/">Bluebird中Promise模式使用</a></h1>
  

      
      <time datetime="2015-09-02T00:55:32.000Z">Sep 2 2015</time>
      
    </header>
    <div class="entry">
      
        <p><img src="https://camo.githubusercontent.com/f67ead75c0654cefe0c5b791508731cf08cb5b0c/687474703a2f2f7065746b61616e746f6e6f762e6769746875622e696f2f626c7565626972642f6c6f676f2e706e67" alt="bluebird logo"><br>Bluebird是一个高性能全功能的Promise库，主要有以下特性：</p>
<blockquote>
<ul>
<li>实现了Promises A+规范</li>
<li>同步检查(promise状态，返回值，失败原因)</li>
<li>并发调用(调用多个异步处理)</li>
<li>异步模型转化到Promise模式</li>
<li>使用通过并行使用Python/C＃进行资源管理的取消和超时</li>
<li>并行的C#异步和等待</li>
<li>试用的工具方法，如：<br>.bind()<br>.call()<br>Promise.join()…</li>
<li>调试解决方案和合理的默认值</li>
<li>优越的性能表现</li>
</ul>
</blockquote>
<p>bluebird支持node.js和浏览器端</p>
<p>node.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="operator"><span class="keyword">install</span> bluebird</span></div></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Promise = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</div></pre></td></tr></table></figure>

<p>浏览器端支持（ES5）</p>
<p><img src="https://camo.githubusercontent.com/335f3fdee6026df48a9699235b03cd3e6bf3dba9/68747470733a2f2f73617563656c6162732e636f6d2f62726f777365722d6d61747269782f7065746b615f616e746f6e6f762e737667" alt="浏览器支持"></p>
<p>可见对于IE必须是IE9和以上</p>
<p>用法：</p>
<p>下载：<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js" target="_blank" rel="external">bluebird.js</a>或<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js" target="_blank" rel="external">bluebird.min.js</a></p>
<p>以解析一个json文件为例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fs.readFileAsync(<span class="string">"file.json"</span>).then(<span class="built_in">JSON</span>.parse).then(<span class="function"><span class="keyword">function</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(val.success);</div><div class="line">})</div><div class="line">.catch(<span class="built_in">SyntaxError</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"invalid json in file"</span>);</div><div class="line">})</div><div class="line">.catch(<span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"unable to read file"</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>具体需要看详细的可以查看<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">官方github</a></p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/01/JQuery-Deferred-Promise/">JQuery中Deferred/Promise的使用</a></h1>
  

      
      <time datetime="2015-09-01T00:55:27.000Z">Sep 1 2015</time>
      
    </header>
    <div class="entry">
      
        <p>同样Deferred也是为了解决异步嵌套回调而存在的。早在JQuery 1.5就已经支持了。</p>
<p>使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dtd = $.Deferred(); <span class="comment">// 新建一个Deferred对象</span></div><div class="line"><span class="keyword">var</span> wait = <span class="function"><span class="keyword">function</span><span class="params">(dtd)</span></span>{</div><div class="line">    <span class="keyword">var</span> tasks = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">　　　　　　alert(<span class="string">"执行完毕！"</span>);</div><div class="line">　　　　　　dtd.resolve(); <span class="comment">// 改变Deferred对象的执行状态</span></div><div class="line">　　　　};</div><div class="line"></div><div class="line">　　　　setTimeout(tasks,<span class="number">5000</span>);</div><div class="line">　　　　<span class="keyword">return</span> dtd.promise(); <span class="comment">// 返回promise对象</span></div><div class="line">　　};</div><div class="line"><span class="keyword">var</span> d = wait(dtd); <span class="comment">// 新建一个d对象，改为对这个对象进行操作</span></div><div class="line">$.when(d)</div><div class="line"> .done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"哈哈，成功了！"</span>); })</div><div class="line"> .fail(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"出错啦！"</span>); });</div></pre></td></tr></table></figure>

<p>我们看下怎么样用，下面列举了几个场景：</p>
<ol>
<li>单个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$.ajax(<span class="string">'abc.php'</span>).done(<span class="function"><span class="keyword">function</span><span class="params">(result)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>多个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$.when($.ajax(<span class="string">'abc.php'</span>), $.ajax(<span class="string">'abc2.php'</span>), $.ajax(<span class="string">'abc3.php'</span>))</div><div class="line">.done(<span class="function"><span class="keyword">function</span><span class="params">(result1, result2, result3)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>动画链式调用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.when(preloadImage())</div><div class="line">.then(animation01)</div><div class="line">.then(animation02)</div><div class="line">.then(animation03)</div><div class="line">.then(transition)</div><div class="line">.then(merge)</div><div class="line">.then(zoom)</div><div class="line">.then(showContent)</div><div class="line">.then(flicker);</div></pre></td></tr></table></figure>

<p>和Promise/A+的规范有些出入，可能因为实现比较早，但是其意义和原理是差不多的。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/08/30/Promise-Patterns/">promise设计模式</a></h1>
  

      
      <time datetime="2015-08-30T15:48:38.000Z">Aug 30 2015</time>
      
    </header>
    <div class="entry">
      
        <p>promise是为了解决Javascript的异步编程导致的‘callback hell’而存在的。</p>
<p>目前有多种设计方式，比较知名的如：promise/deferred（jquery就使用了这个方式）,<br>promise/a+（是es6 promise规范）。</p>
<p>当然我们还是希望使用原生的Promise对象，先看下浏览器的支持度：</p>
<iframe src="http://caniuse.com/promises/embed/agents=desktop" width="100%" height="350px"></iframe>

<p>可见IE还是重灾区，firefox和chrome很早就已经实现了原生的promise了。当然如果要使用promise，已有不少第三方库的支持，如jquery，Q，Bluebird，Thenjs…<br>还是比较多的实现，同时值得一提的是推荐使用polyfill的方式来解决，如 <a href="https://github.com/jakearchibald/es6-promise" target="_blank" rel="external">es6-promise</a>,或者使用<a href="https://babeljs.io/" target="_blank" rel="external">Babel</a>进行es6编译转化也是可以的。</p>
<p>先用一个图说明下什么原理：</p>
<p><img src="https://mdn.mozillademos.org/files/8633/promises.png" alt="promise 原理图"></p>
<p>看上去很复杂，其实就是(三个状态的流转)：</p>
<p><img src="http://liubin.github.io/promises-book/Ch1_WhatsPromises/img/promise-states.png" alt="promise 简单图"></p>
<p>分别对应流转，有两个预定义处理句柄：</p>
<p><img src="http://liubin.github.io/promises-book/Ch1_WhatsPromises/img/promise-onFulfilled_onRejected.png" alt="Promise 处理图"></p>
<p>以下摘自MDN的Promise/A+规范说明</p>
<blockquote>
<h2 id="属性">属性</h2>
<h3 id="Promise-length">Promise.length</h3>
<p>长度属性，其值为 1 (构造器参数的数目).</p>
<h3 id="Promise-prototype">Promise.prototype</h3>
<p>表示 Promise 构造器的原型.</p>
<h2 id="方法">方法</h2>
<h3 id="Promise-all(iterable)">Promise.all(iterable)</h3>
<p>返回一个promise，当iterable参数里所有的promise都被解决后，该promise也会被解决。</p>
<h3 id="Promise-race(iterable)">Promise.race(iterable)</h3>
<p>返回一个Promise，当iterable参数里的任意一个子Promise被接受或拒绝后，该promise马上也会用子Promise的成功值或失败原因被接受或拒绝。</p>
<h3 id="Promise-reject(reason)">Promise.reject(reason)</h3>
<p>用失败原因reason拒绝一个Promise对象。<br>Promise.resolve(value)<br>用成功值value解决一个Promise对象。如果该value为可继续的（thenable，即带有then方法），返回的Promise对象会“跟随”这个value，采用这个value的最终状态；否则的话返回值会用这个value满足（fullfil）返回的Promise对象。</p>
<h2 id="Promise原型">Promise原型</h2>
<h3 id="属性-1">属性</h3>
<h3 id="Promise-prototype-constructor">Promise.prototype.constructor</h3>
<p>返回创建了实例原型的函数.  默认为 Promise 函数.</p>
<h2 id="方法-1">方法</h2>
<h3 id="Promise-prototype-catch(onRejected)">Promise.prototype.catch(onRejected)</h3>
<p>添加一个否定(rejection) 回调到当前 promise, 返回一个新的promise。如果这个回调被调用，新 promise 将以它的返回值来resolve，否则如果当前promise 进入fulfilled状态，则以当前promise的肯定结果作为新promise的肯定结果.</p>
<h3 id="Promise-prototype-then(onFulfilled,_onRejected)">Promise.prototype.then(onFulfilled, onRejected)</h3>
<p>添加肯定和否定回调到当前 promise, 返回一个新的 promise, 将以回调的返回值 来resolve.</p>
</blockquote>
<p>示范代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncFunction</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Promise(<span class="function"><span class="keyword">function</span> <span class="params">(resolve, reject)</span> </span>{</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">            resolve(<span class="string">'Async Hello world'</span>);</div><div class="line">        }, <span class="number">16</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line">asyncFunction().then(<span class="function"><span class="keyword">function</span> <span class="params">(value)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(value);    <span class="comment">// =&gt; 'Async Hello world'</span></div><div class="line">}).catch(<span class="function"><span class="keyword">function</span> <span class="params">(error)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(error);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>后面再写下在具体开发中如何使用Promise。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/08/30/CNUTcon-Participants-Experience/">CNUTCon的参会体验</a></h1>
  

      
      <time datetime="2015-08-30T14:56:46.000Z">Aug 30 2015</time>
      
    </header>
    <div class="entry">
      
        <p>对于容器的了解是从docker开始的（最近一些年docker还是很火的），我对于后端架构以及容器技术属于菜鸟水平，所以此次的体验分享还是注重我个人的理解和想法，大家如果觉得有些理解错误或者粗浅，请谅解。</p>
<p>大体内容可以分为四类：技术前瞻（讲概念），架构体系（讲解决方案），开源项目（设计理念），工具实战（云平台）。干货水货皆有。</p>
<p>一开始主要是redhat的副总裁讲谈下一代的PaaS，中间也介绍了redhat的openshift，以及关于容器安全和标准的一些内容，和容器在Paas中发展重要位置和后续开发模式的转变。由于英语水平有限，所以后续还要关注ppt再研究下，总体还是属于技术前瞻和业界发展的方向性的思索。</p>
<p>后面的CoreOS的演讲者，可能我不专心听吧，像是没有理解什么，发个Slide的<a href="https://github.com/kelseyhightower/cnutcon-2015" target="_blank" rel="external">链接</a>,貌似是一些etcd和Kubernetes的实践。</p>
<p>接下来主要是京东和大众点评的解决方案的分享，感觉像是docker使用的兼容之前虚拟技术的结合的做法，用到了openstack，zookeeper，NATS，以及对于不了解容器方式的开发者兼容模式。使用的规模还是比较大的，同时没有用到mesos，swarm，Kubernetes用于docker的集群管理，而是自己对于docker集群的实现了管理方案。第二天的百度的分享同样自己做了很多的事情，构建自己的云架构。</p>
<p>下午的阿里百川的分享TAE系统，给我的印象，还是比较深的，从技术方向，到架构方向，到实际解决问题，到实现思想，比较开阔和开放的，不光是对于云平台有一定的思想提升，还是对于方法论的提升。直接附上<a href="http://mp.weixin.qq.com/s?__biz=MzA4MjA0MTc4NQ==&amp;mid=209978199&amp;idx=1&amp;sn=2424de46eb7dbe50bcb2b3dd346dbfce&amp;scene=1&amp;srcid=CpLCImrAnW9055VsQGc4" target="_blank" rel="external">链接</a>,非常值得一看。</p>
<p>后来也去听了七牛以及华为的OCT，七牛主要是分享了基于容器技术的数据处理主题，在各种系统资源的调度和解决性能瓶颈，以及利用go的并发优势，充分发挥容器在数据处理微服务的能力。华为的OCT听得比较少，只是对于OTC还是蛮兴趣的，主要用于OCI容器标准化的测试，以及业务测试，性能测试等的测试套件，该项目是开源的，一改我之前对于华为技术封闭的看法。附上<a href="https://github.com/huawei-openlab/oct" target="_blank" rel="external">链接</a>。</p>
<p>由于公司新品节的上线缘故，需要远程支援下，所以第一天晚上的会后活动没有报名参加，因此也不知道会有什么收获，后面关注线上社区看有些什么分享。</p>
<p>第二天，一早，google的美女工程师分享了Kubernetes的设计思想和实践，由于可能她长期在国外工作，演讲基本上50%到60%的英文和剩下的中文，给我在理解上造成了一些障碍，其中对于一些原则，还是记忆犹新，简单大于复杂，宠物VS牲口（pets vs cattle），解释下，什么是宠物和牲口，主要是对于线上的服务的思考，宠物般的服务需要呵护和更多的心智来维护保证高可用，由于维护的成本负担比较重，所以宠物般的服务不会很多，而牲口是则是一群服务，虽然很多，但是不需要给每个牲口做做细心呵护，如果出现问题，简单处理，或者直接杀掉，同样也实现了高可用。Kubernetes就是用于管理容器集群的工具，是google的omega的轻量版本，在开源社区还是比较活跃的，后面我估计也会研究下。</p>
<p>之后去听了一个同样是做容器集群管理的mesos是apache旗下的开源项目，演讲的主题偏于实践，主要是讲如何应用该工具，同样以数人云的实践来讲。有一点的实用价值，中间和旁边的一起听的用友小哥聊了下，他说mesos比起Kubernetes来讲更具有企业实际运用价值，同时也比Kubernetes稳定些。后面有空这两个都可以对比使用下。</p>
<p>下午听了vmware的关于 cloud native app的演讲，结合了vmware的产品讲述了开发栈和运维栈结构异同，以及基于容器的一些好的开发实践，以及对于安全和隔离的vmware的实现方案，说下周一会发布这款产品。</p>
<p>由于定了5点的票，所以只能提前走了，走前听了，daocloud郭总的关于微服务架构演进的演讲，结合自身daocloud项目，讲述了构建微服务的开发过程和架构变迁。可能因为daocloud是创业团队，对于架构变迁都是以快速迭代，需求出发的方式，和我的想法十分对位。也讲了docker在微服务的实现起到的重要作用。其中有一点原则很有意义：如果业务的持续集成的速度和演进的复杂程度出现效率问题，才需要做服务的拆分。关于服务的粒度，也做了和SOA的对比。大体微服务粒度在于5-10个人开发的业务复杂度的粒度。其他由于时间问题，稍微听了下coreos的一个分享，双内核，轻量的Linux系统，用于部署容器的系统，也有一些基于coreos封装的工具。</p>
<p>以上是本次参加全球容器大会的大体体验，总的感觉容器技术，百花齐放，各种实现和解决方案，同时大家对于容器技术很大期望，是未来技术变革的一个基点，但同时，还有不少不足和坑需要大家填补，如安全，隔离性，完善的集群管理，热迁移部署等。</p>
<p>关键字：RedHat openshift vmware OCI coreOS mesos Kubernetes swarm oct omega LXC cgroup</p>
<p>题外话</p>
<p>每次参加技术会议，上厕所都有一个奇怪的现象，男厕所需要方便排队，而女厕所却寥寥无几。<br>妹子出现在会上，十分抢眼。</p>
<p>其他的，后续再整理。</p>
<p>9月29日，回南京的火车上。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/05/31/JavaScript-inheritance-5to6/">关于Javascript继承在es5到es6改变</a></h1>
  

      
      <time datetime="2015-05-31T15:02:18.000Z">May 31 2015</time>
      
    </header>
    <div class="entry">
      
        <p>再重温下之前继承的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> inherits = <span class="function"><span class="keyword">function</span><span class="params">(ctor, superCtor)</span> </span>{</div><div class="line">  ctor.super_ = superCtor;</div><div class="line">  ctor.prototype = <span class="built_in">Object</span>.create(superCtor.prototype, {</div><div class="line">    constructor: {</div><div class="line">      value: ctor,</div><div class="line">      enumerable: <span class="literal">false</span>,</div><div class="line">      writable: <span class="literal">true</span>,</div><div class="line">      configurable: <span class="literal">true</span></div><div class="line">    }</div><div class="line">  });</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span><span class="params">(x, y)</span> </span>{</div><div class="line">  <span class="keyword">this</span>.x = x;</div><div class="line">  <span class="keyword">this</span>.y = y;</div><div class="line">}</div><div class="line"></div><div class="line">Point.prototype.toString = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="string">'('</span> + <span class="keyword">this</span>.x + <span class="string">', '</span> + <span class="keyword">this</span>.y + <span class="string">')'</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ColorPoint</span><span class="params">(x, y, color)</span> </span>{</div><div class="line"></div><div class="line">  Point.call(<span class="keyword">this</span>, x, y); </div><div class="line">  <span class="keyword">this</span>.color = color;</div><div class="line">}</div><div class="line"></div><div class="line">inherits(ColorPoint, Point);</div><div class="line"></div><div class="line">ColorPoint.prototype.toString = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.color + <span class="string">' '</span> + ColorPoint.super_.prototype.toString.call(<span class="keyword">this</span>); </div><div class="line">}</div></pre></td></tr></table></figure>

<p>然而es6则可以这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Point {</div><div class="line"></div><div class="line">  constructor(x, y) {</div><div class="line">    <span class="keyword">this</span>.x = x;</div><div class="line">    <span class="keyword">this</span>.y = y;</div><div class="line">  }</div><div class="line"></div><div class="line">  toString() {</div><div class="line">    <span class="keyword">return</span> <span class="string">'('</span> + <span class="keyword">this</span>.x + <span class="string">', '</span> + <span class="keyword">this</span>.y + <span class="string">')'</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class</span> ColorPoint extends Point {</div><div class="line"></div><div class="line">  constructor(x, y, color) {</div><div class="line">    super(x, y); </div><div class="line">    <span class="keyword">this</span>.color = color;</div><div class="line">  }</div><div class="line"></div><div class="line">  toString() {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.color + <span class="string">' '</span> + super.toString(); </div><div class="line">  }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>显然es6的写法更加清晰，隐去了Javascript硬去使用prototype和call的实现细节。但是es6并没有完全按照Java ,C++面向对象的语法来实现，<br>只是对于原型继承的一个语法糖。</p>

      
    </div>
    
      
    
  </div>
</article>





<div class="pagination">
  <table width='100%'>
    <tbody>
    <tr>
      <td width='120' align='left'>
        
      </td>
      <td width='auto' align='center'>
          <a href="/archives/">文章归档</a>
      </td>
      <td width='120' align='right'>
        
        <div class="alignright">
          <a href="/page/2/" class="alignright next">next ›</a>
        </div>
        
      </td>
    </tr>
    </tbody>
  </table>
</div></div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2015 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
