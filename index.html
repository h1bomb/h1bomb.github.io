<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！</title>
  <meta name="author" content="H1bomb">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/10/10/debugging-memory-leaks-node-js-applications/">调试node.js应用的内存泄漏[译]</a></h1>
  

      
      <time datetime="2015-10-10T00:57:34.000Z">Oct 10 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原文：<a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external">http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications</a></p>
<p>有一次，我开着一辆内部是V8双涡轮增压发动机的奥迪，其性能令人难以置信。凌晨3点，我行驶在芝加哥附近没有人的IL-80高速公路，时速达到140MPH。从那时起，“V8”这个术语成为我对高性能的认识。</p>
<blockquote>
<p>Node.js是一个建立在Chrome的JavaScript引擎V8之上的易于快速构建可伸缩的网络应用的平台。</p>
</blockquote>
<p>尽管奥迪的V8非常强大，但仍然限于用你的油箱的容量大小。这同样适用于谷歌的V8引擎 - 在node.js背后的JavaScript引擎。有很多因素使Node.js的性能是难以置信的，<a href="http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js" target="_blank" rel="external">适用于许多应用案例</a>，但是你总是受限于内存堆的大小。当你的Node.js应用程序需要处理更多的请求时，你有两个选择：就是规模垂直或水平扩展。水平扩展意味着你必须运行多个并发的应用程序实例。如果做得对，你最终能够服务更多的请求。垂直扩展意味着你要为你的应用实例提高应用程序的内存使用情况和可用的性能或增加资源。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg" alt="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg"></p>
<p>最近有为我的Toptal（一个开放外包的平台）客户修复一个运行在Node.js上应用程序的内存泄漏问题。该应用程序是一个能够在每一分钟处理成千上万请求的API服务器。最初的应用几乎占据了600MB的RAM，所以我们决定采取热API端来重新实现它们。当你需要服务于许多请求开销变得非常昂贵。</p>
<p>对于新的API，我们选择的restify以及本地的MongoDB的驱动程序和Kue后台服务。听起来像是一个非常轻量级的栈，对不对？其实不然。在高峰负荷新的应用程序实例可以消耗高达270MB的RAM。因此起两个每1X的Heroku Dyno应用实的想法破灭了。</p>
<h2 id="Node-js_内存泄露调试军火库">Node.js 内存泄露调试军火库</h2>
<h3 id="Memwatch">Memwatch</h3>
<p>如果你搜索“如何在node里发现泄露”这个第一个你或许会搜到的工具就是memwatch。原始的包很久以前就被遗弃，不再保留。但是你可以很容易地找到在GitHub上的fork的库的更新版本。该模块是有用的，如果它看到堆增长超过5个连续的垃圾收集，它可以触发泄漏事件。</p>
<h3 id="Heapdump">Heapdump</h3>
<p>伟大的工具，它允许开发人员使用Chrome开发人员工具对Node.js采取堆快照后对其进行检查。</p>
<h3 id="Node-inspector">Node-inspector</h3>
<p>即使是被更为有用的heapdump替代，但它任然可以让你连接到运行的应用程序，采取堆转储，甚至调试，并重新编译在程序运行中。</p>
<h2 id="针对“node-inspector”_的说明">针对“node-inspector” 的说明</h2>
<p>不幸的是，将不能连接到被在Heroku运行生产的应用中，因为不允许信号被发送到运行的进程。然而，Heroku的是不是唯一的托管平台。</p>
<p>为了在实战中体验node-inspector，我们将使用的RESTify编写一个简单的Node.一点点内存泄漏的根源放在js应用程序中。这里所有的实验都是用Node.js v0.12.7和已编译的V8 v3.28.71.19。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = restify.createServer();</div><div class="line"></div><div class="line"><span class="keyword">var</span> tasks = [];</div><div class="line"></div><div class="line">server.pre(<span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  tasks.push(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> req.headers;</div><div class="line">  });</div><div class="line"></div><div class="line">  <span class="comment">// Synchronously get user from session, maybe jwt token</span></div><div class="line">  req.user = {</div><div class="line">    id: <span class="number">1</span>,</div><div class="line">    username: <span class="string">'Leaky Master'</span>,</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  res.send(<span class="string">'Hi '</span> + req.user.username);</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'%s listening at %s'</span>, server.name, server.url);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这个应用有个很简单且明显的内存泄漏。这个tasks的数组在应用的生命周期内引发变慢，并最终导致崩溃。这个问题是，不仅仅是闭包泄漏，而是波及了整个请求对象。</p>
<p>在V8里使用了stop-the-world这种GC策略，因此，这意味着越多的对象在内存中驻留，回收的时间就越长。在下面的日志你可以清楚地看到，在应用程序的生命的开始，平均回收内存是20毫秒，但几十万的请求后，则需要大约230ms。如果这时访问我们的应用程序将不得不等待230ms之久，因为正在GC。你也可以看到每隔几秒钟调用GC，这意味着每隔几秒钟，用户访问我们的应用程序会遇到问题。随着延迟时间增长，直到程序崩溃。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[<span class="number">28093</span>]     <span class="number">7644</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">25.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7717</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7866</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">23.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">8001</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.4</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">633891</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.3</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">635672</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">331.5</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">637508</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div></pre></td></tr></table></figure>

<p>当在启动一个Node.js的应用时加上–trace_gc这个标示，就可以逐行打印这些日志。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">node</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">trace_gc</span> <span class="comment">app</span><span class="string">.</span><span class="comment">js</span></div></pre></td></tr></table></figure>

<p>Let us assume that we have already started our Node.js application with this flag. Before connecting the application with node-inspector, we need to send it the SIGUSR1 signal to the running process. If you run Node.js in cluster, make sure you connect to one of the slave processes.<br>假设我们已经在这个Node.js的应用设置标示。在连接node-inspector到应用程序之前，我们需要把SIGUSR1信号发送到正在运行的进程。如果在群集中运行Node.js，请确保您连接到其中一个从属进程。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kill</span> -SIGUSR1 <span class="variable">$pid</span> <span class="comment"># Replace $pid with the actual process ID</span></div></pre></td></tr></table></figure>

<p>通过这样做，我们正在让Node.js的应用（准确地说是V8）进入调试模式。在这种模式下，应用自动将打开的端口5858<a href="https://code.google.com/p/v8-wiki/wiki/DebuggerProtocol" target="_blank" rel="external">V8调试协议</a>。</p>
<p>我们下一步运行node-inspector连接到运行应用的调试接口，并打开8080端口的web接口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>node-inspector</div><div class="line"><span class="constant">Node</span> <span class="constant">Inspector</span> v<span class="number">0</span>.<span class="number">12.2</span></div><div class="line"><span class="constant">Visit</span> <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:8080/</span>?ws=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8080</span>&port=<span class="number">5858</span> to start debugging.</div></pre></td></tr></table></figure>

<p>如果应用程序在生产中运行，并且有一个防火墙，我们可以通过隧道远程端口8080到本地主机：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">ssh</span> <span class="tag">-L</span> 8080<span class="pseudo">:localhost</span><span class="pseudo">:8080</span> <span class="tag">admin</span><span class="at_rule">@<span class="keyword">example.com</span></span></div></pre></td></tr></table></figure>

<p>现在，你可以打开你的Chrome网络浏览器即可获得完全的访问连接到远程生产应用程序的Chrome开发工具。不幸的是，Chrome开发人员工具将不能在其他浏览器。</p>
<h2 id="让我们发现泄漏">让我们发现泄漏</h2>
<p>在V8内存泄漏是不是真正的内存泄漏就像我们从C / C++应用程序的理解的那样。在JavaScript变量为空值时并不消失，他们只是“被遗忘”。我们的目标是要找到这些被遗忘的变量，并使这些内存释放。</p>
<p>在Chrome开发工具里我们有多个profiler。我们在记录堆分配而运行，并随着时间的推移需要多堆快照特别感兴趣。这给了我们一个明确的窥视到哪些对象正在泄漏。</p>
<p>开始录制堆分配，让我们模拟使用Apache基准在我们的主页上50个并发用户。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg" alt="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ab -<span class="built_in">c</span> <span class="number">50</span> -n <span class="number">1000000</span> -k http:<span class="comment">//example.com/</span></div></pre></td></tr></table></figure>

<p>在建立新的快照之前，V8将执行标记 - 清除垃圾收集，所以我们肯定知道有没有旧垃圾中的快照。</p>
<h2 id="修复运行中的泄漏">修复运行中的泄漏</h2>
<p>在收集堆分配快照3分钟后，我们得到类似下面的结果</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg" alt="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg"></p>
<p>我们可以清楚地看到，在堆里面有一些巨大的数组，很多IncomingMessage，ReadableState，ServerResponse和域对象。让我们分析下泄漏源。</p>
<p>在从20秒到40秒选择堆差异的图表中，我们只看到它是20秒后开始查看对象。这样，您就可以排除出所有正常的数据。</p>
<p>保持关注每种类型的对象在系统中的数目，我们扩大过滤从20多岁到1分钟。我们可以看到数组已经相当大了，并持续增长。在“（array）”，我们可以看到有很多的对象“（object properties）”具有同等的距离。这些对象是我们的内存泄漏的源头。</p>
<p>此外，我们也可以看到，“（closure）”的对象快速增长。</p>
<p>It might be handy to look at the strings as well. Under the strings list there are a lot of “Hi Leaky Master” phrases. Those might give us some clue too.</p>
<p>In our case we know that the string ”Hi Leaky Master” could only be assembled under the “GET /” route.</p>
<p>If you open retainers path you will see this string is somehow referenced via req, then there is context created and all this added to some giant array of closures.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg" alt="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg"></p>
<p>So at this point we know that we have some kind of gigantic array of closures. Let’s actually go and give a name to all our closures at real-time under sources tab.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg" alt="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg"></p>
<p>After we are done editing the code, we can hit CTRL+S to save and recompile code on the fly!</p>
<p>Now let’s record another Heap Allocations Snapshot and see which closures are occupying the memory.</p>
<p>It’s clear that SomeKindOfClojure() is our villain. Now we can see that SomeKindOfClojure() closures are being added to some array named tasks in the global space.</p>
<p>It’s easy to see that this array is just useless. We can comment it out. But how do we free memory the memory already occupied? Very easy, we just assign an empty array to tasks and with the next request it will be overridden and memory will be freed after next GC event.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg" alt="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg"></p>
<p>Dobby is free!</p>
<h2 id="Life_of_Garbage_in_V8">Life of Garbage in V8</h2>
<p><img src="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg" alt="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg"></p>
<p>Well, V8 JS does not have memory leaks, only forgotten variables.</p>
<p>V8 heap is divided into several different spaces:</p>
<p>New Space: This space is relatively small and has a size of between 1MB and 8MB. Most of the objects are allocated here.</p>
<ul>
<li>Old Pointer Space: Has objects which may have pointers to other objects. If object survives long enough in New Space it gets promoted to Old Pointer Space.</li>
<li>Old Data Space: Contains only raw data like strings, boxed numbers and arrays of unboxed doubles. Objects that have survived GC in the New Space for long enough are moved here as well.</li>
<li>Large Object Space: Objects which are too big to fit in other spaces are created in this space. Each object has it’s own mmap‘ed region in memory</li>
<li>Code space: Contains assembly code generated by the JIT compiler.</li>
<li>Cell space, property cell space, map space: This space contains Cells, PropertyCells, and Maps. This is used to simplify garbage collection.</li>
</ul>
<p>Each space is composed of pages. A page is a region of memory allocated from the operating system with mmap. Each page is always 1MB in size except for pages in large object space.</p>
<p>V8 has two built in garbage collection mechanisms: Scavenge, Mark-Sweep and Mark-Compact.</p>
<p>Scavenge is a very fast garbage collection technique and operates with objects in New Space. Scavenge is the implementation of <a href="http://en.wikipedia.org/wiki/Cheney&#39;s_algorithm" target="_blank" rel="external">Cheney’s Algorithm</a>. The idea is very simple, New Space is divided in two equal semi-spaces: To-Space and From-Space. Scavenge GC occurs when To-Space is full. It simply swaps To and From spaces and copy all live objects to To-Space or promote them to one of the old spaces if they survived two scavenges, and is then entirely erased from the space. Scavenges are very fast however they have the overhead of keeping double sized heap and constantly copying objects in memory. The reason to use scavenges is because most objects die young.</p>
<p>Mark-Sweep &amp; Mark-Compact is another type of garbage collector used in V8. The other name is full garbage collector. It marks all live nodes, then sweeps all dead nodes and defragments memory.</p>
<h3 id="GC_Performance_and_Debugging_Tips">GC Performance and Debugging Tips</h3>
<p>While for web applications high performance might not be such a big problem, you will still want to avoid leaks at all costs. During the mark phase in full GC the application is actually paused until garbage collection is completed. This means the more objects you have in the heap, the longer it will take to perform GC and the longer users will have to wait.</p>
<h3 id="Always_give_names_to_closures_and_functions">Always give names to closures and functions</h3>
<p>It’s much easier to inspect stack traces and heaps when all your closures and functions have names.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">db.query(<span class="string">'GIVE THEM ALL'</span>, <span class="function"><span class="keyword">function</span> <span class="title">GiveThemAllAName</span><span class="params">(error, data)</span> </span>{</div><div class="line">    ...</div><div class="line">})</div></pre></td></tr></table></figure>

<h3 id="Avoid_large_objects_in_hot_functions">Avoid large objects in hot functions</h3>
<p>Ideally you want to avoid large objects inside of hot functions so that all data is fit into New Space. All CPU and memory bound operations should be executed in background. Also avoid deoptimization triggers for hot functions, optimized hot function uses less memory than non-optimized ones.</p>
<h3 id="Hot_functions_should_be_optimized">Hot functions should be optimized</h3>
<p>Hot functions that run faster but also consume less memory cause GC to run less often. V8 provides some helpful debugging tools to spot non-optimized functions or deoptimized functions.</p>
<p>Avoid polymorphism for IC’s in hot functions</p>
<p>Inline Caches (IC) are used to speed up execution of some chunks of code, either by caching object property access obj.key or some simple function.</p>
<figure class="highlight javscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">(a, b)</span> <span class="comment">{</span></span></div><div class="line">  return a + b;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="title">x</span><span class="params">(1, 2)</span>; <span class="comment">// monomorphic</span></div><div class="line">x(<span class="number">1</span>, “<span class="keyword">string</span>”); <span class="comment">// polymorphic, level 2</span></div><div class="line">x(<span class="number">3.14</span>, <span class="number">1</span>); <span class="comment">// polymorphic, level 3</span></div></pre></td></tr></table></figure>

<p>When <code>x(a,b)</code> is run for the first time, V8 creates a monomorphic IC. When you call x a second time, V8 erases the old IC and creates a new polymorphic IC which supports both types of operands integer and string. When you call IC the third time, V8 repeats the same procedure and creates another polymorphic IC of level 3.</p>
<p>However, there is a limitation. After IC level reaches 5 (could be changed with <code>–max_inlining_levels</code> flag) the function becomes megamorphic and is no longer considered optimizable.</p>
<p>It’s intuitively understandable that monomorphic functions run the fastest and also have a smaller memory footprint.</p>
<h3 id="Don’t_add_large_files_to_memory">Don’t add large files to memory</h3>
<p>This one is obvious and well known. If you have large files to process, for example a large CSV file, read it line-by-line and process in little chunks instead of loading the entire file to memory. There are rather rare cases where a single line of csv would be larger than 1mb, thus allowing you to fit it in New Space.</p>
<h3 id="Do_not_block_main_server_thread">Do not block main server thread</h3>
<p>If you have some hot API which takes some time to process, such as an API to resize images, move it to a separate thread or turn it into a background job. CPU intensive operations would block main thread forcing all other customers to wait and keep sending requests. Unprocessed request data would stack in memory, thus forcing full GC to take longer time to finish.</p>
<h3 id="Do_not_create_unnecessary_data">Do not create unnecessary data</h3>
<p>I once had a weird experience with restify. If you send a few hundred thousand requests to an invalid URL then the application memory would rapidly grow on up to hundred megabytes until a full GC kicks in a few seconds later, which is when everything would go back to normal. Turns out that for each invalid URL, restify generates a new error object which includes long stack traces. This forced newly created objects to be allocated in Large Object Space rather than in New Space.</p>
<p>Having access to such data could be very helpful during development, but obviously not required on production. Therefore the rule is simple - do not generate data unless you certainly need it.</p>
<h3 id="Know_your_tools">Know your tools</h3>
<p>Last, but certainly not the least, is to know your tools. There are various debuggers, leak cathers, and usage graphs generators. All those tools can help you make your software faster and more efficient.</p>
<h3 id="Conclusion">Conclusion</h3>
<p>Understanding how V8’s garbage collection and code optimizer works is a key to application performance. V8 compiles JavaScript to native assembly and in some cases well written code could achieve performance comparable with GCC compiled applications.</p>
<p>And in case you are wondering, the new API application for my Toptal client, although there is room for improvement, is working very well!</p>
<p>Joyent recently released a new version of Node.js which uses one of the latest versions of V8. Some applications written for Node.js v0.12.x may not be compatible with the new v4.x release. However, applications will experience tremendous performance and memory usage improvement within the new version of Node.js.</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/10/10/debugging-memory-leaks-node-js-applications/"></a></h1>
  

      
      <time datetime="2015-10-10T00:41:46.000Z">Oct 10 2015</time>
      
    </header>
    <div class="entry">
      
        <!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAzUABAAAAAAFNgAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABbAAAABwAAAAcZMzaOEdERUYAAAGIAAAAHQAAACAAOQAET1MvMgAAAagAAAA+AAAAYHqhde9jbWFwAAAB6AAAAFIAAAFa4azkLWN2dCAAAAI8AAAAKAAAACgFgwioZnBnbQAAAmQAAAGxAAACZVO0L6dnYXNwAAAEGAAAAAgAAAAIAAAAEGdseWYAAAQgAAAFDgAACMz7eroHaGVhZAAACTAAAAAwAAAANgWEOEloaGVhAAAJYAAAAB0AAAAkDGEGa2htdHgAAAmAAAAAEwAAADBEgAAQbG9jYQAACZQAAAAaAAAAGgsICJBtYXhwAAAJsAAAACAAAAAgASgBD25hbWUAAAnQAAACZwAABOD4no+3cG9zdAAADDgAAABsAAAAmF+yXM9wcmVwAAAMpAAAAC4AAAAusPIrFAAAAAEAAAAAyYlvMQAAAADLVHQgAAAAAM/u9uZ4nGNgZGBg4ANiCQYQYGJgBEJuIGYB8xgABMMAPgAAAHicY2Bm42OcwMDKwMLSw2LMwMDQBqGZihmiwHycoKCyqJjB4YPDh4NsDP+BfNb3DIuAFCOSEgUGRgAKDgt4AAB4nGNgYGBmgGAZBkYGEAgB8hjBfBYGCyDNxcDBwMTA9MHhQ9SHrA8H//9nYACyQyFs/sP86/kX8HtB9UIBIxsDXICRCUgwMaACRoZhDwA3fxKSAAAAAAHyAHABJQB/AIEAdAFGAOsBIwC/ALgAxACGAGYAugBNACcA/wCIeJxdUbtOW0EQ3Q0PA4HE2CA52hSzmZDGe6EFCcTVjWJkO4XlCGk3cpGLcQEfQIFEDdqvGaChpEibBiEXSHxCPiESM2uIojQ7O7NzzpkzS8qRqnfpa89T5ySQwt0GzTb9Tki1swD3pOvrjYy0gwdabGb0ynX7/gsGm9GUO2oA5T1vKQ8ZTTuBWrSn/tH8Cob7/B/zOxi0NNP01DoJ6SEE5ptxS4PvGc26yw/6gtXhYjAwpJim4i4/plL+tzTnasuwtZHRvIMzEfnJNEBTa20Emv7UIdXzcRRLkMumsTaYmLL+JBPBhcl0VVO1zPjawV2ys+hggyrNgQfYw1Z5DB4ODyYU0rckyiwNEfZiq8QIEZMcCjnl3Mn+pED5SBLGvElKO+OGtQbGkdfAoDZPs/88m01tbx3C+FkcwXe/GUs6+MiG2hgRYjtiKYAJREJGVfmGGs+9LAbkUvvPQJSA5fGPf50ItO7YRDyXtXUOMVYIen7b3PLLirtWuc6LQndvqmqo0inN+17OvscDnh4Lw0FjwZvP+/5Kgfo8LK40aA4EQ3o3ev+iteqIq7wXPrIn07+xWgAAAAABAAH//wAPeJyFlctvG1UUh+/12DPN1B7P3JnYjj2Ox4/MuDHxJH5N3UdaEUQLqBIkfQQioJWQ6AMEQkIqsPGCPwA1otuWSmTBhjtps2ADWbJg3EpIXbGouqSbCraJw7kzNo2dRN1cnXN1ZvT7zuuiMEI7ncizyA0URofRBJpCdbQuIFShYY+GZRrxMDVtih5TwQPHtXDFFSIKoWIbuREBjLH27Ny4MsbVx+uOJThavebgVrNRLAiYx06rXsvhxLgWx9xpfHdrs/ekc2Pl2cpPCVEITQpwbj8VQhfXSq2m+Wxqaq2D73Kne5e3NjHqQNj3CRYlJlgUl/jRNP+2Gs2pNYRQiOnmUaQDqm30KqKiTTWPWjboxnTWpvgxjXo0KrtZXAHt7hwIz0YVcj88JnKlJKi3NPAwLyDwZudSmJSMMJFDYaOkaol6XtESx3Gt1VTytdZJ3DCLeaVhVnCBH1fycHTxFXwPX+l2e3d6H/TufGGmMTLTnbSJUdo00zuBswMO/nl3YLeL/wnu9/limCuD3vC54h5NBVz6Li414AI8Vx3iiosKcQXUbrvhFFiYb++HN4DaF4XzFW0fIN4XDWJ3a3XQoq9V8WiyRmdsatV9xUcHims1JloH0YUa090G3Tro3mC6c01f+YwCPquINr1PTaCP6rVTOOmf0GE2dBc7zWIhji3/5MchSuBHgDbU99RMWt3YUNMZMJmx92YP6NsHx/5/M1yvInpnkIOM3Z8fA3JQ2lW1RFC1KaBPDFXNAHYYvGy73aYZZZ3HifbeuiVZCpwA3oQBs0wGPYJbJfg60xrKEbKiNtTe1adwrpBRwlAuQ3q3VRaX0QmQ9a49BTSCuF1MLfQ6+tinOubRBZuWPNoMevGMT+V41KitO1is3D/tpMcq1JHZqDHGs8DoYGDkxJgKjHROeTCmhZvzPm9pod+ltKm4PN7Dyvvldlpsg8D+4AUJZ3F/JBstZz7cbFRxsaAGV6yX/dkcycWf8eS3QlQea+YLjdm3yrOnrhFpUyKVvFE4lpv4bO3Svx/6F/4xmiDu/RT5iI++lko18mY1oX+5UGKR6kmVjM/Zb76yfHtxy+h/SyQ0lLdpdKy/lWB6szatetQJ8nZ80A2Qt6ift6gJeavU3BO4gtxs/KCtNPVibCtYCWY3SIlSBPKXZALXiIR9oZeJ1AuMyxLpHIy/yO7vSiSE+kZvk0ihJ30HgHfzZtEMmvV58x6dtqns0XTAW7Vdm4HJ04OCp/crOO7rd9SGxQAE/mVA9xRN+kVSMRFF6S9JFGUtthkjBA5tFCWc2l4V43Ex9GmUP3SI37Jjmir9KqlaDJ4S4JB3vuM/jzyH1+8MuoZ+QGzfnvPoJb96cZlWjMcKLfgDwB7E634JTY+asjsPzS5CiVnEWY+KsrsIN5rn3mAPjqmQBxGjcGKB9f9ZxY3mYC2L85CJ2FXIxKKyHk+dg0FHbuEc7D5NzWUX32WxFcWNGRAbvwSx0RmIXVDuYySafluQBmzA/ssqJAMLnli+WIC90Gw4lm85wcp0qjArEDPJJV/sSx4P9ungTpgMw5gVC1XO4uULq0s3v1rqLi0vX/z65vlH50f8T/RHmSPTk5xxWBWOluMT6WiOy+tdvWxlV/XQb3o3c6Ssr+r6I708GsX9/nzp1tKFh0s3v7m4vAy/Hnb/KMOvc1wump6Il48K6mGDy02X9Yd65pa+nQIjk76lWxCkG8NBCP0HQS9IpAAAeJxjYGRgYGBhcCrq214Qz2/zlUGenQEEzr/77oug/zewFbB+AHI5GJhAogBwKQ0qeJxjYGRgYH3/P46BgZ0BBNgKGBgZUAEPAE/7At0AAAB4nGNngAB2IGYjhBsYBAAIYADVAAAAAAAAAAAAAFwAyAEeAaACCgKmAx4DggRmAAAAAQAAAAwAagAEAAAAAAACAAEAAgAWAAABAAChAAAAAHiclZI7bxQxFIWPd/JkUYQChEhIyAVKgdBMskm1QkKrRETpQiLRUczueB/K7HhlOxttg8LvoKPgP9DxFxANDR0tHRWi4NjrPIBEgh1p/dm+vufcawNYFWsQmP6e4jSyQB2fI9cwj++RE9wTjyPP4LYoI89iWbyLPIe6+Bh5Hs9rryMv4GbtW+RF3EhuRa7jbrIbeQkPkjdUETOLnL0Kip4FVvAhco1RXyMnSPEz8gzWxE7kWTwUp5HnsCLeR57HW/El8gJWa58iL+JO7UfkOh4l9yMv4UnyEtvQGGECgwF66MNBooF1bGCL1ELB/TYU+ZBRlvsKQ44Se6jQ4a7hef+fh72Crv25kp+8lNWGmeKoOI5jJLb1aGIGvb6TjfWNLdkqdFvJw4l1amjlXtXRZqRN7lSRylZZyhBqpVFWmTEXgWfUrpi/hZOQXdOd4rKuXOtEWT3k5IArPRzTUU5tHKjecZkTpnVbNOnt6jzN8240GD4xtikvZW56043rPMg/dS+dlOceXoR+WPbJ55Dsekq1lJpnypsMUsYOdCW30o103Ytu/lvh+5RWFLfBjm9/N8hJntPhvx92rnoE/kyHdGasGy754kw36vsVf/lFeBi+0COu+cfgQr42G3CRpeLoZ53gmfe3X6rcKt5oVxnptHR9JS8ehVUd5wvvahN2uqxOOpMXapibI5k7Zwbt4xBSaTfoKBufhAnO/uqNcfK8OTs0OQ6l7JIqFjDhYj5WcjevCnI/1DDiI8j4ndWb/5YzDZWh79yomWXeXj7Nnw70/2TIeFPTrlSh89k1ObOSRVZWZfgF0r/zJQB4nG2JUQuCQBCEd07TTg36fb2IyBaLd3vWaUh/vmSJnvpgmG8YcmS8X3Shf3R7QA4OBUocUKHGER5NNbOOEvwc1txnuWkTRb/aPjimJ5vXabI+3VfOiyS15UWvyezM2xiGOPyuMohOH8O8JiO4Af+FsAGNAEuwCFBYsQEBjlmxRgYrWCGwEFlLsBRSWCGwgFkdsAYrXFhZsBQrAAA=) format('woff');
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAYcAA0AAAAACjQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABMAAAABwAAAAca8vGTk9TLzIAAAFMAAAARAAAAFZG1VHVY21hcAAAAZAAAAA+AAABQgAP9AdjdnQgAAAB0AAAAAQAAAAEACICiGdhc3AAAAHUAAAACAAAAAj//wADZ2x5ZgAAAdwAAADRAAABEKyikaNoZWFkAAACsAAAAC0AAAA2AtXoA2hoZWEAAALgAAAAHAAAACQHngNFaG10eAAAAvwAAAAQAAAAEAwAACJsb2NhAAADDAAAAAoAAAAKALIAVG1heHAAAAMYAAAAHwAAACABEAB2bmFtZQAAAzgAAALBAAAFu3I9x/Nwb3N0AAAF/AAAAB0AAAAvaoFvbwAAAAEAAAAAzBdyYwAAAADP2IQvAAAAAM/bz7t4nGNgZGFgnMDAysDB1Ml0hoGBoR9CM75mMGLkYGBgYmBlZsAKAtJcUxgcPsR8iGF2+O/AEMPsznAYKMwIkgMA5REMOXicY2BgYGaAYBkGRgYQsAHyGMF8FgYFIM0ChED+h5j//yEk/3KoSgZGNgYYk4GRCUgwMaACRoZhDwCs7QgGAAAAIgKIAAAAAf//AAJ4nHWMMQrCQBBF/0zWrCCIKUQsTDCL2EXMohYGSSmorScInsRGL2DOYJe0Ntp7BK+gJ1BxF1stZvjz/v8DRghQzEc4kIgKwiAppcA9LtzKLSkdNhKFY3HF4lK69ExKslx7Xa+vPRVS43G98vG1DnkDMIBUgFN0MDXflU8tbaZOUkXUH0+U27RoRpOIyCKjbMCVejwypzJJG4jIwb43rfl6wbwanocrJm9XFYfskuVC5K/TPyczNU7b84CXcbxks1Un6H6tLH9vf2LRnn8Ax7A5WQAAAHicY2BkYGAA4teL1+yI57f5ysDNwgAC529f0kOmWRiYVgEpDgYmEA8AUzEKsQAAAHicY2BkYGB2+O/AEMPCAAJAkpEBFbAAADgKAe0EAAAiAAAAAAQAAAAEAAAAAAAAKgAqACoAiAAAeJxjYGRgYGBhsGFgYgABEMkFhAwM/xn0QAIAD6YBhwB4nI1Ty07cMBS9QwKlQapQW3VXySvEqDCZGbGaHULiIQ1FKgjWMxknMfLEke2A+IJu+wntrt/QbVf9gG75jK577Lg8K1qQPCfnnnt8fX1NRC/pmjrk/zprC+8D7tBy9DHgBXoWfQ44Av8t4Bj4Z8CLtBL9CniJluPXASf0Lm4CXqFX8Q84dOLnMB17N4c7tBo1AS/Qi+hTwBH4rwHHwN8DXqQ30XXAS7QaLwSc0Gn8NuAVWou/gFmnjLrEaEh9GmDdDGgL3B4JsrRPDU2hTOiMSuJUIdKQQayiAth69r6akSSFqIJuA19TrzCIaY8sIoxyrNIrL//pw7A2iMygkX5vDj+G+kuoLdX4GlGK/8Lnlz6/h9MpmoO9rafrz7ILXEHHaAx95s9lsI7AHNMBWEZHULnfAXwG9/ZqdzLI08iuwRloXE8kfhXYAvE23+23DU3t626rbs8/8adv+9DWknsHp3E17oCf+Z48rvEQNZ78paYM38qfk3v/u3l3u3GXN2Dmvmvpf1Srwk3pB/VSsp512bA/GG5i2WJ7wu430yQ5K3nFGiOqgtmSB5pJVSizwaacmUZzZhXLlZTq8qGGFY2YcSkqbth6aW1tRmlaCFs2016m5qn36SbJrqosG4uMV4aP2PHBmB3tjtmgN2izkGQyLWprekbIntJFing32a5rKWCN/SdSoga45EJykyQ7asZvHQ8PTm6cslIpwyeyjbVltNikc2HTR7YKh9LBl9DADC0U/jLcBZDKrMhUBfQBvXRzLtFtjU9eNHKin0x5InTqb8lNpfKv1s1xHzTXRqgKzek/mb7nB8RZTCDhGEX3kK/8Q75AmUM/eLkfA+0Hi908Kx4eNsMgudg5GLdRD7a84npi+YxNr5i5KIbW5izXas7cHXIMAau1OueZhfj+cOcP3P8MNIWLyYOBuxL6DRylJ4cAAAB4nGNgYoAALjDJyIAOWMCiTIxMLDmZedkABtIBygAAAA==) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headeranchor-link {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .headeranchor-link:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .headeranchor,
.markdown-body h2 .headeranchor,
.markdown-body h3 .headeranchor,
.markdown-body h4 .headeranchor,
.markdown-body h5 .headeranchor,
.markdown-body h6 .headeranchor {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .headeranchor-link,
.markdown-body h2:hover .headeranchor-link,
.markdown-body h3:hover .headeranchor-link,
.markdown-body h4:hover .headeranchor-link,
.markdown-body h5:hover .headeranchor-link,
.markdown-body h6:hover .headeranchor-link {
  height: 1em;
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .headeranchor-link .headeranchor,
.markdown-body h2:hover .headeranchor-link .headeranchor,
.markdown-body h3:hover .headeranchor-link .headeranchor,
.markdown-body h4:hover .headeranchor-link .headeranchor,
.markdown-body h5:hover .headeranchor-link .headeranchor,
.markdown-body h6:hover .headeranchor-link .headeranchor {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* Multimarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\f05c';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><title>调试node.js应用的内存泄漏[译]</title></head><body><article class="markdown-body"><hr>
<p>原文：<a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external"><a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external"><a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external">http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications</a></a></a></p>
<p>有一次，我开着一辆内部是V8双涡轮增压发动机的奥迪，其性能令人难以置信。凌晨3点，我行驶在芝加哥附近没有人的IL-80高速公路，时速达到140MPH。从那时起，“V8”这个术语成为我对高性能的认识。</p>
<blockquote>
<p>Node.js是一个建立在Chrome的JavaScript引擎V8之上的易于快速构建可伸缩的网络应用的平台。</p>
</blockquote>
<p>尽管奥迪的V8非常强大，但仍然限于用你的油箱的容量大小。这同样适用于谷歌的V8引擎 - 在node.js背后的JavaScript引擎。有很多因素使Node.js的性能是难以置信的，<a href="http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js" target="_blank" rel="external">适用于许多应用案例</a>，但是你总是受限于内存堆的大小。当你的Node.js应用程序需要处理更多的请求时，你有两个选择：就是规模垂直或水平扩展。水平扩展意味着你必须运行多个并发的应用程序实例。如果做得对，你最终能够服务更多的请求。垂直扩展意味着你要为你的应用实例提高应用程序的内存使用情况和可用的性能或增加资源。</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg" src="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg"></p>
<p>最近有为我的Toptal（一个开放外包的平台）客户修复一个运行在Node.js上应用程序的内存泄漏问题。该应用程序是一个能够在每一分钟处理成千上万请求的API服务器。最初的应用几乎占据了600MB的RAM，所以我们决定采取热API端来重新实现它们。当你需要服务于许多请求开销变得非常昂贵。</p>
<p>对于新的API，我们选择的restify以及本地的MongoDB的驱动程序和Kue后台服务。听起来像是一个非常轻量级的栈，对不对？其实不然。在高峰负荷新的应用程序实例可以消耗高达270MB的RAM。因此起两个每1X的Heroku Dyno应用实的想法破灭了。</p>
<h2 id="nodejs"><a name="user-content-nodejs" href="#nodejs" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Node.js 内存泄露调试军火库</h2>
<h3 id="memwatch"><a name="user-content-memwatch" href="#memwatch" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Memwatch</h3>
<p>如果你搜索“如何在node里发现泄露”这个第一个你或许会搜到的工具就是memwatch。原始的包很久以前就被遗弃，不再保留。但是你可以很容易地找到在GitHub上的fork的库的更新版本。该模块是有用的，如果它看到堆增长超过5个连续的垃圾收集，它可以触发泄漏事件。</p>
<h3 id="heapdump"><a name="user-content-heapdump" href="#heapdump" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Heapdump</h3>
<p>伟大的工具，它允许开发人员使用Chrome开发人员工具对Node.js采取堆快照后对其进行检查。</p>
<h3 id="node-inspector"><a name="user-content-node-inspector" href="#node-inspector" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Node-inspector</h3>
<p>即使是被更为有用的heapdump替代，但它任然可以让你连接到运行的应用程序，采取堆转储，甚至调试，并重新编译在程序运行中。</p>
<h2 id="node-inspector_1"><a name="user-content-node-inspector_1" href="#node-inspector_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>针对“node-inspector” 的说明</h2>
<p>不幸的是，将不能连接到被在Heroku运行生产的应用中，因为不允许信号被发送到运行的进程。然而，Heroku的是不是唯一的托管平台。</p>
<p>为了在实战中体验node-inspector，我们将使用的RESTify编写一个简单的Node.一点点内存泄漏的根源放在js应用程序中。这里所有的实验都是用Node.js v0.12.7和已编译的V8 v3.28.71.19。</p>
<pre><code class="javascript">var restify = require('restify');

var server = restify.createServer();

var tasks = [];

server.pre(function(req, res, next) {
  tasks.push(function() {
    return req.headers;
  });

  // Synchronously get user from session, maybe jwt token
  req.user = {
    id: 1,
    username: 'Leaky Master',
  };

  return next();
});

server.get('/', function(req, res, next) {
  res.send('Hi ' + req.user.username);
  return next();
});

server.listen(3000, function() {
  console.log('%s listening at %s', server.name, server.url);
});

</code></pre>

<p>这个应用有个很简单且明显的内存泄漏。这个tasks的数组在应用的生命周期内引发变慢，并最终导致崩溃。这个问题是，不仅仅是闭包泄漏，而是波及了整个请求对象。</p>
<p>在V8里使用了stop-the-world这种GC策略，因此，这意味着越多的对象在内存中驻留，回收的时间就越长。在下面的日志你可以清楚地看到，在应用程序的生命的开始，平均回收内存是20毫秒，但几十万的请求后，则需要大约230ms。如果这时访问我们的应用程序将不得不等待230ms之久，因为正在GC。你也可以看到每隔几秒钟调用GC，这意味着每隔几秒钟，用户访问我们的应用程序会遇到问题。随着延迟时间增长，直到程序崩溃。<br>
<pre><code>[28093]     7644 ms: Mark-sweep 10.9 (48.5) -&gt; 10.9 (48.5) MB, 25.0 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     7717 ms: Mark-sweep 10.9 (48.5) -&gt; 10.9 (48.5) MB, 18.0 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     7866 ms: Mark-sweep 11.0 (48.5) -&gt; 10.9 (48.5) MB, 23.2 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     8001 ms: Mark-sweep 11.0 (48.5) -&gt; 10.9 (48.5) MB, 18.4 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

...

[28093]   633891 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 357.3 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]   635672 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 331.5 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]   637508 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 357.2 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

</code></pre></p>
<p>当在启动一个Node.js的应用时加上–trace_gc这个标示，就可以逐行打印这些日志。</p>
<pre><code>node --trace_gc app.js
</code></pre>

<p>Let us assume that we have already started our Node.js application with this flag. Before connecting the application with node-inspector, we need to send it the SIGUSR1 signal to the running process. If you run Node.js in cluster, make sure you connect to one of the slave processes.<br>
假设我们已经在这个Node.js的应用设置标示。在连接node-inspector到应用程序之前，我们需要把SIGUSR1信号发送到正在运行的进程。如果在群集中运行Node.js，请确保您连接到其中一个从属进程。</p>
<pre><code>kill -SIGUSR1 $pid # Replace $pid with the actual process ID
</code></pre>

<p>通过这样做，我们正在让Node.js的应用（准确地说是V8）进入调试模式。在这种模式下，应用自动将打开的端口5858<a href="https://code.google.com/p/v8-wiki/wiki/DebuggerProtocol" target="_blank" rel="external">V8调试协议</a>。</p>
<p>我们下一步运行node-inspector连接到运行应用的调试接口，并打开8080端口的web接口</p>
<pre><code>$ node-inspector
Node Inspector v0.12.2
Visit http://127.0.0.1:8080/?ws=127.0.0.1:8080&amp;port=5858 to start debugging.
</code></pre>

<p>如果应用程序在生产中运行，并且有一个防火墙，我们可以通过隧道远程端口8080到本地主机：</p>
<p><pre><code>ssh -L 8080:localhost:8080 admin@example.com
</code></pre><br>
现在，你可以打开你的Chrome网络浏览器即可获得完全的访问连接到远程生产应用程序的Chrome开发工具。不幸的是，Chrome开发人员工具将不能在其他浏览器。</p>
<h2 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>让我们发现泄漏</h2>
<p>在V8内存泄漏是不是真正的内存泄漏就像我们从C / C++应用程序的理解的那样。在JavaScript变量为空值时并不消失，他们只是“被遗忘”。我们的目标是要找到这些被遗忘的变量，并使这些内存释放。</p>
<p>在Chrome开发工具里我们有多个profiler。我们在记录堆分配而运行，并随着时间的推移需要多堆快照特别感兴趣。这给了我们一个明确的窥视到哪些对象正在泄漏。</p>
<p>开始录制堆分配，让我们模拟使用Apache基准在我们的主页上50个并发用户。</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg" src="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg"></p>
<pre><code>ab -c 50 -n 1000000 -k http://example.com/
</code></pre>

<p>Before taking new snapshots, V8 would perform mark-sweep garbage collection, so we definitely know that there is no old garbage in the snapshot.</p>
<h2 id="fixing-the-leak-on-the-fly"><a name="user-content-fixing-the-leak-on-the-fly" href="#fixing-the-leak-on-the-fly" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Fixing the Leak on the Fly</h2>
<p>After collecting heap allocation snapshots over a period of 3 minutes we end up with something like the following:</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg" src="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg"></p>
<p>We can clearly see that there are some gigantic arrays, a lot of IncomingMessage, ReadableState, ServerResponse and Domain objects as well in heap. Let’s try to analyze the source of the leak.</p>
<p>Upon selecting heap diff on chart from 20s to 40s, we will only see objects which were added after 20s from when you started the profiler. This way you could exclude all normal data.</p>
<p>Keeping note of how many objects of each type are in the system, we expand the filter from 20s to 1min. We can see that the arrays, already quite gigantic, keeps growing. Under “(array)” we can see that there are a lot of objects “(object properties)” with equal distance. Those objects are the source of our memory leak.</p>
<p>Also we can see that “(closure)” objects grow rapidly as well.</p>
<p>It might be handy to look at the strings as well. Under the strings list there are a lot of “Hi Leaky Master” phrases. Those might give us some clue too.</p>
<p>In our case we know that the string ”Hi Leaky Master” could only be assembled under the “GET /” route.</p>
<p>If you open retainers path you will see this string is somehow referenced via req, then there is context created and all this added to some giant array of closures.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg" src="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg"></p>
<p>So at this point we know that we have some kind of gigantic array of closures. Let’s actually go and give a name to all our closures at real-time under sources tab.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg" src="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg"></p>
<p>After we are done editing the code, we can hit CTRL+S to save and recompile code on the fly!</p>
<p>Now let’s record another Heap Allocations Snapshot and see which closures are occupying the memory.</p>
<p>It’s clear that SomeKindOfClojure() is our villain. Now we can see that SomeKindOfClojure() closures are being added to some array named tasks in the global space.</p>
<p>It’s easy to see that this array is just useless. We can comment it out. But how do we free memory the memory already occupied? Very easy, we just assign an empty array to tasks and with the next request it will be overridden and memory will be freed after next GC event.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg" src="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg"></p>
<p>Dobby is free!</p>
<h2 id="life-of-garbage-in-v8"><a name="user-content-life-of-garbage-in-v8" href="#life-of-garbage-in-v8" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Life of Garbage in V8</h2>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg" src="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg"></p>
<p>Well, V8 JS does not have memory leaks, only forgotten variables.</p>
<p>V8 heap is divided into several different spaces:</p>
<p>New Space: This space is relatively small and has a size of between 1MB and 8MB. Most of the objects are allocated here.</p>
<ul>
<li>Old Pointer Space: Has objects which may have pointers to other objects. If object survives long enough in New Space it gets promoted to Old Pointer Space.</li>
<li>Old Data Space: Contains only raw data like strings, boxed numbers and arrays of unboxed doubles. Objects that have survived GC in the New Space for long enough are moved here as well.</li>
<li>Large Object Space: Objects which are too big to fit in other spaces are created in this space. Each object has it’s own mmap‘ed region in memory</li>
<li>Code space: Contains assembly code generated by the JIT compiler.</li>
<li>Cell space, property cell space, map space: This space contains Cells, PropertyCells, and Maps. This is used to simplify garbage collection.</li>
</ul>
<p>Each space is composed of pages. A page is a region of memory allocated from the operating system with mmap. Each page is always 1MB in size except for pages in large object space.</p>
<p>V8 has two built in garbage collection mechanisms: Scavenge, Mark-Sweep and Mark-Compact.</p>
<p>Scavenge is a very fast garbage collection technique and operates with objects in New Space. Scavenge is the implementation of <a href="http://en.wikipedia.org/wiki/Cheney's_algorithm" target="_blank" rel="external">Cheney’s Algorithm</a>. The idea is very simple, New Space is divided in two equal semi-spaces: To-Space and From-Space. Scavenge GC occurs when To-Space is full. It simply swaps To and From spaces and copy all live objects to To-Space or promote them to one of the old spaces if they survived two scavenges, and is then entirely erased from the space. Scavenges are very fast however they have the overhead of keeping double sized heap and constantly copying objects in memory. The reason to use scavenges is because most objects die young.</p>
<p>Mark-Sweep &amp; Mark-Compact is another type of garbage collector used in V8. The other name is full garbage collector. It marks all live nodes, then sweeps all dead nodes and defragments memory.</p>
<h3 id="gc-performance-and-debugging-tips"><a name="user-content-gc-performance-and-debugging-tips" href="#gc-performance-and-debugging-tips" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>GC Performance and Debugging Tips</h3>
<p>While for web applications high performance might not be such a big problem, you will still want to avoid leaks at all costs. During the mark phase in full GC the application is actually paused until garbage collection is completed. This means the more objects you have in the heap, the longer it will take to perform GC and the longer users will have to wait.</p>
<h3 id="always-give-names-to-closures-and-functions"><a name="user-content-always-give-names-to-closures-and-functions" href="#always-give-names-to-closures-and-functions" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Always give names to closures and functions</h3>
<p>It’s much easier to inspect stack traces and heaps when all your closures and functions have names.<br>
<pre><code class="javascript">db.query('GIVE THEM ALL', function GiveThemAllAName(error, data) {
    ...
})
</code></pre></p>
<h3 id="avoid-large-objects-in-hot-functions"><a name="user-content-avoid-large-objects-in-hot-functions" href="#avoid-large-objects-in-hot-functions" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Avoid large objects in hot functions</h3>
<p>Ideally you want to avoid large objects inside of hot functions so that all data is fit into New Space. All CPU and memory bound operations should be executed in background. Also avoid deoptimization triggers for hot functions, optimized hot function uses less memory than non-optimized ones.</p>
<h3 id="hot-functions-should-be-optimized"><a name="user-content-hot-functions-should-be-optimized" href="#hot-functions-should-be-optimized" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Hot functions should be optimized</h3>
<p>Hot functions that run faster but also consume less memory cause GC to run less often. V8 provides some helpful debugging tools to spot non-optimized functions or deoptimized functions.</p>
<p>Avoid polymorphism for IC’s in hot functions</p>
<p>Inline Caches (IC) are used to speed up execution of some chunks of code, either by caching object property access obj.key or some simple function.<br>
<pre><code class="javscript">function x(a, b) {
  return a + b;
}

x(1, 2); // monomorphic
x(1, “string”); // polymorphic, level 2
x(3.14, 1); // polymorphic, level 3
</code></pre><br>
When <code>x(a,b)</code> is run for the first time, V8 creates a monomorphic IC. When you call x a second time, V8 erases the old IC and creates a new polymorphic IC which supports both types of operands integer and string. When you call IC the third time, V8 repeats the same procedure and creates another polymorphic IC of level 3.</p>
<p>However, there is a limitation. After IC level reaches 5 (could be changed with <code>–max_inlining_levels</code> flag) the function becomes megamorphic and is no longer considered optimizable.</p>
<p>It’s intuitively understandable that monomorphic functions run the fastest and also have a smaller memory footprint.</p>
<h3 id="dont-add-large-files-to-memory"><a name="user-content-dont-add-large-files-to-memory" href="#dont-add-large-files-to-memory" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Don’t add large files to memory</h3>
<p>This one is obvious and well known. If you have large files to process, for example a large CSV file, read it line-by-line and process in little chunks instead of loading the entire file to memory. There are rather rare cases where a single line of csv would be larger than 1mb, thus allowing you to fit it in New Space.</p>
<h3 id="do-not-block-main-server-thread"><a name="user-content-do-not-block-main-server-thread" href="#do-not-block-main-server-thread" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Do not block main server thread</h3>
<p>If you have some hot API which takes some time to process, such as an API to resize images, move it to a separate thread or turn it into a background job. CPU intensive operations would block main thread forcing all other customers to wait and keep sending requests. Unprocessed request data would stack in memory, thus forcing full GC to take longer time to finish.</p>
<h3 id="do-not-create-unnecessary-data"><a name="user-content-do-not-create-unnecessary-data" href="#do-not-create-unnecessary-data" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Do not create unnecessary data</h3>
<p>I once had a weird experience with restify. If you send a few hundred thousand requests to an invalid URL then the application memory would rapidly grow on up to hundred megabytes until a full GC kicks in a few seconds later, which is when everything would go back to normal. Turns out that for each invalid URL, restify generates a new error object which includes long stack traces. This forced newly created objects to be allocated in Large Object Space rather than in New Space.</p>
<p>Having access to such data could be very helpful during development, but obviously not required on production. Therefore the rule is simple - do not generate data unless you certainly need it.</p>
<h3 id="know-your-tools"><a name="user-content-know-your-tools" href="#know-your-tools" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Know your tools</h3>
<p>Last, but certainly not the least, is to know your tools. There are various debuggers, leak cathers, and usage graphs generators. All those tools can help you make your software faster and more efficient.</p>
<h3 id="conclusion"><a name="user-content-conclusion" href="#conclusion" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Conclusion</h3>
<p>Understanding how V8’s garbage collection and code optimizer works is a key to application performance. V8 compiles JavaScript to native assembly and in some cases well written code could achieve performance comparable with GCC compiled applications.</p>
<p>And in case you are wondering, the new API application for my Toptal client, although there is room for improvement, is working very well!</p>
<p>Joyent recently released a new version of Node.js which uses one of the latest versions of V8. Some applications written for Node.js v0.12.x may not be compatible with the new v4.x release. However, applications will experience tremendous performance and memory usage improvement within the new version of Node.js.</p></article></body></html>
      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/29/measuring-javascript-functions-performance/">测量javascript函数的性能[译]</a></h1>
  

      
      <time datetime="2015-09-29T00:57:45.000Z">Sep 29 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址:<a href="http://www.sitepoint.com/measuring-javascript-functions-performance/" target="_blank" rel="external">http://www.sitepoint.com/measuring-javascript-functions-performance</a></p>
<p>性能总是软件中扮演了重要的角色。在网络上，性能是尤为重要，如果我们提供缓慢的网页给用户，我们的用户可以轻松更改网站去访问我们的竞争对手的网站。作为一个专业的web开发者，我们不得不把这个问题考虑在内。很多老的网络性能优化的最佳实践，就像请求最小化，使用CDN，不写渲染代码块，如今还是管用的。然而，越来越多的web应用在使用Javascript，验证我们的代码是快的是很重要的。</p>
<p>假如你有一个正在运行的函数，但是你怀疑这个函数运行没有足够快，同时你计划着要改进这个函数。如何证明你的假设呢？什么是当今测试函数性能的最贱实践呢？一般来说，最好实现这个任务的方式是使用函数内建的<code>performance.now()</code>来测量在你执行函数前后的时间。</p>
<p>在这篇文章我们将会讨论如何测量代码执行时间和避免一些常见的坑的技术。</p>
<p><code>Performance.now()</code><br>高精度计时接口提供的一个方法，名字叫<code>now()</code>的可以返回一个DOM高精度时间戳对象。提供了一个浮点小数反映当前时间毫秒到毫秒的千分之一的时间戳。分别，这些数据没有添加过多的值来提供你分析，但是两个不同的数字之间的差值可以描述所消耗多少时间。</p>
<p>事实上它比内置的日期对象更准确,并且是‘单调’的。意味着，简单来说，是不会受到系统的影响（像你的笔记本操作系统）周期性地校正系统时间。在更简单来说，定义的两个日期实例计算出的插值并不表示所有消耗的时间。</p>
<p>“单调”的数学定义式是（一个函数或数量）不同的方式进行不是增加就是减少。</p>
<p>另一种方式的解释，可以尝试想象下这一年之中当时钟前进或后退。例如，当时钟在的你的国家由于需要提高白天的日照，从而把时间跳过一小时，如果你创建时间实例在这个时间回退一小时之前，另一个时间实例在这个之后，将会看到不同内容就像“1小时3秒123毫秒”。如果使用两个<code>performance.now()</code>实例，会是”3秒123毫秒456789千分之一毫秒”。</p>
<p>在这个章节，我不会讲这些API的详情。所以如果你要看更多关于如何使用，我建议你去看下<a href="http://www.sitepoint.com/discovering-the-high-resolution-time-api/" target="_blank" rel="external">探索高精度计时API</a>这个文章。</p>
<p>现在你已经知道了什么是高精度计时API和如何使用，让我们深入探讨一些潜在的问题。但在这之前，我们定义一个叫<code>makeHash()</code>的函数来用于我本文的其余部分的介绍。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHash</span><span class="params">(source)</span> </span>{</div><div class="line">  <span class="keyword">var</span> hash = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (source.length === <span class="number">0</span>) <span class="keyword">return</span> hash;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) {</div><div class="line">    <span class="keyword">var</span> char = source.charCodeAt(i);</div><div class="line">    hash = ((hash&lt;&lt;<span class="number">5</span>)-hash)+char;</div><div class="line">    hash = hash & hash; <span class="comment">// 转化到32的整形</span></div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>执行这个函数像如下的测量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> result = makeHash(<span class="string">'Peter'</span>);</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>如果你在浏览器里运行，你应该可以看到像如下的结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>运行的例子如下：</p>
<iframe id="cp_embed_YXmdNJ" src="//codepen.io/SitePoint/embed/YXmdNJ?height=350&amp;theme-id=6441&amp;slug-hash=YXmdNJ&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>通过这个例子，来开始我们的讨论</p>
<p>陷阱 #1 - 不小心测量了不重要的事情<br>在这个例子里，你能在<code>performance.now()</code>之间只做一件事并且其他的函数调用<code>makeHash()</code>,并指定其值设置为一个变量的结果。我们需要执行该功能，没有别的时间。这个测量详细如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(makeHash(<span class="string">'Peter'</span>));  <span class="comment">// bad idea!</span></div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_PqMXWv" src="//codepen.io/SitePoint/embed/PqMXWv?height=350&amp;theme-id=6441&amp;slug-hash=PqMXWv&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>在这个例子里，我们将会测试<code>makeHash(&#39;Peter&#39;)</code>调用所消耗的时间，多长在发送和打印输出在控制台。我们不知道多久这两个操作分别的时间消耗。你只知道一起的时间。它需要发送和打印输出的时间将很大程度上取决于浏览器，甚至取决于当时正在进行什么。</p>
<p>也许你完全知道的console.log是不可预测的消耗时间。但它是将执行多个功能同样是错误，即使各功能不涉及任何的I/O。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> name = <span class="string">'Peter'</span>;</div><div class="line"><span class="keyword">var</span> result = makeHash(name.toLowerCase()).toString();</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>同样，我们不知道的执行时间是如何分布的。变量赋值是<code>toLowerCase（）</code>的调用，还是<code>toString（）</code>的调用？</p>
<p>陷阱 #2 - 只测量一次<br>另一个通常会犯的错误只是一次测量，总体所花费的时间在这个基础上的结论。很可能是在不同的时间完全不同的。执行的时间很大程度取决于多种因素：</p>
<ul>
<li>编译器预热的时间（如 编译代码到字节码的时间）</li>
<li>主线程是忙着做我们并没有意识到要去其他的东西，</li>
<li>你的计算机的CPU（S）是忙于的其他事情而减慢你的整个浏览器上增量改进的重复执行的功能。</li>
</ul>
<p>像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">}</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, ((t1 - t0) / <span class="number">10</span>).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate'</span>);</div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_Qbezpj" src="//codepen.io/SitePoint/embed/Qbezpj?height=350&amp;theme-id=6441&amp;slug-hash=Qbezpj&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>这种方法的风险是，我们的浏览器的JavaScript引擎可能使用了子优化，这意味着第二次函数调用相同的输入，也可以从中受益记住第一输出，并简单地使用了第一次的输出。为了解决这个问题，你可以使用重复发送，在相同的输入字符串（例如：’Peter’）的多种不同的输入字符串代替。显然，随着测试与不同的输入，问题是正在测量功能需要不同的时间量。也许有些的输入导致比其他的输入更长的执行时间。</p>
<p>陷阱 #3 - 过分依赖的平均<br>在上一章节中，我们了解到，多次运行的东西，最好有不同的输入这种好的实践。但是，我们必须记住，使用不同的输入的问题是，执行可能需要比所有其它输入要长得多。因此，让我们退后一步，并发送相同的输入。假设我们发送相同的输入十次，并为每个，打印出来多久了。输出可能是这个样子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0234</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0200</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0281</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0162</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0245</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0677</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0289</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0240</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0311</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>注意为什么第一次的数据是和其他九次完全不同。最有可能的，这是因为在我们的浏览器的JavaScript引擎使用一些子优化，需要一些预热。还有一点，我们可以做，以避免这一点，但也有一些我们可以考虑，以防止有错误的结论很好的补救措施。</p>
<p>一种方法是计算最后九次的平均值。另一个更实际的方法是收集所有结果和计算一个中位数。基本上，它是所有的结果一字排开，排序顺序和采摘中间的一个。这个<code>performance.now（）</code>是非常有用的，因为你会得到一个有用的数据。</p>
<p>使用中位值函数再尝试下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> numbers = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  <span class="keyword">var</span> t0 = performance.now();</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">  <span class="keyword">var</span> t1 = performance.now();</div><div class="line">  numbers.push(t1 - t0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Median time'</span>, median(numbers).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>陷阱 #4 - 在可预知的顺序中比较函数<br>我们已经明白，测量多次，取平均值是个好主意。此外，上一章节的例子告诉我们，可以使用优选平均的中值来代替。</p>
<p>现在，事实上，一个很好用的测量函数执行时间的方法是比较哪些函数更快。假设我们有两个函数，把相同类型的输入，并产生相同的结果，但在内部，他们的工作方式不同。</p>
<p>比方说，我们希望有一个功能，在不区分大小写情况下某个字符串是在字符串数组返回true，否则返回false。换句话说，我们不能用Array.prototype.indexOf，因为需要不区分大小写。这里有一个这样的实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>立即我们注意到，因为<code>haystack.forEach</code>循环可以使用一个早期匹配元素来改善替代。让我们尝试用好的老的写法，for循环的版本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>现在我们可以看下哪个更快。我们每个函数进行十次测量并收集测试结果:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn1</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn2</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">measureFunction</span><span class="params">(func)</span> </span>{</div><div class="line">  <span class="keyword">var</span> letters = <span class="string">'a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z'</span>.split(<span class="string">','</span>);</div><div class="line">  <span class="keyword">var</span> numbers = [];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; letters.length; i++) {</div><div class="line">    <span class="keyword">var</span> t0 = performance.now();</div><div class="line">    func(letters, letters[i]);</div><div class="line">    <span class="keyword">var</span> t1 = performance.now();</div><div class="line">    numbers.push(t1 - t0);</div><div class="line">  }</div><div class="line">  <span class="built_in">console</span>.log(func.name, <span class="string">'took'</span>, median(numbers).toFixed(<span class="number">4</span>));</div><div class="line">}</div><div class="line"></div><div class="line">measureFunction(isIn1);</div><div class="line">measureFunction(isIn2);</div></pre></td></tr></table></figure>

<p>运行下得到如下的输出：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line">isIn1 took <span class="number">0.0050</span></div><div class="line">isIn2 took <span class="number">0.0150</span></div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_YXmdZJ" src="//codepen.io/SitePoint/embed/YXmdZJ?height=350&amp;theme-id=6441&amp;slug-hash=YXmdZJ&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>刚刚发生了什么？第一个功能是快三倍。这是不应该发生的！</p>
<p>原因很简单，但是很微妙。第一个功能，使用了haystack.forEach得益于在浏览器的JavaScript引擎的一些低级别的优化，当我们使用数组索引去做，就不会被优化。这证明了我们的观点：如果你不测量，你永远不知道！</p>
<p>结论<br>在我们试图如何使用<code>performance.now（）</code>取得JavaScript的一个准确的执行时间，我们偶然发现了一个基准场景，我们的实证研究结果得出结论和我们的直觉完全相反。问题的关键是，如果你想写得更快的Web应用程序，JavaScript代码就需要优化。由于电脑（差不多）是活生生的东西，令人如此的不可预知。最可靠的方法就是通过衡量和比较来改进代码确保更快的执行速度。</p>
<p>另一个原因，我们永远不知道这些代码是更快的，因为不同的上下文中，我们有做同一件事的多种方式。在上一节中，我们执行不区分大小写字符串搜索寻找除其他26个字符串。如果我们10万名中匹配字符串，该结论可能是完全不同的。</p>
<p>上述例子并不完整，还有更多的陷阱，以做到心中有数。例如，测量不现实的场景或仅测量在一个JavaScript引擎。但肯定的是，谁想要写出更快，更好的Web应用程序,开发者就可以使用<code>performance.now（）</code>这个不错的协助。最后但并非最不重要的，请记住，测试执行时间只产生了“更好的代码”的一个方面。还有内存和代码的复杂性考虑，要牢记。</p>
<p>现在你这么想？你有没有用这个功能来测试你的代码的性能？如果没有，你怎么在这个阶段进行？请在下面的评论中分享你的看法。让我们开始讨论！</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/25/yo-todo-list-note/">todos用yo来实现的说明</a></h1>
  

      
      <time datetime="2015-09-25T00:28:02.000Z">Sep 25 2015</time>
      
    </header>
    <div class="entry">
      
        <p>本文档的目的是通过一个todos的例子讲下如何用yo进行前端开发，包含开发流程全过程，涵盖：开发，构建，测试，调试，部署。规范前端开发的工作流，后续会补充单元测试的部分。</p>
<h2 id="中间使用到的工具和框架">中间使用到的工具和框架</h2>
<h3 id="服务端：">服务端：</h3>
<ul>
<li>yo（express，一些必要的中间件）</li>
<li>npm（安装node模块）</li>
</ul>
<h3 id="客户端：">客户端：</h3>
<ul>
<li>sea.js(客户端依赖包处理)</li>
<li>SPM（客户端依赖包管理）</li>
<li>gulp（项目构建，js，css，预处理，合并，压缩，部署）</li>
<li>compass（css预编译）</li>
<li>npm（工具依赖管理）</li>
</ul>
<h2 id="目录结构：">目录结构：</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">yo.todo</div><div class="line"> <span class="string">|_client  客户端目录</span></div><div class="line"> <span class="string">|  |_js   前端js源码目录</span></div><div class="line"> <span class="string">|  |_sass sass源码目录</span></div><div class="line"> <span class="string">|  |_index.js  前端js的入口文件</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（依赖包）</span></div><div class="line"> <span class="string">|  |_gulpfile.js  项目构建gulp脚本</span></div><div class="line"> <span class="string">|_server  服务端目录</span></div><div class="line"> <span class="string">|  |_adapters  接口适配业务代码目录</span></div><div class="line"> <span class="string">|  |_interface  接口配置文件目录</span></div><div class="line"> <span class="string">|  |_stub  后端桩代码目录</span></div><div class="line"> <span class="string">|  |_views 视图目录</span></div><div class="line"> <span class="string">|  |_app.js  应用入口文件</span></div><div class="line"> <span class="string">|  |_staticConfig.js 静态文件路径配置</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（服务端端）</span></div><div class="line"> <span class="string">|_public  静态资源目录（用于开发，测试阶段）</span></div><div class="line">    <span class="string">|_css</span></div><div class="line">    <span class="string">|_sea.js 依赖seajs</span></div></pre></td></tr></table></figure>

<h2 id="服务初始化的过程：">服务初始化的过程：</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:700px; height:500px;" src="https://www.processon.com/embed/55fd7ef8e4b00fa66f1009b7"></iframe>

<h2 id="请求调用过程">请求调用过程</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:670px; height:320px;" src="https://www.processon.com/embed/55fe57eae4b00fa66f125212"></iframe>

<h2 id="开发步骤">开发步骤</h2>
<p>准备：</p>
<ul>
<li>安装必要的开发工具,当然先得安装node.js,具体参考<a href="https://nodejs.org/" target="_blank" rel="external">这里</a>。</li>
<li>安装compass,先安装ruby，参考<a href="http://www.ruanyifeng.com/blog/2012/11/compass.html" target="_blank" rel="external">这里</a></li>
<li>安装spm,运行<code>npm install spm@3.4.3 -g</code>（spm3.4.3之后使用了webpack，所以暂时用3.4.3）。</li>
<li>安装gulp，运行<code>npm install gulp -g</code>(如果安装了cnpm，可以替代npm)。</li>
<li>安装slush，运行<code>npm install slush -g</code>（用于创建空项目）。</li>
<li>安装slush-yo,运行<code>npm install slush-yo -g</code>(yo项目模板)。</li>
</ul>
<h3 id="新建一个空项目">新建一个空项目</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir todos</div><div class="line">slush yo</div><div class="line">cd client</div><div class="line">spm <span class="operator"><span class="keyword">install</span></span></div><div class="line">npm <span class="keyword">install</span></div><div class="line">cd <span class="keyword">server</span></div><div class="line">npm <span class="keyword">install</span></div></pre></td></tr></table></figure>

<p>在mac或者ubuntu上需要用<code>sudo</code>。</p>
<p>运行空项目：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis-<span class="keyword">server</span> -port <span class="number">7777</span></div><div class="line"></div><div class="line">node app</div></pre></td></tr></table></figure>

<p>可以看到如图：<br><img src="http://7mj4k1.com1.z0.glb.clouddn.com/0416BFD2-66BD-4DAA-9246-33ED700FDCE1.png" alt="运行成功"></p>
<h3 id="编写服务接口配置">编写服务接口配置</h3>
<p>需要存储todo list的服务，这个例子数据和状态主要保存服务端，</p>
<ul>
<li>添加一个todo;</li>
<li>编辑一个todo;</li>
<li>获取todo列表；</li>
<li>切换todo的状态；</li>
<li>删除todo；</li>
<li>清除已完成的todo；</li>
</ul>
<p>代码如下：</p>
<p>server/stub/router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list = [];</div><div class="line"><span class="keyword">var</span> toggleAll = <span class="literal">false</span>;</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{</div><div class="line"></div><div class="line">    <span class="comment">//添加</span></div><div class="line">    app.post(<span class="string">'/todo'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (req.body.todo) {</div><div class="line">            list.push({</div><div class="line">                id: uuid(),</div><div class="line">                todo: req.body.todo,</div><div class="line">                state: <span class="number">0</span></div><div class="line">            });</div><div class="line">            res.send(ret(<span class="literal">true</span>));</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            res.send(ret(<span class="literal">false</span>));</div><div class="line">        }</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//编辑保存</span></div><div class="line">    app.put(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> saved = <span class="literal">false</span>,</div><div class="line">            state;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    setval(req.body.todo, req.body.state, list[i]);</div><div class="line">                    saved = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(saved));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//首页</span></div><div class="line">    app.get(<span class="string">'/todos'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> data = ret(<span class="literal">true</span>, list);</div><div class="line">        res.send(data);</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//删除</span></div><div class="line">    app.delete(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> isDel = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    list.splice(i, <span class="number">1</span>);</div><div class="line">                    isDel = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(isDel));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//切换状态</span></div><div class="line">    app.put(<span class="string">'/todos/toggleall'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (!toggleAll) {</div><div class="line">                list[i].state = <span class="number">1</span>;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                list[i].state = <span class="number">0</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        toggleAll = !toggleAll;</div><div class="line">        res.send(ret(<span class="literal">true</span>));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//清除完成项</span></div><div class="line">    app.delete(<span class="string">'/todos/completed'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> unCompleted = [];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (list[i].state === <span class="number">0</span>) {</div><div class="line">                unCompleted.push(list[i]);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        list = unCompleted;</div><div class="line">        <span class="keyword">return</span> res.send(ret(<span class="literal">true</span>, list));</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>

<p>可以用postman类似的http客户端测试下服务：</p>
<p><img src="http://7wy47w.com1.z0.glb.clouddn.com/C031899C-515A-455E-9013-D5126B1ABDAE.png" alt="postman"></p>
<h3 id="编写前端view对应后端服务的接口配置和接口适配">编写前端view对应后端服务的接口配置和接口适配</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">exports.domain = <span class="string">'http://localhost:3000'</span>;</div><div class="line">exports.res =</div><div class="line">    [{</div><div class="line">    route: <span class="string">'/'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    params: []</div><div class="line">}, {</div><div class="line">    route: <span class="string">'/:state'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    adapter: <span class="string">'index'</span>,</div><div class="line">    params: []</div><div class="line">}];</div></pre></td></tr></table></figure>

<p>目前的todo的view只有一个，为了使不同状态的匹配加了”/:state”的路由。<br>后端映射到同一个接口。</p>
<p>后端服务也许无法满足你前端展示的要求，所以，会在适配层，加一些返回数据结构的处理。<br>适配层的业务注入规约：会找到interface的路由作为注入的原则（路由名称+请求方法），或者指定路由的适配的业务模块。<br>代码如下（server/adapters/index.js）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">exports.get = <span class="function"><span class="keyword">function</span><span class="params">(data, req, res)</span> </span>{</div><div class="line">    <span class="keyword">var</span> states = [<span class="string">'active'</span>, <span class="string">'completed'</span>];</div><div class="line">    <span class="keyword">var</span> curState = <span class="string">'all'</span>;</div><div class="line">    <span class="keyword">var</span> curStateVal = <span class="number">3</span>;</div><div class="line">    data.completedTodos = <span class="literal">false</span>; <span class="comment">//完成的todos</span></div><div class="line">    data.activeTodoWord = <span class="string">'items'</span>;<span class="comment">//todo单位的单复数</span></div><div class="line">    data.activeTodoCount = <span class="number">0</span>;<span class="comment">//当前未完成todo</span></div><div class="line">    data.allCount = data.data.length;<span class="comment">//所有的todo数量</span></div><div class="line">    data.module = <span class="string">'todos'</span>;<span class="comment">//js的入口模块</span></div><div class="line">    <span class="keyword">var</span> curData = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; states.length; j++) { <span class="comment">//判断过滤条件</span></div><div class="line">        <span class="keyword">if</span> (states[j] === req.proxyParams.params.state) {</div><div class="line">            curState = states[j];</div><div class="line">            curStateVal = j;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            curState = <span class="string">'all'</span>;</div><div class="line">            curStateVal = <span class="number">3</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    data[curState] = <span class="literal">true</span>; <span class="comment">//设置当前的过滤条件</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.data.length; i++) {</div><div class="line">        <span class="keyword">if</span> (data.data[i].state === <span class="number">1</span>) { <span class="comment">//设置是否有完成</span></div><div class="line">            data.completedTodos = <span class="literal">true</span>;</div><div class="line">            data.data[i].completed = <span class="literal">true</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            data.activeTodoCount++; <span class="comment">//设置todo的数据</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (data.data[i].state === curStateVal) {</div><div class="line">            curData.push(data.data[i]); <span class="comment">//过滤数据</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (curStateVal !== <span class="number">3</span>) { <span class="comment">//设置过滤后的数据</span></div><div class="line">        data.data = curData;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.activeTodoCount === <span class="number">1</span>) { <span class="comment">//设置展示单复数</span></div><div class="line">        data.activeTodoWord = <span class="string">'item'</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="编写模板">编写模板</h3>
<p>拆解页面结构：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">layout</div><div class="line">  <span class="command">\_</span>header</div><div class="line">  <span class="command">\_</span>todo</div><div class="line">    <span class="command">\_</span>header</div><div class="line">    <span class="command">\_</span>section</div><div class="line">    <span class="command">\_</span>footer</div><div class="line">    <span class="command">\_</span>bottom</div><div class="line">  <span class="command">\_</span>footer</div></pre></td></tr></table></figure>

<p>其中，header，todo/header,todo/section,todo/footer,todo/bottom,footer都是partials<br>采用handlebars模板编写。<br>当前后端返回数据时，在前端进行数据绑定生成HTML。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/78F31156-3915-4DBB-847C-FFF611125C2C.png" alt="没有样式的视图"></p>
<h3 id="编写css样式">编写css样式</h3>
<p>编写样式采用compass的方式，用compass watch，实时编译成css。</p>
<p>到client目录，直接<code>compass watch</code></p>
<p>可以按照partials，拆分样式。<br>配置生成文件，在config.rb,或者使用gulp进行的构建。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/B9B70361-8948-411C-908F-00B503DDB8B2.png" alt="添加样式后"></p>
<h3 id="编写JS前端逻辑">编写JS前端逻辑</h3>
<p>前端需要操作服务端的todo的内容，并且展现，主要是增删查改这些操作，同时绑定相关的事件。这个例子里面使用jquery和pjax等，所以需要在<code>client</code>下的<code>package.json</code>,添加依赖包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">"spm"</span>: {</div><div class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: {</div><div class="line">    <span class="string">"jquery"</span>: <span class="string">"1.8.3"</span>,</div><div class="line">    <span class="string">"jquery-pjax-183"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">    <span class="string">"nprogress-183"</span>: <span class="string">"0.1.6"</span>,</div><div class="line">    <span class="string">"import-style"</span>: <span class="string">"1.0.0"</span></div><div class="line">  },</div><div class="line"> ...</div></pre></td></tr></table></figure>

<p>需要执行<code>spm install</code>。</p>
<p>前端的主要逻辑在<code>js/todos.js</code>里面，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * todos</div><div class="line"> *</div><div class="line"> * todos的前端代码</div><div class="line"> * 只提交todo的操作，服务端维护todo状态</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</div><div class="line"><span class="keyword">var</span> NProgress = <span class="built_in">require</span>(<span class="string">'nprogress-183'</span>);</div><div class="line"><span class="built_in">require</span>(<span class="string">'jquery-pjax-183'</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 初始化Pjax</div><div class="line"> *</div><div class="line"> * @return void</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initPjax</span><span class="params">()</span> </span>{</div><div class="line">    $(<span class="built_in">document</span>).pjax(<span class="string">'a'</span>, <span class="string">'#pjax-container'</span>);</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.start();</div><div class="line">    });</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.done();</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> ENTER_KEY = <span class="number">13</span>; <span class="comment">//回车键</span></div><div class="line"><span class="keyword">var</span> ESCAPE_KEY = <span class="number">27</span>; <span class="comment">//esc键</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> $newTodoInput = $(<span class="string">"#new-todo"</span>), <span class="comment">//新建一个todo</span></div><div class="line">    $listLi = $(<span class="string">"#todo-list li"</span>), <span class="comment">//列表单元</span></div><div class="line">    $listToggle = $(<span class="string">"#todo-list .toggle"</span>), <span class="comment">//切换todo状态</span></div><div class="line">    $listLiEdit = $(<span class="string">"#todo-list .edit"</span>), <span class="comment">//编辑输入</span></div><div class="line">    $toggleall = $(<span class="string">"#toggle-all"</span>), <span class="comment">//切换所有的todo状态</span></div><div class="line">    $listDestroy = $(<span class="string">"#todo-list .destroy"</span>), <span class="comment">//删除todo</span></div><div class="line">    $clearCompleted = $(<span class="string">"#clear-completed"</span>); <span class="comment">//清除完成的</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 界面操作对象</div><div class="line"> * @type {Object}</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> actions = {</div><div class="line">    toggleAll: {</div><div class="line">        url: <span class="string">'/todos/toggleall'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $toggleall</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    add: {</div><div class="line">        url: <span class="string">'/todo'</span>,</div><div class="line">        method: <span class="string">'POST'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $newTodoInput,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    actions.add.data = {</div><div class="line">                        todo: $(e.target).val() + <span class="string">''</span></div><div class="line">                    };</div><div class="line">                    $(e.target).val(<span class="string">''</span>);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    edit: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">var</span> state = elem.parents(<span class="string">'li'</span>).find(<span class="string">'.toggle'</span>).attr(<span class="string">'checked'</span>) ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.data = {</div><div class="line">                todo: elem.parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(),</div><div class="line">                state: state</div><div class="line">            };</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listToggle</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'dblclick'</span>,</div><div class="line">            elem: $listLi,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> $input = $(e.target).closest(<span class="string">'li'</span>).addClass(<span class="string">'editing'</span>).find(<span class="string">'.edit'</span>);</div><div class="line">                $input.val($input.val()).focus();</div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> val = e.target.value;</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line"></div><div class="line">                    $(e.target).parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(val);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (e.which === ESCAPE_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">        }, {</div><div class="line">            event: <span class="string">'blur'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                $(e.target).parents(<span class="string">'li'</span>).removeClass(<span class="string">'editing'</span>);</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    remove: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listDestroy,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    clearCompleted: {</div><div class="line">        url: <span class="string">'/todos/completed'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $clearCompleted</div><div class="line">        }]</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 事件绑定操作</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">()</span> </span>{</div><div class="line">    $.each(actions, <span class="function"><span class="keyword">function</span><span class="params">(key, value)</span> </span>{</div><div class="line">        $.each(value.eventHandle, <span class="function"><span class="keyword">function</span><span class="params">(index, hb)</span> </span>{</div><div class="line">            hb.elem.live(hb.event, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> isSend = <span class="literal">false</span>;</div><div class="line">                <span class="keyword">if</span> (hb.handle) {</div><div class="line">                    isSend = hb.handle(e);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    isSend = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">if</span> (isSend) {</div><div class="line">                    <span class="keyword">if</span> (value.before) {</div><div class="line">                        value.before($(e.target));</div><div class="line">                    }</div><div class="line">                    send(value);</div><div class="line">                }</div><div class="line">            });</div><div class="line">        });</div><div class="line">    });</div><div class="line">    initPjax();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 发送操作信息</div><div class="line"> * @param  {Object} hb</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">(hb)</span> </span>{</div><div class="line">    <span class="keyword">var</span> url = hb.url + (hb.params || <span class="string">''</span>);</div><div class="line">    $.ajax({</div><div class="line">        url: url,</div><div class="line">        type: hb.method,</div><div class="line">        data: hb.data ? hb.data : <span class="literal">null</span>,</div><div class="line">        dataType: <span class="string">"json"</span></div><div class="line">    }).done(<span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (data.opts) {</div><div class="line">            $.pjax.reload(<span class="string">'#pjax-container'</span>);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            alert(<span class="string">'something wrong!'</span>);</div><div class="line">        }</div><div class="line">    }).fail(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        alert(<span class="string">'something wrong!'</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">bind();</div></pre></td></tr></table></figure>

<h3 id="整理联调">整理联调</h3>
<p>代码编写完成后，可以通过<code>gulp start</code>,进行代码联调。<br>看看有没有问题，修复开发过程中疏漏的点。在yo中，如果是开发环境，会自动启用smp的服务，对于拆散js的组合调用，可以用chrome dev tool进行前端调试，后端调试，可以使用<code>npm install -g node-inspector</code>,用<code>node-debug app.js</code>进行服务端的代码调试。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/EE3F2819-9B70-4DF3-88F1-AB171750DD97.png" alt="chrome dev tool"></p>
<p>服务端的express传参，和变量数据，可以通过<code>express-debug</code>查看<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/99C72E62-EC9C-4357-89B6-43902ACA9E34.png" alt="express-debug"></p>
<h3 id="构建项目">构建项目</h3>
<p>到此为止，已经把todos的功能已全部实现但是，工作流程，才走了一半，后面将会执行构建，将现有的项目，部署到测试环境，当测试环境测试没有问题，讲发布到生产。</p>
<p>而做这些事情，可以由gulp来完成，gulp可以编写管道式的构建过程，高效的将需要的自动化过程执行。<br>目前前端的gulp涉及如下的任务：</p>
<ul>
<li>运行server</li>
<li>compass的实时预处理</li>
<li>js的合并和库文件的合并</li>
<li>样式的合并</li>
<li>部署到CDN</li>
</ul>
<p>代码清单详见：client/gulpfile.js。</p>
<h4 id="测试代码打包">测试代码打包</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp</div></pre></td></tr></table></figure>

<p>测试环境运行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ..</div><div class="line">NODE_ENV=test node server/app</div></pre></td></tr></table></figure>

<h4 id="生产环境发布和运行">生产环境发布和运行</h4>
<p>把代码部署到CDN</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp dist</div></pre></td></tr></table></figure>

<p>运行生产环境,需要保证服务不会挂掉，所以需要使用MP2来进行进程守护，以及服务监控和治理。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ..</div><div class="line">NODE_ENV=production pm2 <span class="operator"><span class="keyword">start</span> <span class="keyword">server</span>/app</span></div></pre></td></tr></table></figure>

<h2 id="后续补充工作流">后续补充工作流</h2>
<ul>
<li>单元测试</li>
<li>持续集成</li>
<li>代码检查</li>
</ul>
<h2 id="后续待做事项">后续待做事项</h2>
<ul>
<li>组件化</li>
<li>前后端分离（接口规范）</li>
<li>docker化</li>
</ul>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/13/Render-HTML-From-Client-Or-Server/">服务端或客户端生成HTML的设计思想</a></h1>
  

      
      <time datetime="2015-09-13T03:53:49.000Z">Sep 13 2015</time>
      
    </header>
    <div class="entry">
      
        <p>如果说web前端主要是由：HTML,CSS,JavaScript这些技术的组合，那么HTML的生成，可以由服务端或者客户端去渲染，取决于数据和HTML的绑定在哪个端去执行。</p>
<p>当是SPA（Single Page Application）形态的应用时：天然的使HTML的生成或则说DOM生成可以由前端完成，大量的路由逻辑，界面逻辑都在浏览器端完成。主要是服务端提供“服务接口+数据响应”，浏览器端调用“服务接口”，数据绑定到视图渲染（可以是DOM生成或者HTML生成并修改DOM），以及路由视图的跳转。</p>
<p>SPA有一个问题需要解决，那就是如何做SEO，主要问题是两个：一个是URL友好，一个响应HTML结构语义化。</p>
<p>解决办法：</p>
<ol>
<li>url友好</li>
</ol>
<p>url友好，在SPA的大部分前端界面跳转都相对映射的URL（当然如果使用一些前端框架也实现了URL变化，如Angular，React-Router，vue-router），除非把url的变化考虑进去，使用Hash，或者HMTL5的history的push state接口，来改变url。</p>
<p>现有的大部分SPA的前端框架都有前端url路由功能，所以实现这个，难度不大。</p>
<ol>
<li>响应HTML结构语义化 </li>
</ol>
<p>如果数据在客户端绑定并渲染视图，在对于大多数搜索引擎的爬虫无法理解在客户端渲染的DOM，所以最好在服务端生成HTML。</p>
<p>针对SPA，如比较目前比较通用的有类似<a href="http://prerender.io/" target="_blank" rel="external">Prerender.io</a>，<a href="http://www.brombone.com/" target="_blank" rel="external">brombone</a>，<a href="http://www.seo4ajax.com/" target="_blank" rel="external">seojs</a>的服务，原理是：</p>
<ul>
<li>当一个搜索引擎的爬虫访问你的应用程序并且看到<code>&lt;meta name=&quot;fragment&quot; content=&quot;!&quot;&gt;</code>时，它会在你的URL中添加一个<code>?_escaped_fragment_=tag</code>。</li>
<li>你的服务器将会拦截这个请求，并把它发送给一个用来处理这个特殊的爬虫请求的中间件。在这篇文章中，我们选用Prerender.io，因此，下一步是针对Prerender.io的。</li>
<li>Prerender.io 将会检查请求的页面是否有一个现存的快照（或者缓存的页面），如果有，它会将这个页面响应给爬虫，如果没有的话，他会调用PhantomJS(一个服务端渲染DOM的中间键)来渲染这个完整页面，并将它响应给爬虫。</li>
</ul>
<p>优点：这个的做法的好处是和语言无关，比较解耦，可以和不同的后端语言结合使用。可以单独部署一组SEO的服务器来应对爬虫的访问，对于用户访问影响不大。</p>
<p>缺点：PhantomJS在生成界面的时候，比较消耗服务器资源，同时时间较长，需要做生成界面的缓存，以及页面缓存的更新。</p>
<p>SPA大量在现有互联网的使用，即将到来，只是现在囿于低版本IE浏览器的制约，约束在浏览器的发展。尽管现有前端框架都有优雅降级的做法，但是在大量低版本IE的用户面前，目前是无法大规模使用的。</p>
<p>主要原因：</p>
<ol>
<li>低版本IE(6,7,8)对于ES5的支持(Object.defineProperty)，甚至ES6的支持。</li>
<li>低版本IE(6,7,8)对CSS,DOM不是按照标准去理解的。</li>
<li>低版本IE(6,7,8)JS引擎性能较差，对于重度依赖Javascript的SPA会有性能瓶颈或编码不慎会导致无故内存泄露。</li>
</ol>
<p>但是还是比较看好SPA在浏览器的发展，毕竟新版的IE，以及其他的现代浏览器已经不存在以上的问题了，只是时间问题了。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/12/7-Reasons-to-Upgrade-to-Node-v4-Now/">现在升级到Node V4的七个理由</a></h1>
  

      
      <time datetime="2015-09-12T15:36:53.000Z">Sep 12 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html" target="_blank" rel="external">http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html</a></p>
<p>今天<a href="https://nodejs.org/en/blog/release/v4.0.0/" target="_blank" rel="external">Node v4</a>发布了。这是第一个在io.js合并后的<br>第一个稳定版本，给我们带来了一堆亮点，如新的ES6语法的添加。虽然有已经增加了很好的ES6的描述，但是这篇文章展示了如何使用它们！</p>
<p>特别是，我要去以下ES6补充的地址看看：</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">Template Strings</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">Classes</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">Arrow Functions</a><br><a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">Object Literals</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="external">Promises</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_6_support_in_Mozilla#Additions_to_the_String_object" target="_blank" rel="external">String Methods</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">let and const</a></p>
<h2 id="1-_Template_Strings(模板字符串)">1. Template Strings(模板字符串)</h2>
<p>如果你要用Javascript创建多行字符串，你或许会像下面的做法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = [</div><div class="line">    <span class="string">'The quick brown fox'</span>,</div><div class="line">    <span class="string">'jumps over'</span>,</div><div class="line">    <span class="string">'the lazy dog'</span></div><div class="line">].join(<span class="string">'\n'</span>);</div></pre></td></tr></table></figure>

<p>虽然这适用于少量的文字，但会多个语句变得混乱。因此，聪明的开发者想出了一个叫hack called multiline的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> multiline = <span class="built_in">require</span>(<span class="string">'multiline'</span>);</div><div class="line"><span class="keyword">var</span> message = multiline(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{<span class="comment">/*</span></div><div class="line">    The quick brown fox</div><div class="line">    jumps over</div><div class="line">    the lazy dog</div><div class="line">*/});</div></pre></td></tr></table></figure>

<p>幸运的是，ES6给我们带来了模板字符串：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = `</div><div class="line">    The quick brown fox</div><div class="line">        jumps over</div><div class="line">        the lazy dog</div><div class="line">`;</div></pre></td></tr></table></figure>

<p>在这个特性里，还可以进行字符串的赋值操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> name = <span class="string">'Schroedinger'</span>;</div><div class="line"></div><div class="line"><span class="comment">// stop doing this ...</span></div><div class="line"><span class="keyword">var</span> message = <span class="string">'Hello '</span> + name + <span class="string">', how is your cat?'</span>;</div><div class="line"><span class="keyword">var</span> message = [<span class="string">'Hello '</span>, name, <span class="string">', how is your cat?'</span>].join(<span class="string">''</span>);</div><div class="line"><span class="keyword">var</span> message = <span class="built_in">require</span>(<span class="string">'util'</span>).format(<span class="string">'Hello %s, how is your cat?'</span>, name);</div><div class="line"></div><div class="line"><span class="comment">// and instead do that ...</span></div><div class="line"><span class="keyword">var</span> message = `Hello ${name}, how is your cat?`;</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">查看更多template strings的详情在MDN</a>.</p>
<h2 id="2-_Classes（类）">2. Classes（类）</h2>
<p>定义类ES5看起来有些奇怪，还需要一定的时间去习惯：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Pet = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    <span class="keyword">this</span>._name = name;</div><div class="line">};</div><div class="line"></div><div class="line">Pet.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(Pet.prototype, <span class="string">'name'</span>, {</div><div class="line">  get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">  }</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> Cat = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    Pet.call(<span class="keyword">this</span>, name);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'util'</span>).inherits(Cat, Pet);</div><div class="line"></div><div class="line">Cat.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    Pet.prototype.sayHello.call(<span class="keyword">this</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">};</div></pre></td></tr></table></figure>


<p>幸运的是，在Node中我们可以使用新的ES6语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Pet {</div><div class="line">    constructor(name) {</div><div class="line">        <span class="keyword">this</span>._name = name;</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">    }</div><div class="line">    get name() {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class</span> Cat extends Pet {</div><div class="line">    constructor(name) {</div><div class="line">        super(name);</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        super.sayHello();</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>一个extends关键字，constructors，调用父类和属性。多好？<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">更多在MDN有完整的指南</a></p>
<h2 id="3-_Arrow_Functions(箭头函数)">3. Arrow Functions(箭头函数)</h2>
<p>动态的绑定函数调用的结合总是会引起一些混乱，人们在多个方面围绕它的工作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        self.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    }.bind(<span class="keyword">this</span>));</div><div class="line">};</div></pre></td></tr></table></figure>

<p>现在只需要使用箭头函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach((listener) =&gt; {</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">查看arrow functions更多详情</a>.</p>
<h2 id="4-_Object_Literals(对象直接量)">4. Object Literals(对象直接量)</h2>
<p>当使用对象直接量，你可以使用很不错的快捷方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> age = <span class="number">10</span>, name = <span class="string">'Petsy'</span>, size = <span class="number">32</span>;</div><div class="line"></div><div class="line"><span class="comment">// instead of this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age: age,</div><div class="line">    name: name,</div><div class="line">    size: size</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// ... do this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age,</div><div class="line">    name,</div><div class="line">    size</div><div class="line">};</div></pre></td></tr></table></figure>

<p>此外，您现在可以轻松的<a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">将函数添加到您的对象直接量上</a>。</p>
<h2 id="5-_Promises">5. Promises</h2>
<p>可以替换掉用第三方的像bluebird和Q的依赖，直接使用原生的promises。就像如下的api：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Promise(<span class="function"><span class="keyword">function</span> <span class="params">(resolve, reject)</span> </span>{});</div><div class="line"><span class="keyword">var</span> p2 = Promise.resolve(<span class="number">20</span>);</div><div class="line"><span class="keyword">var</span> p3 = Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>());</div><div class="line"><span class="keyword">var</span> p4 = Promise.all(p1, p2);</div><div class="line"><span class="keyword">var</span> p5 = Promise.race(p1, p2);</div><div class="line"></div><div class="line"><span class="comment">// and obviously</span></div><div class="line">p1.then(() =&gt; {}).catch(() =&gt; {});</div></pre></td></tr></table></figure>

<h2 id="6-_String_Methods">6. String Methods</h2>
<p>我们还可以使用一些新的字符串工具方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// replace `indexOf()` in a number of cases</span></div><div class="line">name.startsWith(<span class="string">'a'</span>)</div><div class="line">name.endsWith(<span class="string">'c'</span>);</div><div class="line">name.includes(<span class="string">'b'</span>);</div><div class="line"></div><div class="line"><span class="comment">// repeat the string three times</span></div><div class="line">name.repeat(<span class="number">3</span>);</div></pre></td></tr></table></figure>

<p>去告诉那些写ruby的孩子！字符串现在还更好的支持unicode的处理。</p>
<h2 id="7-_let_and_const">7. let and const</h2>
<p>猜下这个在如下函数调用后返回的值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">var</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; undefined</span></div></pre></td></tr></table></figure>

<p>是的，undefined。替换掉var，使用let你可以保证预期的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">let</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; 20</span></div></pre></td></tr></table></figure>

<p>理由是：var是函数作用域级的，然而let是块作用域级别的（这是人们所希望）。因为这个，说let是安全的var。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">你可以在MDN上获取更多关于let的信息</a>。</p>
<p>新增：Node现在支持const关键字，从而阻止您重新赋给一个不同的值相同的引用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> MY_CONST = <span class="number">42</span>; <span class="comment">// no, no</span></div><div class="line"><span class="keyword">const</span> MY_CONST = <span class="number">42</span>; <span class="comment">// yes, yes</span></div><div class="line"></div><div class="line">MY_CONST = <span class="number">10</span> <span class="comment">// with const, this is no longer possible</span></div></pre></td></tr></table></figure>

<p>综述所述</p>
<p>Node v4带来了更多的ES6的特性，同时我也希望这些7个例子已经使你信服升级和使用最新版本了。</p>
<p>这些更多的语言特性（像 maps/sets, symbols , generators,等）。请确保你已经查看过ES6补充的NodeV4概述。快乐升级！</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/11/40-npm-modules-we-can-t-live-without/">40个我们不可或缺的NPM包[译]</a></h1>
  

      
      <time datetime="2015-09-11T00:15:14.000Z">Sep 11 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a" target="_blank" rel="external">https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a</a></p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Cv7F9UtBMhsrcV2_rwqEgA.png" alt="npm picture"></p>
<p>Croissant按照字母顺序分享了他们用到的40个不可或缺的NPM模块：</p>
<p>agenda</p>
<p>这是一个类似于“cron”的作业，如每隔几分钟做一些事情。</p>
<p>agenda-ui</p>
<p>可视化的界面，用于管理agenda的作业，就像麦当劳的订单界面，让员工知道订单的状态。</p>
<p>async</p>
<p>用于对多个异步一次处理，主要用于异步编程，尽管我们也开始迁移到”q”,但是我们任然在一些地方使用，像“waterfall”和“each”对于一行数据在多数据相互依赖操作，会用到。</p>
<p>aws-sdk</p>
<p>我们用于上传文件到AWS S3上。</p>
<p>bcryptjs</p>
<p>担心你的密码的安全性？不用了！该算法是行业标准。即使我们遭受过黑客攻击，您的密码将仍然只是字母和符号混合的字符串。只要你的密码不是一个简单字典中的单词，虽然，因为如果有人没有得到这个数据，他们可以尝试在字典中的所有单词进行暴力破解。</p>
<p>body-parser</p>
<p>我们使用ExpressJS，所以我们需要序列化那些JSON的响应。</p>
<p>braintree</p>
<p>用于支付的一个智能（支付网关）依赖包。（国内用到不多）</p>
<p>chai</p>
<p>我们使用这个用于集成测试。（一个断言库）</p>
<p>compression</p>
<p>另一个像Express一样，你需要的包。用于压缩服务的响应，让数据在网络上传输更快。好东西。</p>
<p>express</p>
<p>这是个大魔法师。这是一个ExpressJS和NodeJS的web服务的核心模块，让我们可以不用写了大量的样板HTTP服务器代码。带来了一些很酷的特性，如指定一个静态目录作为一个简单的文件服务器，当然，以从它的充满活力的社区，创建的许多插件，可以很容易使用。</p>
<p>forever</p>
<p>如果一个node进程或者express服务崩溃了怎么办？这个小家伙会在后台为你重新启动。这实在是太聪明 - 你可以指定运行多久失败需要重新启动。这可以防止重启一遍又一遍自动失败进程。</p>
<p>fs-extra</p>
<p>当“fs”模块不够用时，“fs-extra”给你想要的更多功能。我们真的只是用它来满足使一个嵌套的文件夹如果在父文件夹不存在创建的能力。出于某种原因，对于“fs”来说，这是过分的要求。</p>
<p>gm</p>
<p>这个模块是一种法术。GraphicsMagick是一个包装已经由来已久的被用于许多图像操纵的很经典ImageMagick的C库。我们使用对上传图片的尺寸缩放和切图操作。你知道的那些放在AWS美丽场馆我们，我们会对它们用这个处理。</p>
<p>gulp</p>
<p>Gulp总是在我们编码背后运行着。它会自动的压缩我们的javascript和css文件。我们把它用于测试运行。它也有很多的包（如果你要找的话）！有人说它像“grunt”，其实是流运行的。</p>
<p>gulp-angular-templatecache</p>
<p>之前我们提到用Angular吗？我们是用Angular的。这个gulp插件允许我们在所有的HTML模板为一个文件以便更快的加载网站。Angular在加载页面时可以使用这些模板。</p>
<p>gulp-concat</p>
<p>记得我们前面谈到的呗？这需要找下。用于合并文件。</p>
<p>gulp-csso</p>
<p>做css最小化的。</p>
<p>gulp-istanbul</p>
<p>一个运行istanbul的单元测试覆盖率的gulp插件。</p>
<p>gulp-livereload</p>
<p>前端开发者的必备，可以连接你的浏览器当每一次文件修改它会刷新页面。做得好，gulp。</p>
<p>gulp-mocha</p>
<p>用于测试，这个插件封装了mocha，我们可以智能的进行测试，就像保证接口端可以正常运行。</p>
<p>gulp-plumber</p>
<p>由于我们所有事情用gulp的流和管道，我们需要一个小小的库，万一像gulp-csso运行失败，可以保证其他运行平滑。</p>
<p>gulp-sass</p>
<p>你以为我们使用CSS？ 再想一想。你看到的一切曾经是一个轻量的，顶尖的，SCSS（又名Sass）文件。Gulp 监听和编译每当我们作出改变时编译我们出主要的CSS的输出..超级快！</p>
<p>gulp-uglify</p>
<p>最后但并非最不重要的，这一插件确实不错的压缩前端JavaScript代码，所以我们可以超快速和超安全传输给你。</p>
<p>jwt-simple</p>
<p>JWT(JSON Web Token) 编码和解码的node包.</p>
<p>lodash</p>
<p>有用的Javascript的工具集，pick, omit, contains对于接口服务器响应时间大大缩短。</p>
<p>mime-types</p>
<p>用于跟踪文件扩展名的库，一个jpg图片文件得到的结果如“image/jpeg”。</p>
<p>mocha</p>
<p>mocha是一个测试平台，可以使用BDD的方式测试，使用“describe”和“it”，没有比这更简单的Javascript的测试了。 </p>
<p>moment</p>
<p>人性化的时间格式。</p>
<p>moment-timezone</p>
<p>moment的时区转化</p>
<p>mongoose</p>
<p>我们提到我们用MongoDB的？我们使用MongoDB的。Mongoose一直我们的团队所熟知，让我们总能看到一眼我们的数据结构是什么。没有它，你可能最终与各种数据库中的对象，造成谁知道什么样的混乱的后端和前端的。</p>
<p>morgan</p>
<p>express的http的访问日志中间件。</p>
<p>newrelic</p>
<p>New Relic是一家给你的应用提供信息的很酷的公司。你可以很简单的加一个包到你服务的第一行，然后去他们的网站观察神奇的事情发生。我们使用它来获取在产品化的服务上发生的错误。</p>
<p>nodemailer</p>
<p>如果你需要发邮件，不需要你自个发-使用一个邮件传输服务，就像SendGird。这个有一些很好的特性，就像给邮件封装一个漂亮的模板。Nodemailer就是一个让我们发生简单信息到SendGird的包。</p>
<p>prerender-node</p>
<p>还记得我们是用Angular吗？这个是用于因为搜索引擎无法解析Angular才用的。带来了陈显的援助，使用这个包，网络爬虫可以更容易的看到一个不是Angular版本的网站因为prerenderer让它发生变化。关闭JavaScript在Web浏览器您再次浏览Croissant，你就会明白我们的意思。</p>
<p>protractor</p>
<p>protractor是一个端对端的测试框架，可以在浏览器里面进行自动化的执行任务和测试</p>
<p>q</p>
<p>async是不错的瀑布楼和映射操作同时，“q”是不错的使用promises的库，通过它，我们意味着使用普通回调函数以及封装成“q”的promise语法。让我们像使用普通回调方式一样使用链式的异步函数，解决“callback hell”。</p>
<p>request</p>
<p>每当一旦我们需要使用http请求来扩展服务时，我们总是使用这个包即时在NodeJS初期，在内部使用扩展服务。</p>
<p>slug</p>
<p>这个是一个转化“Hello There” 到“hello-there”的库，完美的动态的转化标题成友好的链接。</p>
<p>stripe</p>
<p>值得时间考验。Stripe是我们的信用卡支付流程。这个足够好来存储用户的信用卡信息以PCI-compliant方式。我们使用它们的SDK存储卡到文件和支付。</p>
<p>supertest-as-promised</p>
<p>这个是我们核心的智能测试。使用promises让我么会能很容易导出某种响应状态码，同时使用响应数据在下一次测试中，我们在chai里使用。</p>
<p>这样啦，你有了我们的好东西的清单。我们总是会开放的问题，意见和建议。请友善些:)</p>
<p>Dave<br>Co-founder &amp; CEO, Croissant</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/03/Co-Generator-Usage/">Generator库：co的用法</a></h1>
  

      
      <time datetime="2015-09-03T09:41:11.000Z">Sep 3 2015</time>
      
    </header>
    <div class="entry">
      
        <p>什么是Generator？</p>
<p>Generator是ES6里面新增的语法特性，是异步编程的一个语法级的解决方案。Generator在内部封装的多个状态，在执行Generator函数的时候，会返回一个遍历状态的迭代器对象。表现形式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span><span class="params">()</span> </span>{  <span class="comment">//*是Generator一个语法表示</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span>;<span class="comment">//yield 是返回状态的值</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'world'</span>;</div><div class="line">  <span class="keyword">return</span> <span class="string">'ending'</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> hw = helloWorldGenerator();</div><div class="line"></div><div class="line"></div><div class="line">hw.next();  <span class="comment">//在每次执行迭代器对象时，会返回当前获取的状态信息。</span></div><div class="line"><span class="comment">// { value: 'hello', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'world', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'ending', done: true }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: undefined, done: true }</span></div></pre></td></tr></table></figure>

<blockquote>
<p>Generator与协程<br>协程（coroutine）是一种程序运行的方式，可以理解成“协作的线程”或“协作的函数”。协程既可以用单线程实现，也可以用多线程实现。前者是一种特殊的子例程，后者是一种特殊的线程。</p>
<p>（1）协程与子例程的差异</p>
<p>传统的“子例程”（subroutine）采用堆栈式“后进先出”的执行方式，只有当调用的子函数完全执行完毕，才会结束执行父函数。协程与其不同，多个线程（单线程情况下，即多个函数）可以并行执行，但是只有一个线程（或函数）处于正在运行的状态，其他线程（或函数）都处于暂停态（suspended），线程（或函数）之间可以交换执行权。也就是说，一个线程（或函数）执行到一半，可以暂停执行，将执行权交给另一个线程（或函数），等到稍后收回执行权的时候，再恢复执行。这种可以并行执行、交换执行权的线程（或函数），就称为协程。</p>
<p>从实现上看，在内存中，子例程只使用一个栈（stack），而协程是同时存在多个栈，但只有一个栈是在运行状态，也就是说，协程是以多占用内存为代价，实现多任务的并行。</p>
<p>（2）协程与普通线程的差异</p>
<p>不难看出，协程适合用于多任务运行的环境。在这个意义上，它与普通的线程很相似，都有自己的执行上下文、可以分享全局变量。它们的不同之处在于，同一时间可以有多个线程处于运行状态，但是运行的协程只能有一个，其他协程都处于暂停状态。此外，普通的线程是抢先式的，到底哪个线程优先得到资源，必须由运行环境决定，但是协程是合作式的，执行权由协程自己分配。</p>
<p>由于ECMAScript是单线程语言，只能保持一个调用栈。引入协程以后，每个任务可以保持自己的调用栈。这样做的最大好处，就是抛出错误的时候，可以找到原始的调用栈。不至于像异步操作的回调函数那样，一旦出错，原始的调用栈早就结束。</p>
<p>Generator函数是ECMAScript 6对协程的实现，但属于不完全实现。Generator函数被称为“半协程”（semi-coroutine），意思是只有Generator函数的调用者，才能将程序的执行权还给Generator函数。如果是完全执行的协程，任何函数都可以让暂停的协程继续执行。</p>
<p>如果将Generator函数当作协程，完全可以将多个需要互相协作的任务写成Generator函数，它们之间使用yield语句交换控制权。</p>
</blockquote>
<p>co是什么？</p>
<p>co是tj写的一个用于 Generator 函数的自动执行的函数库。最新是4.0版本，支持promise等一些新特性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// yield any promise</span></div><div class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// resolve multiple promises in parallel</span></div><div class="line">  <span class="keyword">var</span> a = Promise.resolve(<span class="number">1</span>);</div><div class="line">  <span class="keyword">var</span> b = Promise.resolve(<span class="number">2</span>);</div><div class="line">  <span class="keyword">var</span> c = Promise.resolve(<span class="number">3</span>);</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</div><div class="line">  <span class="built_in">console</span>.log(res);</div><div class="line">  <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="comment">// errors can be try/catched</span></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="keyword">try</span> {</div><div class="line">    <span class="keyword">yield</span> Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'boom'</span>));</div><div class="line">  } <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="built_in">console</span>.error(err.message); <span class="comment">// "boom"</span></div><div class="line"> }</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(err)</span> </span>{</div><div class="line">  <span class="comment">// log any uncaught errors</span></div><div class="line">  <span class="comment">// co will not throw any errors you do not handle!!!</span></div><div class="line">  <span class="comment">// HANDLE ALL YOUR ERRORS!!!</span></div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>数组方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [</div><div class="line">    Promise.resolve(<span class="number">1</span>),</div><div class="line">    Promise.resolve(<span class="number">2</span>),</div><div class="line">    Promise.resolve(<span class="number">3</span>),</div><div class="line">  ];</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>对象方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> {</div><div class="line">    <span class="number">1</span>: Promise.resolve(<span class="number">1</span>),</div><div class="line">    <span class="number">2</span>: Promise.resolve(<span class="number">2</span>),</div><div class="line">  };</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; { 1: 1, 2: 2 }</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>co(fn*).then( val =&gt; )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">}, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>var fn = co.wrap(fn*)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fn = co.wrap(<span class="function"><span class="keyword">function</span>* <span class="params">(val)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(val);</div><div class="line">});</div><div class="line"></div><div class="line">fn(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line"></div><div class="line">});</div></pre></td></tr></table></figure>


      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/02/Bluebird-Promise-Usage/">Bluebird中Promise模式使用</a></h1>
  

      
      <time datetime="2015-09-02T00:55:32.000Z">Sep 2 2015</time>
      
    </header>
    <div class="entry">
      
        <p><img src="https://camo.githubusercontent.com/f67ead75c0654cefe0c5b791508731cf08cb5b0c/687474703a2f2f7065746b61616e746f6e6f762e6769746875622e696f2f626c7565626972642f6c6f676f2e706e67" alt="bluebird logo"><br>Bluebird是一个高性能全功能的Promise库，主要有以下特性：</p>
<blockquote>
<ul>
<li>实现了Promises A+规范</li>
<li>同步检查(promise状态，返回值，失败原因)</li>
<li>并发调用(调用多个异步处理)</li>
<li>异步模型转化到Promise模式</li>
<li>使用通过并行使用Python/C＃进行资源管理的取消和超时</li>
<li>并行的C#异步和等待</li>
<li>试用的工具方法，如：<br>.bind()<br>.call()<br>Promise.join()…</li>
<li>调试解决方案和合理的默认值</li>
<li>优越的性能表现</li>
</ul>
</blockquote>
<p>bluebird支持node.js和浏览器端</p>
<p>node.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="operator"><span class="keyword">install</span> bluebird</span></div></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Promise = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</div></pre></td></tr></table></figure>

<p>浏览器端支持（ES5）</p>
<p><img src="https://camo.githubusercontent.com/335f3fdee6026df48a9699235b03cd3e6bf3dba9/68747470733a2f2f73617563656c6162732e636f6d2f62726f777365722d6d61747269782f7065746b615f616e746f6e6f762e737667" alt="浏览器支持"></p>
<p>可见对于IE必须是IE9和以上</p>
<p>用法：</p>
<p>下载：<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js" target="_blank" rel="external">bluebird.js</a>或<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js" target="_blank" rel="external">bluebird.min.js</a></p>
<p>以解析一个json文件为例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fs.readFileAsync(<span class="string">"file.json"</span>).then(<span class="built_in">JSON</span>.parse).then(<span class="function"><span class="keyword">function</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(val.success);</div><div class="line">})</div><div class="line">.catch(<span class="built_in">SyntaxError</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"invalid json in file"</span>);</div><div class="line">})</div><div class="line">.catch(<span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"unable to read file"</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>具体需要看详细的可以查看<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">官方github</a></p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/01/JQuery-Deferred-Promise/">JQuery中Deferred/Promise的使用</a></h1>
  

      
      <time datetime="2015-09-01T00:55:27.000Z">Sep 1 2015</time>
      
    </header>
    <div class="entry">
      
        <p>同样Deferred也是为了解决异步嵌套回调而存在的。早在JQuery 1.5就已经支持了。</p>
<p>使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dtd = $.Deferred(); <span class="comment">// 新建一个Deferred对象</span></div><div class="line"><span class="keyword">var</span> wait = <span class="function"><span class="keyword">function</span><span class="params">(dtd)</span></span>{</div><div class="line">    <span class="keyword">var</span> tasks = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">　　　　　　alert(<span class="string">"执行完毕！"</span>);</div><div class="line">　　　　　　dtd.resolve(); <span class="comment">// 改变Deferred对象的执行状态</span></div><div class="line">　　　　};</div><div class="line"></div><div class="line">　　　　setTimeout(tasks,<span class="number">5000</span>);</div><div class="line">　　　　<span class="keyword">return</span> dtd.promise(); <span class="comment">// 返回promise对象</span></div><div class="line">　　};</div><div class="line"><span class="keyword">var</span> d = wait(dtd); <span class="comment">// 新建一个d对象，改为对这个对象进行操作</span></div><div class="line">$.when(d)</div><div class="line"> .done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"哈哈，成功了！"</span>); })</div><div class="line"> .fail(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"出错啦！"</span>); });</div></pre></td></tr></table></figure>

<p>我们看下怎么样用，下面列举了几个场景：</p>
<ol>
<li>单个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$.ajax(<span class="string">'abc.php'</span>).done(<span class="function"><span class="keyword">function</span><span class="params">(result)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>多个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$.when($.ajax(<span class="string">'abc.php'</span>), $.ajax(<span class="string">'abc2.php'</span>), $.ajax(<span class="string">'abc3.php'</span>))</div><div class="line">.done(<span class="function"><span class="keyword">function</span><span class="params">(result1, result2, result3)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>动画链式调用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.when(preloadImage())</div><div class="line">.then(animation01)</div><div class="line">.then(animation02)</div><div class="line">.then(animation03)</div><div class="line">.then(transition)</div><div class="line">.then(merge)</div><div class="line">.then(zoom)</div><div class="line">.then(showContent)</div><div class="line">.then(flicker);</div></pre></td></tr></table></figure>

<p>和Promise/A+的规范有些出入，可能因为实现比较早，但是其意义和原理是差不多的。</p>

      
    </div>
    
      
    
  </div>
</article>





<div class="pagination">
  <table width='100%'>
    <tbody>
    <tr>
      <td width='120' align='left'>
        
      </td>
      <td width='auto' align='center'>
          <a href="/archives/">文章归档</a>
      </td>
      <td width='120' align='right'>
        
        <div class="alignright">
          <a href="/page/2/" class="alignright next">next ›</a>
        </div>
        
      </td>
    </tr>
    </tbody>
  </table>
</div></div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2015 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
