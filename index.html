<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！</title>
  <meta name="author" content="H1bomb">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2016/05/16/iTunes-Api-Usage/">iTunes api的使用说明</a></h1>
  

      
      <time datetime="2016-05-16T00:16:50.000Z">May 16 2016</time>
      
    </header>
    <div class="entry">
      
        <p>最近公司需要跟踪App Store里面应用的舆情，需要获取应用的评论，等其他一些信息。在网上查了下iTunes的接口很少。大体可以分成三种类型：</p>
<ul>
<li>搜索接口（官方提供）</li>
<li>内容聚合接口（官方提供）</li>
<li>通过抓包获取的iTunes页面内的接口（非官方）</li>
</ul>
<p>通过这三种接口，可以大体获取App的一些信息。然后通过定时采集，进行监控和分析。</p>
<h2 id="搜索接口">搜索接口</h2>
<p>主要的调用文档：<a href="https://affiliate.itunes.apple.com/resources/documentation/itunes-store-web-service-search-api/" target="_blank" rel="external">点击这里</a></p>
<p>如：</p>
<blockquote>
<p>可以通过关键字获取iTunes里面所有的内容</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http<span class="variable">s:</span>//itunes.apple.<span class="keyword">com</span>/<span class="built_in">search</span>?term=jack+johnson</div></pre></td></tr></table></figure>

<p>具体的使用还有很多，就不在这个文档里赘述了。</p>
<h2 id="内容聚合接口">内容聚合接口</h2>
<p>官方只是提供一个RSS的链接生成器:<a href="https://rss.itunes.apple.com/us/?urlDesc=%2Fgenerator" target="_blank" rel="external">https://rss.itunes.apple.com/us/?urlDesc=%2Fgenerator</a></p>
<p>&gt;</p>
<ul>
<li>畅销 App 排名</li>
<li>畅销 iPad App 排名</li>
<li>付费 iPad App 排名</li>
<li>免费 App 排名</li>
<li>免费 iPad App 排名</li>
<li>收费 App 排名</li>
<li>新的付费应用程序</li>
<li>新的免费应用程序</li>
</ul>
<p>如果后缀<code>xml</code>则返回xml的数据，<code>json</code>则返回json数据</p>
<p>获取的数据还是比较全局，但是只能获取前100个数据。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http<span class="variable">s:</span>//itunes.apple.<span class="keyword">com</span>/<span class="keyword">cn</span>/rss/topgrossingipadapplications/limit=<span class="number">10</span>/genre=<span class="number">6021</span>/xml</div><div class="line"></div><div class="line">http<span class="variable">s:</span>//itunes.apple.<span class="keyword">com</span>/<span class="keyword">cn</span>/rss/topgrossingipadapplications/limit=<span class="number">10</span>/genre=<span class="number">6021</span>/json</div></pre></td></tr></table></figure>

<p>但是除了RSS生成器里面生成的链接以外还有其他RSS订阅：</p>
<p>评论接口：<br>通过这个接口可以获取前500个评论</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http<span class="variable">s:</span>//itunes.apple.<span class="keyword">com</span>/<span class="keyword">cn</span>/rss/customerreviews/page=<span class="number">1</span>/id=<span class="number">490655927</span>/sortby=mostrecent/json</div></pre></td></tr></table></figure>

<h2 id="iTunes应用的内部接口">iTunes应用的内部接口</h2>
<p>以上是官方提供的接口，如果无法满足获取信息的需求，那只能Hack iTunes应用的接口了，可以通过抓包工具来获取。</p>
<p>以Charles为例子：</p>
<p>因为iTunes的接口为https的，所以需要配置https的Charles的证书</p>
<p>具体的操作可以参考：<a href="http://www.charlesproxy.com/documentation/proxying/ssl-proxying/" target="_blank" rel="external">http://www.charlesproxy.com/documentation/proxying/ssl-proxying/</a></p>
<p>这次主要是抓取了评论接口：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://itunes.apple.com/WebObjects/MZStore.woa/wa/userReviewsRow?<span class="variable">id=</span><span class="number">490655927</span>&<span class="variable">displayable-kind=</span><span class="number">11</span>&<span class="variable">startIndex=</span><span class="number">0</span>&<span class="variable">endIndex=</span><span class="number">100</span>&<span class="variable">sort=</span><span class="number">1</span>&<span class="variable">appVersion=</span>current</div></pre></td></tr></table></figure>

<p>通过这个方式可以获取应用的所有评论，当然也可以获取其他的信息。</p>
<p>在使用这个接口的时候：httpt头必须要带上cookies信息和use-agentx信息。</p>
<p>否则会展示一个跳转iTunes应用的页面。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/11/02/debugging-memory-leaks-node-js-applications/">调试node.js应用的内存泄漏[译]</a></h1>
  

      
      <time datetime="2015-11-02T00:46:52.000Z">Nov 2 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原文：<a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external">http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications</a></p>
<p>有一次，我开着一辆内部是V8双涡轮增压发动机的奥迪，其性能令人难以置信。凌晨3点，我行驶在芝加哥附近没有人的IL-80高速公路，时速达到140MPH。从那时起，“V8”这个术语成为我对高性能的认识。</p>
<blockquote>
<p>Node.js是一个建立在Chrome的JavaScript引擎V8之上的易于快速构建可伸缩的网络应用的平台。</p>
</blockquote>
<p>尽管奥迪的V8非常强大，但仍然限于用你的油箱的容量大小。这同样适用于谷歌的V8引擎 - 在node.js背后的JavaScript引擎。有很多因素使Node.js的性能是难以置信的，<a href="http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js" target="_blank" rel="external">适用于许多应用案例</a>，但是你总是受限于内存堆的大小。当你的Node.js应用程序需要处理更多的请求时，你有两个选择：就是规模垂直或水平扩展。水平扩展意味着你必须运行多个并发的应用程序实例。如果做得对，你最终能够服务更多的请求。垂直扩展意味着你要为你的应用实例提高应用程序的内存使用情况和可用的性能或增加资源。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg" alt="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg"></p>
<p>最近有为我的Toptal（一个开放外包的平台）客户修复一个运行在Node.js上应用程序的内存泄漏问题。该应用程序是一个能够在每一分钟处理成千上万请求的API服务器。最初的应用几乎占据了600MB的RAM，所以我们决定采取热API端来重新实现它们。当你需要服务于许多请求开销变得非常昂贵。</p>
<p>对于新的API，我们选择的restify以及本地的MongoDB的驱动程序和Kue后台服务。听起来像是一个非常轻量级的栈，对不对？其实不然。在高峰负荷新的应用程序实例可以消耗高达270MB的RAM。因此起两个每1X的Heroku Dyno应用实的想法破灭了。</p>
<h2 id="Node-js_内存泄露调试军火库">Node.js 内存泄露调试军火库</h2>
<h3 id="Memwatch">Memwatch</h3>
<p>如果你搜索“如何在node里发现泄露”这个第一个你或许会搜到的工具就是memwatch。原始的包很久以前就被遗弃，不再保留。但是你可以很容易地找到在GitHub上的fork的库的更新版本。该模块是有用的，如果它看到堆增长超过5个连续的垃圾收集，它可以触发泄漏事件。</p>
<h3 id="Heapdump">Heapdump</h3>
<p>伟大的工具，它允许开发人员使用Chrome开发人员工具对Node.js采取堆快照后对其进行检查。</p>
<h3 id="Node-inspector">Node-inspector</h3>
<p>即使是被更为有用的heapdump替代，但它任然可以让你连接到运行的应用程序，采取堆转储，甚至调试，并重新编译在程序运行中。</p>
<h2 id="针对“node-inspector”_的说明">针对“node-inspector” 的说明</h2>
<p>不幸的是，将不能连接到被在Heroku运行生产的应用中，因为不允许信号被发送到运行的进程。然而，Heroku的是不是唯一的托管平台。</p>
<p>为了在实战中体验node-inspector，我们将使用的RESTify编写一个简单的Node.一点点内存泄漏的根源放在js应用程序中。这里所有的实验都是用Node.js v0.12.7和已编译的V8 v3.28.71.19。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = restify.createServer();</div><div class="line"></div><div class="line"><span class="keyword">var</span> tasks = [];</div><div class="line"></div><div class="line">server.pre(<span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  tasks.push(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> req.headers;</div><div class="line">  });</div><div class="line"></div><div class="line">  <span class="comment">// Synchronously get user from session, maybe jwt token</span></div><div class="line">  req.user = {</div><div class="line">    id: <span class="number">1</span>,</div><div class="line">    username: <span class="string">'Leaky Master'</span>,</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  res.send(<span class="string">'Hi '</span> + req.user.username);</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'%s listening at %s'</span>, server.name, server.url);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这个应用有个很简单且明显的内存泄漏。这个tasks的数组在应用的生命周期内引发变慢，并最终导致崩溃。这个问题是，不仅仅是闭包泄漏，而是波及了整个请求对象。</p>
<p>在V8里使用了stop-the-world这种GC策略，因此，这意味着越多的对象在内存中驻留，回收的时间就越长。在下面的日志你可以清楚地看到，在应用程序的生命的开始，平均回收内存是20毫秒，但几十万的请求后，则需要大约230ms。如果这时访问我们的应用程序将不得不等待230ms之久，因为正在GC。你也可以看到每隔几秒钟调用GC，这意味着每隔几秒钟，用户访问我们的应用程序会遇到问题。随着延迟时间增长，直到程序崩溃。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[<span class="number">28093</span>]     <span class="number">7644</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">25.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7717</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7866</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">23.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">8001</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.4</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">633891</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.3</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">635672</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">331.5</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">637508</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div></pre></td></tr></table></figure>

<p>当在启动一个Node.js的应用时加上–trace_gc这个标示，就可以逐行打印这些日志。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">node</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">trace_gc</span> <span class="comment">app</span><span class="string">.</span><span class="comment">js</span></div></pre></td></tr></table></figure>

<p>假设我们已经在这个Node.js的应用设置标示。在连接node-inspector到应用程序之前，我们需要把SIGUSR1信号发送到正在运行的进程。如果在群集中运行Node.js，请确保您连接到其中一个从属进程。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kill</span> -SIGUSR1 <span class="variable">$pid</span> <span class="comment"># Replace $pid with the actual process ID</span></div></pre></td></tr></table></figure>

<p>通过这样做，我们正在让Node.js的应用（准确地说是V8）进入调试模式。在这种模式下，应用自动将打开的端口5858<a href="https://code.google.com/p/v8-wiki/wiki/DebuggerProtocol" target="_blank" rel="external">V8调试协议</a>。</p>
<p>我们下一步运行node-inspector连接到运行应用的调试接口，并打开8080端口的web接口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>node-inspector</div><div class="line"><span class="constant">Node</span> <span class="constant">Inspector</span> v<span class="number">0</span>.<span class="number">12.2</span></div><div class="line"><span class="constant">Visit</span> <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:8080/</span>?ws=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8080</span>&port=<span class="number">5858</span> to start debugging.</div></pre></td></tr></table></figure>

<p>如果应用程序在生产中运行，并且有一个防火墙，我们可以通过隧道远程端口8080到本地主机：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">ssh</span> <span class="tag">-L</span> 8080<span class="pseudo">:localhost</span><span class="pseudo">:8080</span> <span class="tag">admin</span><span class="at_rule">@<span class="keyword">example.com</span></span></div></pre></td></tr></table></figure>

<p>现在，你可以打开你的Chrome网络浏览器即可获得完全的访问连接到远程生产应用程序的Chrome开发工具。不幸的是，Chrome开发人员工具将不能在其他浏览器。</p>
<h2 id="让我们发现泄漏">让我们发现泄漏</h2>
<p>在V8内存泄漏是不是真正的内存泄漏就像我们从C / C++应用程序的理解的那样。在JavaScript变量为空值时并不消失，他们只是“被遗忘”。我们的目标是要找到这些被遗忘的变量，并使这些内存释放。</p>
<p>在Chrome开发工具里我们有多个profiler。我们在记录堆分配而运行，并随着时间的推移需要多堆快照特别感兴趣。这给了我们一个明确的窥视到哪些对象正在泄漏。</p>
<p>开始录制堆分配，让我们模拟使用Apache基准在我们的主页上50个并发用户。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg" alt="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ab -<span class="built_in">c</span> <span class="number">50</span> -n <span class="number">1000000</span> -k http:<span class="comment">//example.com/</span></div></pre></td></tr></table></figure>

<p>在建立新的快照之前，V8将执行标记 - 清除垃圾收集，所以我们肯定知道有没有旧垃圾中的快照。</p>
<h2 id="修复运行中的泄漏">修复运行中的泄漏</h2>
<p>在收集堆分配快照3分钟后，我们得到类似下面的结果</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg" alt="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg"></p>
<p>我们可以清楚地看到，在堆里面有一些巨大的数组，很多IncomingMessage，ReadableState，ServerResponse和域对象。让我们分析下泄漏源。</p>
<p>在从20秒到40秒选择堆差异的图表中，我们只看到它是20秒后开始查看对象。这样，您就可以排除出所有正常的数据。</p>
<p>保持关注每种类型的对象在系统中的数目，我们扩大过滤从20多岁到1分钟。我们可以看到数组已经相当大了，并持续增长。在“（array）”，我们可以看到有很多的对象“（object properties）”具有同等的距离。这些对象是我们的内存泄漏的源头。</p>
<p>此外，我们也可以看到，“（closure）”的对象快速增长。</p>
<p>这可能是很方便的看这些字符串。根据字符串列表中也有很多的“Hi Leaky Master”的短语。这些可能给我们一些线索了。</p>
<p>在我们的例子中，我们知道，字符串“Hi Leaky Master”只能根据“GET/”路由进行组装。</p>
<p>果你打开从属的路径，你会看到这个字符串是通过req莫名其妙地引用，那么就创建的上下文的闭包把这一切都加入到巨型数组里。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg" alt="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg"></p>
<p>所以在这一点上，我们知道有一些闭包的巨大数组。让我们通过这些闭包真正实时的得到源标签里面的名字。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg" alt="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg"></p>
<p>在我们编辑完代码之后，在运行期内我们能按CTRL+S来保存和重新编译代码！</p>
<p>现在我们再来另外录一个堆分配的快照来看下闭包引起的内存保留。</p>
<p>很明显，那些<code>SomeKindOfClojure()</code>就是我们的问题所在。<code>SomeKindOfClojure（）</code>闭包正在添加到一些命名任务到全局空间的数组。</p>
<p>很容易看出，这个数组仅仅是没有用处的。我们可以把它注释掉。但是，我们如何释放已被占用的内存？很容易，我们只分配一个空数组到任务中，然后下一个请求会被覆盖，再则内存将在下一个GC事件之后被释放。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg" alt="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg"></p>
<p>多比自由啦！（出处《哈利波特》）</p>
<h2 id="V8的垃圾回收的生命周期">V8的垃圾回收的生命周期</h2>
<p><img src="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg" alt="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg"></p>
<p>那么，V8 JS本身并没有内存泄漏，只有被遗忘的变量。</p>
<p>V8堆被分成几个不同的空间：</p>
<p>新空间：这个空间相对较小，并且具有1MB-8MB的大小。多数的对象都在这里分配。</p>
<ul>
<li>老的指针空间：有可能有指向其他对象的对象。如果对象存活足够长的新空间也提升为老的指针空间。</li>
<li>老的数据空间：只包含原始数据如字符串，封装的数据和未封装的doubles的数组。在新的空间存在的GC的时间足够长的对象迁移到这里。</li>
<li>大对象空间：它的对象是太大，以适应在其他空间都在这个空间中创建。每个对象都有它自己的内存mmap’ed的区域</li>
<li>代码空间：包含由JIT编译器生成的汇编代码。</li>
<li>单元空间，属性单元空间，map空间：这个空间包含单元，属性单元和Map。这用于简化垃圾收集。</li>
</ul>
<p>每个空间是由页面组成的。一个页面是内存从操作系统的mmap分配的区域。每一页始终是1MB大小，除了大对象空间的页面。</p>
<p>V8有两个内置的垃圾收集机制：清扫，标记清扫和标记压缩。</p>
<p>清扫是一个非常快的垃圾回收技术，在新的空间进行对象操作。清扫的一种实现<a href="http://en.wikipedia.org/wiki/Cheney&#39;s_algorithm" target="_blank" rel="external">Cheney’s Algorithm</a>。概念非常简单，新空间被分成两个相等的各半个空间：到空间和从空间。当去空间满了就发起清扫的GC。它只是从空间和所有活动对象复制到从空间或将其提升到旧空间之一，如果他们经历了两次清扫，然后被完全从空间删除。可清除速度非常快但是他们保持双大小的堆不断在内存中拷贝对象的开销。使用可清除的原因是因为大多数对象早期被回收。</p>
<p>标记清扫和标记压缩是另一种V8垃圾回收的控制方式。另一种满垃圾收集器。它标志着所有活节点，然后清洗全部死的节点并重新整理内存。</p>
<h3 id="GC性能和调试贴士">GC性能和调试贴士</h3>
<p>虽然Web应用程序的高性能可能不是个大问题，你还是会希望不惜一切代价避免泄漏。在full GC的标记阶段的应用程序实际上已暂停，直到垃圾收集完成。这意味着越多的对象在堆中时间越长，执行GC时，越长的用户等待时间。</p>
<h3 id="总是给闭包和函数命名">总是给闭包和函数命名</h3>
<p>所有的闭包和功能有名字的话，很容易检查跟踪堆栈。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">db.query(<span class="string">'GIVE THEM ALL'</span>, <span class="function"><span class="keyword">function</span> <span class="title">GiveThemAllAName</span><span class="params">(error, data)</span> </span>{</div><div class="line">    ...</div><div class="line">})</div></pre></td></tr></table></figure>

<h3 id="避免在热函数上使用大对象">避免在热函数上使用大对象</h3>
<p>理想情况下，你要避免热函数内部的大对象，把所有的数据装配到新的空间。所有的CPU和内存相关的操作应在后台执行。此外，还要避免触发热功能不优化，优化的热函数使用较少的内存比非优化的。</p>
<h3 id="热函数应该被优化">热函数应该被优化</h3>
<p>Hot functions that run faster but also consume less memory cause GC to run less often. V8 provides some helpful debugging tools to spot non-optimized functions or deoptimized functions.<br>如果热函数消耗更少的内存从而减少GC的频率，这样运行速度更快。 V8提供了一些有用的调试工具，以发现没有优化的函数或非优化的函数。</p>
<h2 id="避免多态性IC的热函数">避免多态性IC的热函数</h2>
<p>内部缓存(IC)用于加快执行的一些代码块中，要么通过缓存对象属性访问obj.key或一些简单函数。</p>
<figure class="highlight javscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">(a, b)</span> <span class="comment">{</span></span></div><div class="line">  return a + b;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="title">x</span><span class="params">(1, 2)</span>; <span class="comment">// monomorphic</span></div><div class="line">x(<span class="number">1</span>, “<span class="keyword">string</span>”); <span class="comment">// polymorphic, level 2</span></div><div class="line">x(<span class="number">3.14</span>, <span class="number">1</span>); <span class="comment">// polymorphic, level 3</span></div></pre></td></tr></table></figure>

<p>当<code>x(a,b)</code>第一次运行时，V8创建了一个单态的内部缓存。当你调用x一秒钟，V8移除老的IC，创建一个新的多态的IC来支持整形和字符串的操作。当你再次调用IC，V8重复以上步骤创建了另一个第三级的多态IC。、</p>
<p>然而，层级是有限的。在IC的层级达到5级时（可以改变<code>–max_inlining_levels</code>标示），这个函数将成为多态并且不再可被优化的。</p>
<p>这里直观的理解了单态函数运行速度最快的，也消耗更小的内存占用。</p>
<h3 id="不要把大对象加入内存">不要把大对象加入内存</h3>
<p>这一个是显而易见的，众所周知的。如果具有大的要处理的文件，例如一个大的CSV文件，一行一行的读取并小块处理而不是加载整个文件存储器到内存中。在极少的情况下，CSV单行将超过1MB，才会新分配的空间存放。</p>
<h3 id="不要阻塞主服务线程">不要阻塞主服务线程</h3>
<p>如果你有一些热API需要一些时间来处理，像一个缩放图片的API，单独把它放到一个后台的线程的服务里。CPU密集型操作会阻塞主线程强制所有其他客户等待，保持发送中请求。未处理的请求数据就堆在内存中，从而迫使完整的GC需要更长的时间来完成。</p>
<h3 id="不要创建不必要的数据">不要创建不必要的数据</h3>
<p>我曾经在使用restify有一个奇怪的经历。如果您发送几十万请求无效的URL，那么应用程序的内存将迅速增长就高达百兆字节，直到一个full GC几秒钟后，一切都会恢复正常。原来，为每个无效的URL，restify会生成一个新的错误对象，其中包括长的堆栈跟踪。这迫使新创建的对象被分配在大对象空间里，而不是新生代空间。</p>
<p>获得这样的数据可以在开发过程中非常有帮助的，但显然生产环境中不需要。因此，规则很简单 - 不生成数据，除非你确实需要它。</p>
<h3 id="了解你的工具">了解你的工具</h3>
<p>最后，但当然不是最不重要的，是要了解你的工具。有各种调试器，泄漏cathers和使用情况的图形生成器。所有这些工具可以有助于你的软件更快，更高效。</p>
<h3 id="结论">结论</h3>
<p>理解V8的垃圾回收和代码优化如何工作以及应用性能的关键。V8对JavaScript编译到本地的执行在某些情况下编写的代码实现性能与GCC编译的应用程序相媲美。</p>
<p>而如果你想知道，我的Toptal客户新的API应用程序，虽然还改进的余地，但是已经工作得非常好了！</p>
<p>Joyent公司最近发布的Node.js的新版本，它使用的V8引擎是最新版本之一。针对Node.js的v0.12.x写了一些应用程序可能无法与新的4.x版版本兼容。然而，应用程序将在node.js中的新版本出现了巨大的性能和内存使用情况的改善.</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/29/measuring-javascript-functions-performance/">测量javascript函数的性能[译]</a></h1>
  

      
      <time datetime="2015-09-29T00:57:45.000Z">Sep 29 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址:<a href="http://www.sitepoint.com/measuring-javascript-functions-performance/" target="_blank" rel="external">http://www.sitepoint.com/measuring-javascript-functions-performance</a></p>
<p>性能总是软件中扮演了重要的角色。在网络上，性能是尤为重要，如果我们提供缓慢的网页给用户，我们的用户可以轻松更改网站去访问我们的竞争对手的网站。作为一个专业的web开发者，我们不得不把这个问题考虑在内。很多老的网络性能优化的最佳实践，就像请求最小化，使用CDN，不写渲染代码块，如今还是管用的。然而，越来越多的web应用在使用Javascript，验证我们的代码是快的是很重要的。</p>
<p>假如你有一个正在运行的函数，但是你怀疑这个函数运行没有足够快，同时你计划着要改进这个函数。如何证明你的假设呢？什么是当今测试函数性能的最贱实践呢？一般来说，最好实现这个任务的方式是使用函数内建的<code>performance.now()</code>来测量在你执行函数前后的时间。</p>
<p>在这篇文章我们将会讨论如何测量代码执行时间和避免一些常见的坑的技术。</p>
<p><code>Performance.now()</code><br>高精度计时接口提供的一个方法，名字叫<code>now()</code>的可以返回一个DOM高精度时间戳对象。提供了一个浮点小数反映当前时间毫秒到毫秒的千分之一的时间戳。分别，这些数据没有添加过多的值来提供你分析，但是两个不同的数字之间的差值可以描述所消耗多少时间。</p>
<p>事实上它比内置的日期对象更准确,并且是‘单调’的。意味着，简单来说，是不会受到系统的影响（像你的笔记本操作系统）周期性地校正系统时间。在更简单来说，定义的两个日期实例计算出的插值并不表示所有消耗的时间。</p>
<p>“单调”的数学定义式是（一个函数或数量）不同的方式进行不是增加就是减少。</p>
<p>另一种方式的解释，可以尝试想象下这一年之中当时钟前进或后退。例如，当时钟在的你的国家由于需要提高白天的日照，从而把时间跳过一小时，如果你创建时间实例在这个时间回退一小时之前，另一个时间实例在这个之后，将会看到不同内容就像“1小时3秒123毫秒”。如果使用两个<code>performance.now()</code>实例，会是”3秒123毫秒456789千分之一毫秒”。</p>
<p>在这个章节，我不会讲这些API的详情。所以如果你要看更多关于如何使用，我建议你去看下<a href="http://www.sitepoint.com/discovering-the-high-resolution-time-api/" target="_blank" rel="external">探索高精度计时API</a>这个文章。</p>
<p>现在你已经知道了什么是高精度计时API和如何使用，让我们深入探讨一些潜在的问题。但在这之前，我们定义一个叫<code>makeHash()</code>的函数来用于我本文的其余部分的介绍。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHash</span><span class="params">(source)</span> </span>{</div><div class="line">  <span class="keyword">var</span> hash = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (source.length === <span class="number">0</span>) <span class="keyword">return</span> hash;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) {</div><div class="line">    <span class="keyword">var</span> char = source.charCodeAt(i);</div><div class="line">    hash = ((hash&lt;&lt;<span class="number">5</span>)-hash)+char;</div><div class="line">    hash = hash & hash; <span class="comment">// 转化到32的整形</span></div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>执行这个函数像如下的测量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> result = makeHash(<span class="string">'Peter'</span>);</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>如果你在浏览器里运行，你应该可以看到像如下的结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>运行的例子如下：</p>
<iframe id="cp_embed_YXmdNJ" src="//codepen.io/SitePoint/embed/YXmdNJ?height=350&amp;theme-id=6441&amp;slug-hash=YXmdNJ&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>通过这个例子，来开始我们的讨论</p>
<p>陷阱 #1 - 不小心测量了不重要的事情<br>在这个例子里，你能在<code>performance.now()</code>之间只做一件事并且其他的函数调用<code>makeHash()</code>,并指定其值设置为一个变量的结果。我们需要执行该功能，没有别的时间。这个测量详细如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(makeHash(<span class="string">'Peter'</span>));  <span class="comment">// bad idea!</span></div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_PqMXWv" src="//codepen.io/SitePoint/embed/PqMXWv?height=350&amp;theme-id=6441&amp;slug-hash=PqMXWv&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>在这个例子里，我们将会测试<code>makeHash(&#39;Peter&#39;)</code>调用所消耗的时间，多长在发送和打印输出在控制台。我们不知道多久这两个操作分别的时间消耗。你只知道一起的时间。它需要发送和打印输出的时间将很大程度上取决于浏览器，甚至取决于当时正在进行什么。</p>
<p>也许你完全知道的console.log是不可预测的消耗时间。但它是将执行多个功能同样是错误，即使各功能不涉及任何的I/O。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> name = <span class="string">'Peter'</span>;</div><div class="line"><span class="keyword">var</span> result = makeHash(name.toLowerCase()).toString();</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>同样，我们不知道的执行时间是如何分布的。变量赋值是<code>toLowerCase（）</code>的调用，还是<code>toString（）</code>的调用？</p>
<p>陷阱 #2 - 只测量一次<br>另一个通常会犯的错误只是一次测量，总体所花费的时间在这个基础上的结论。很可能是在不同的时间完全不同的。执行的时间很大程度取决于多种因素：</p>
<ul>
<li>编译器预热的时间（如 编译代码到字节码的时间）</li>
<li>主线程是忙着做我们并没有意识到要去其他的东西，</li>
<li>你的计算机的CPU（S）是忙于的其他事情而减慢你的整个浏览器上增量改进的重复执行的功能。</li>
</ul>
<p>像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">}</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, ((t1 - t0) / <span class="number">10</span>).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate'</span>);</div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_Qbezpj" src="//codepen.io/SitePoint/embed/Qbezpj?height=350&amp;theme-id=6441&amp;slug-hash=Qbezpj&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>这种方法的风险是，我们的浏览器的JavaScript引擎可能使用了子优化，这意味着第二次函数调用相同的输入，也可以从中受益记住第一输出，并简单地使用了第一次的输出。为了解决这个问题，你可以使用重复发送，在相同的输入字符串（例如：’Peter’）的多种不同的输入字符串代替。显然，随着测试与不同的输入，问题是正在测量功能需要不同的时间量。也许有些的输入导致比其他的输入更长的执行时间。</p>
<p>陷阱 #3 - 过分依赖的平均<br>在上一章节中，我们了解到，多次运行的东西，最好有不同的输入这种好的实践。但是，我们必须记住，使用不同的输入的问题是，执行可能需要比所有其它输入要长得多。因此，让我们退后一步，并发送相同的输入。假设我们发送相同的输入十次，并为每个，打印出来多久了。输出可能是这个样子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0234</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0200</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0281</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0162</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0245</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0677</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0289</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0240</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0311</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>注意为什么第一次的数据是和其他九次完全不同。最有可能的，这是因为在我们的浏览器的JavaScript引擎使用一些子优化，需要一些预热。还有一点，我们可以做，以避免这一点，但也有一些我们可以考虑，以防止有错误的结论很好的补救措施。</p>
<p>一种方法是计算最后九次的平均值。另一个更实际的方法是收集所有结果和计算一个中位数。基本上，它是所有的结果一字排开，排序顺序和采摘中间的一个。这个<code>performance.now（）</code>是非常有用的，因为你会得到一个有用的数据。</p>
<p>使用中位值函数再尝试下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> numbers = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  <span class="keyword">var</span> t0 = performance.now();</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">  <span class="keyword">var</span> t1 = performance.now();</div><div class="line">  numbers.push(t1 - t0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Median time'</span>, median(numbers).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>陷阱 #4 - 在可预知的顺序中比较函数<br>我们已经明白，测量多次，取平均值是个好主意。此外，上一章节的例子告诉我们，可以使用优选平均的中值来代替。</p>
<p>现在，事实上，一个很好用的测量函数执行时间的方法是比较哪些函数更快。假设我们有两个函数，把相同类型的输入，并产生相同的结果，但在内部，他们的工作方式不同。</p>
<p>比方说，我们希望有一个功能，在不区分大小写情况下某个字符串是在字符串数组返回true，否则返回false。换句话说，我们不能用Array.prototype.indexOf，因为需要不区分大小写。这里有一个这样的实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>立即我们注意到，因为<code>haystack.forEach</code>循环可以使用一个早期匹配元素来改善替代。让我们尝试用好的老的写法，for循环的版本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>现在我们可以看下哪个更快。我们每个函数进行十次测量并收集测试结果:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn1</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn2</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">measureFunction</span><span class="params">(func)</span> </span>{</div><div class="line">  <span class="keyword">var</span> letters = <span class="string">'a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z'</span>.split(<span class="string">','</span>);</div><div class="line">  <span class="keyword">var</span> numbers = [];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; letters.length; i++) {</div><div class="line">    <span class="keyword">var</span> t0 = performance.now();</div><div class="line">    func(letters, letters[i]);</div><div class="line">    <span class="keyword">var</span> t1 = performance.now();</div><div class="line">    numbers.push(t1 - t0);</div><div class="line">  }</div><div class="line">  <span class="built_in">console</span>.log(func.name, <span class="string">'took'</span>, median(numbers).toFixed(<span class="number">4</span>));</div><div class="line">}</div><div class="line"></div><div class="line">measureFunction(isIn1);</div><div class="line">measureFunction(isIn2);</div></pre></td></tr></table></figure>

<p>运行下得到如下的输出：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line">isIn1 took <span class="number">0.0050</span></div><div class="line">isIn2 took <span class="number">0.0150</span></div></pre></td></tr></table></figure>

<p>直接可以运行的代码片段demo如下：</p>
<iframe id="cp_embed_YXmdZJ" src="//codepen.io/SitePoint/embed/YXmdZJ?height=350&amp;theme-id=6441&amp;slug-hash=YXmdZJ&amp;default-tab=js&amp;user=SitePoint" scrolling="no" frameborder="0" height="350" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe undefined" style="width: 100%; overflow: hidden;"></iframe>

<p>刚刚发生了什么？第一个功能是快三倍。这是不应该发生的！</p>
<p>原因很简单，但是很微妙。第一个功能，使用了haystack.forEach得益于在浏览器的JavaScript引擎的一些低级别的优化，当我们使用数组索引去做，就不会被优化。这证明了我们的观点：如果你不测量，你永远不知道！</p>
<p>结论<br>在我们试图如何使用<code>performance.now（）</code>取得JavaScript的一个准确的执行时间，我们偶然发现了一个基准场景，我们的实证研究结果得出结论和我们的直觉完全相反。问题的关键是，如果你想写得更快的Web应用程序，JavaScript代码就需要优化。由于电脑（差不多）是活生生的东西，令人如此的不可预知。最可靠的方法就是通过衡量和比较来改进代码确保更快的执行速度。</p>
<p>另一个原因，我们永远不知道这些代码是更快的，因为不同的上下文中，我们有做同一件事的多种方式。在上一节中，我们执行不区分大小写字符串搜索寻找除其他26个字符串。如果我们10万名中匹配字符串，该结论可能是完全不同的。</p>
<p>上述例子并不完整，还有更多的陷阱，以做到心中有数。例如，测量不现实的场景或仅测量在一个JavaScript引擎。但肯定的是，谁想要写出更快，更好的Web应用程序,开发者就可以使用<code>performance.now（）</code>这个不错的协助。最后但并非最不重要的，请记住，测试执行时间只产生了“更好的代码”的一个方面。还有内存和代码的复杂性考虑，要牢记。</p>
<p>现在你这么想？你有没有用这个功能来测试你的代码的性能？如果没有，你怎么在这个阶段进行？请在下面的评论中分享你的看法。让我们开始讨论！</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/25/yo-todo-list-note/">todos用yo来实现的说明</a></h1>
  

      
      <time datetime="2015-09-25T00:28:02.000Z">Sep 25 2015</time>
      
    </header>
    <div class="entry">
      
        <p>本文档的目的是通过一个todos的例子讲下如何用yo进行前端开发，包含开发流程全过程，涵盖：开发，构建，测试，调试，部署。规范前端开发的工作流，后续会补充单元测试的部分。</p>
<h2 id="中间使用到的工具和框架">中间使用到的工具和框架</h2>
<h3 id="服务端：">服务端：</h3>
<ul>
<li>yo（express，一些必要的中间件）</li>
<li>npm（安装node模块）</li>
</ul>
<h3 id="客户端：">客户端：</h3>
<ul>
<li>sea.js(客户端依赖包处理)</li>
<li>SPM（客户端依赖包管理）</li>
<li>gulp（项目构建，js，css，预处理，合并，压缩，部署）</li>
<li>compass（css预编译）</li>
<li>npm（工具依赖管理）</li>
</ul>
<h2 id="目录结构：">目录结构：</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">yo.todo</div><div class="line"> <span class="string">|_client  客户端目录</span></div><div class="line"> <span class="string">|  |_js   前端js源码目录</span></div><div class="line"> <span class="string">|  |_sass sass源码目录</span></div><div class="line"> <span class="string">|  |_index.js  前端js的入口文件</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（依赖包）</span></div><div class="line"> <span class="string">|  |_gulpfile.js  项目构建gulp脚本</span></div><div class="line"> <span class="string">|_server  服务端目录</span></div><div class="line"> <span class="string">|  |_adapters  接口适配业务代码目录</span></div><div class="line"> <span class="string">|  |_interface  接口配置文件目录</span></div><div class="line"> <span class="string">|  |_stub  后端桩代码目录</span></div><div class="line"> <span class="string">|  |_views 视图目录</span></div><div class="line"> <span class="string">|  |_app.js  应用入口文件</span></div><div class="line"> <span class="string">|  |_staticConfig.js 静态文件路径配置</span></div><div class="line"> <span class="string">|  |_package.json  项目构建文件（服务端端）</span></div><div class="line"> <span class="string">|_public  静态资源目录（用于开发，测试阶段）</span></div><div class="line">    <span class="string">|_css</span></div><div class="line">    <span class="string">|_sea.js 依赖seajs</span></div></pre></td></tr></table></figure>

<h2 id="服务初始化的过程：">服务初始化的过程：</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:700px; height:500px;" src="https://www.processon.com/embed/55fd7ef8e4b00fa66f1009b7"></iframe>

<h2 id="请求调用过程">请求调用过程</h2>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:670px; height:320px;" src="https://www.processon.com/embed/55fe57eae4b00fa66f125212"></iframe>

<h2 id="开发步骤">开发步骤</h2>
<p>准备：</p>
<ul>
<li>安装必要的开发工具,当然先得安装node.js,具体参考<a href="https://nodejs.org/" target="_blank" rel="external">这里</a>。</li>
<li>安装compass,先安装ruby，参考<a href="http://www.ruanyifeng.com/blog/2012/11/compass.html" target="_blank" rel="external">这里</a></li>
<li>安装spm,运行<code>npm install spm@3.4.3 -g</code>（spm3.4.3之后使用了webpack，所以暂时用3.4.3）。</li>
<li>安装gulp，运行<code>npm install gulp -g</code>(如果安装了cnpm，可以替代npm)。</li>
<li>安装slush，运行<code>npm install slush -g</code>（用于创建空项目）。</li>
<li>安装slush-yo,运行<code>npm install slush-yo -g</code>(yo项目模板)。</li>
</ul>
<h3 id="新建一个空项目">新建一个空项目</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir todos</div><div class="line">slush yo</div><div class="line">cd client</div><div class="line">spm <span class="operator"><span class="keyword">install</span></span></div><div class="line">npm <span class="keyword">install</span></div><div class="line">cd <span class="keyword">server</span></div><div class="line">npm <span class="keyword">install</span></div></pre></td></tr></table></figure>

<p>在mac或者ubuntu上需要用<code>sudo</code>。</p>
<p>运行空项目：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis-<span class="keyword">server</span> -port <span class="number">7777</span></div><div class="line"></div><div class="line">node app</div></pre></td></tr></table></figure>

<p>可以看到如图：<br><img src="http://7mj4k1.com1.z0.glb.clouddn.com/0416BFD2-66BD-4DAA-9246-33ED700FDCE1.png" alt="运行成功"></p>
<h3 id="编写服务接口配置">编写服务接口配置</h3>
<p>需要存储todo list的服务，这个例子数据和状态主要保存服务端，</p>
<ul>
<li>添加一个todo;</li>
<li>编辑一个todo;</li>
<li>获取todo列表；</li>
<li>切换todo的状态；</li>
<li>删除todo；</li>
<li>清除已完成的todo；</li>
</ul>
<p>代码如下：</p>
<p>server/stub/router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list = [];</div><div class="line"><span class="keyword">var</span> toggleAll = <span class="literal">false</span>;</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{</div><div class="line"></div><div class="line">    <span class="comment">//添加</span></div><div class="line">    app.post(<span class="string">'/todo'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (req.body.todo) {</div><div class="line">            list.push({</div><div class="line">                id: uuid(),</div><div class="line">                todo: req.body.todo,</div><div class="line">                state: <span class="number">0</span></div><div class="line">            });</div><div class="line">            res.send(ret(<span class="literal">true</span>));</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            res.send(ret(<span class="literal">false</span>));</div><div class="line">        }</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//编辑保存</span></div><div class="line">    app.put(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> saved = <span class="literal">false</span>,</div><div class="line">            state;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    setval(req.body.todo, req.body.state, list[i]);</div><div class="line">                    saved = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(saved));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//首页</span></div><div class="line">    app.get(<span class="string">'/todos'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> data = ret(<span class="literal">true</span>, list);</div><div class="line">        res.send(data);</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//删除</span></div><div class="line">    app.delete(<span class="string">'/todo/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> isDel = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span> (req.params.id) {</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">                <span class="keyword">if</span> (req.params.id === list[i].id) {</div><div class="line">                    list.splice(i, <span class="number">1</span>);</div><div class="line">                    isDel = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        res.send(ret(isDel));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//切换状态</span></div><div class="line">    app.put(<span class="string">'/todos/toggleall'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (!toggleAll) {</div><div class="line">                list[i].state = <span class="number">1</span>;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                list[i].state = <span class="number">0</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        toggleAll = !toggleAll;</div><div class="line">        res.send(ret(<span class="literal">true</span>));</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">//清除完成项</span></div><div class="line">    app.delete(<span class="string">'/todos/completed'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">        <span class="keyword">var</span> unCompleted = [];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) {</div><div class="line">            <span class="keyword">if</span> (list[i].state === <span class="number">0</span>) {</div><div class="line">                unCompleted.push(list[i]);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        list = unCompleted;</div><div class="line">        <span class="keyword">return</span> res.send(ret(<span class="literal">true</span>, list));</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>

<p>可以用postman类似的http客户端测试下服务：</p>
<p><img src="http://7wy47w.com1.z0.glb.clouddn.com/C031899C-515A-455E-9013-D5126B1ABDAE.png" alt="postman"></p>
<h3 id="编写前端view对应后端服务的接口配置和接口适配">编写前端view对应后端服务的接口配置和接口适配</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">exports.domain = <span class="string">'http://localhost:3000'</span>;</div><div class="line">exports.res =</div><div class="line">    [{</div><div class="line">    route: <span class="string">'/'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    params: []</div><div class="line">}, {</div><div class="line">    route: <span class="string">'/:state'</span>,</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    view: <span class="string">'pages/index'</span>,</div><div class="line">    url: <span class="string">'/todos/'</span>,</div><div class="line">    adapter: <span class="string">'index'</span>,</div><div class="line">    params: []</div><div class="line">}];</div></pre></td></tr></table></figure>

<p>目前的todo的view只有一个，为了使不同状态的匹配加了”/:state”的路由。<br>后端映射到同一个接口。</p>
<p>后端服务也许无法满足你前端展示的要求，所以，会在适配层，加一些返回数据结构的处理。<br>适配层的业务注入规约：会找到interface的路由作为注入的原则（路由名称+请求方法），或者指定路由的适配的业务模块。<br>代码如下（server/adapters/index.js）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">exports.get = <span class="function"><span class="keyword">function</span><span class="params">(data, req, res)</span> </span>{</div><div class="line">    <span class="keyword">var</span> states = [<span class="string">'active'</span>, <span class="string">'completed'</span>];</div><div class="line">    <span class="keyword">var</span> curState = <span class="string">'all'</span>;</div><div class="line">    <span class="keyword">var</span> curStateVal = <span class="number">3</span>;</div><div class="line">    data.completedTodos = <span class="literal">false</span>; <span class="comment">//完成的todos</span></div><div class="line">    data.activeTodoWord = <span class="string">'items'</span>;<span class="comment">//todo单位的单复数</span></div><div class="line">    data.activeTodoCount = <span class="number">0</span>;<span class="comment">//当前未完成todo</span></div><div class="line">    data.allCount = data.data.length;<span class="comment">//所有的todo数量</span></div><div class="line">    data.module = <span class="string">'todos'</span>;<span class="comment">//js的入口模块</span></div><div class="line">    <span class="keyword">var</span> curData = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; states.length; j++) { <span class="comment">//判断过滤条件</span></div><div class="line">        <span class="keyword">if</span> (states[j] === req.proxyParams.params.state) {</div><div class="line">            curState = states[j];</div><div class="line">            curStateVal = j;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            curState = <span class="string">'all'</span>;</div><div class="line">            curStateVal = <span class="number">3</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    data[curState] = <span class="literal">true</span>; <span class="comment">//设置当前的过滤条件</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.data.length; i++) {</div><div class="line">        <span class="keyword">if</span> (data.data[i].state === <span class="number">1</span>) { <span class="comment">//设置是否有完成</span></div><div class="line">            data.completedTodos = <span class="literal">true</span>;</div><div class="line">            data.data[i].completed = <span class="literal">true</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            data.activeTodoCount++; <span class="comment">//设置todo的数据</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (data.data[i].state === curStateVal) {</div><div class="line">            curData.push(data.data[i]); <span class="comment">//过滤数据</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (curStateVal !== <span class="number">3</span>) { <span class="comment">//设置过滤后的数据</span></div><div class="line">        data.data = curData;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.activeTodoCount === <span class="number">1</span>) { <span class="comment">//设置展示单复数</span></div><div class="line">        data.activeTodoWord = <span class="string">'item'</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="编写模板">编写模板</h3>
<p>拆解页面结构：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">layout</div><div class="line">  <span class="command">\_</span>header</div><div class="line">  <span class="command">\_</span>todo</div><div class="line">    <span class="command">\_</span>header</div><div class="line">    <span class="command">\_</span>section</div><div class="line">    <span class="command">\_</span>footer</div><div class="line">    <span class="command">\_</span>bottom</div><div class="line">  <span class="command">\_</span>footer</div></pre></td></tr></table></figure>

<p>其中，header，todo/header,todo/section,todo/footer,todo/bottom,footer都是partials<br>采用handlebars模板编写。<br>当前后端返回数据时，在前端进行数据绑定生成HTML。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/78F31156-3915-4DBB-847C-FFF611125C2C.png" alt="没有样式的视图"></p>
<h3 id="编写css样式">编写css样式</h3>
<p>编写样式采用compass的方式，用compass watch，实时编译成css。</p>
<p>到client目录，直接<code>compass watch</code></p>
<p>可以按照partials，拆分样式。<br>配置生成文件，在config.rb,或者使用gulp进行的构建。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/B9B70361-8948-411C-908F-00B503DDB8B2.png" alt="添加样式后"></p>
<h3 id="编写JS前端逻辑">编写JS前端逻辑</h3>
<p>前端需要操作服务端的todo的内容，并且展现，主要是增删查改这些操作，同时绑定相关的事件。这个例子里面使用jquery和pjax等，所以需要在<code>client</code>下的<code>package.json</code>,添加依赖包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">"spm"</span>: {</div><div class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: {</div><div class="line">    <span class="string">"jquery"</span>: <span class="string">"1.8.3"</span>,</div><div class="line">    <span class="string">"jquery-pjax-183"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">    <span class="string">"nprogress-183"</span>: <span class="string">"0.1.6"</span>,</div><div class="line">    <span class="string">"import-style"</span>: <span class="string">"1.0.0"</span></div><div class="line">  },</div><div class="line"> ...</div></pre></td></tr></table></figure>

<p>需要执行<code>spm install</code>。</p>
<p>前端的主要逻辑在<code>js/todos.js</code>里面，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * todos</div><div class="line"> *</div><div class="line"> * todos的前端代码</div><div class="line"> * 只提交todo的操作，服务端维护todo状态</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</div><div class="line"><span class="keyword">var</span> NProgress = <span class="built_in">require</span>(<span class="string">'nprogress-183'</span>);</div><div class="line"><span class="built_in">require</span>(<span class="string">'jquery-pjax-183'</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 初始化Pjax</div><div class="line"> *</div><div class="line"> * @return void</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initPjax</span><span class="params">()</span> </span>{</div><div class="line">    $(<span class="built_in">document</span>).pjax(<span class="string">'a'</span>, <span class="string">'#pjax-container'</span>);</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.start();</div><div class="line">    });</div><div class="line"></div><div class="line">    $(<span class="built_in">document</span>).on(<span class="string">'pjax:end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        NProgress.done();</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> ENTER_KEY = <span class="number">13</span>; <span class="comment">//回车键</span></div><div class="line"><span class="keyword">var</span> ESCAPE_KEY = <span class="number">27</span>; <span class="comment">//esc键</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> $newTodoInput = $(<span class="string">"#new-todo"</span>), <span class="comment">//新建一个todo</span></div><div class="line">    $listLi = $(<span class="string">"#todo-list li"</span>), <span class="comment">//列表单元</span></div><div class="line">    $listToggle = $(<span class="string">"#todo-list .toggle"</span>), <span class="comment">//切换todo状态</span></div><div class="line">    $listLiEdit = $(<span class="string">"#todo-list .edit"</span>), <span class="comment">//编辑输入</span></div><div class="line">    $toggleall = $(<span class="string">"#toggle-all"</span>), <span class="comment">//切换所有的todo状态</span></div><div class="line">    $listDestroy = $(<span class="string">"#todo-list .destroy"</span>), <span class="comment">//删除todo</span></div><div class="line">    $clearCompleted = $(<span class="string">"#clear-completed"</span>); <span class="comment">//清除完成的</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 界面操作对象</div><div class="line"> * @type {Object}</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> actions = {</div><div class="line">    toggleAll: {</div><div class="line">        url: <span class="string">'/todos/toggleall'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $toggleall</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    add: {</div><div class="line">        url: <span class="string">'/todo'</span>,</div><div class="line">        method: <span class="string">'POST'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $newTodoInput,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    actions.add.data = {</div><div class="line">                        todo: $(e.target).val() + <span class="string">''</span></div><div class="line">                    };</div><div class="line">                    $(e.target).val(<span class="string">''</span>);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    edit: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'PUT'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">var</span> state = elem.parents(<span class="string">'li'</span>).find(<span class="string">'.toggle'</span>).attr(<span class="string">'checked'</span>) ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.data = {</div><div class="line">                todo: elem.parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(),</div><div class="line">                state: state</div><div class="line">            };</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listToggle</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'dblclick'</span>,</div><div class="line">            elem: $listLi,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> $input = $(e.target).closest(<span class="string">'li'</span>).addClass(<span class="string">'editing'</span>).find(<span class="string">'.edit'</span>);</div><div class="line">                $input.val($input.val()).focus();</div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line">        }, {</div><div class="line">            event: <span class="string">'keyup'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> val = e.target.value;</div><div class="line">                <span class="keyword">if</span> (e.which === ENTER_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line"></div><div class="line">                    $(e.target).parents(<span class="string">'li'</span>).find(<span class="string">'label'</span>).text(val);</div><div class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (e.which === ESCAPE_KEY) {</div><div class="line">                    $(e.target).blur();</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">        }, {</div><div class="line">            event: <span class="string">'blur'</span>,</div><div class="line">            elem: $listLiEdit,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                $(e.target).parents(<span class="string">'li'</span>).removeClass(<span class="string">'editing'</span>);</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    remove: {</div><div class="line">        url: <span class="string">'/todo/'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        before: <span class="function"><span class="keyword">function</span><span class="params">(elem)</span> </span>{</div><div class="line">            <span class="keyword">this</span>.params = elem.parents(<span class="string">'li'</span>).attr(<span class="string">'data-id'</span>);</div><div class="line">        },</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $listDestroy,</div><div class="line">            handle: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            }</div><div class="line">        }]</div><div class="line">    },</div><div class="line">    clearCompleted: {</div><div class="line">        url: <span class="string">'/todos/completed'</span>,</div><div class="line">        method: <span class="string">'DELETE'</span>,</div><div class="line">        eventHandle: [{</div><div class="line">            event: <span class="string">'click'</span>,</div><div class="line">            elem: $clearCompleted</div><div class="line">        }]</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 事件绑定操作</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">()</span> </span>{</div><div class="line">    $.each(actions, <span class="function"><span class="keyword">function</span><span class="params">(key, value)</span> </span>{</div><div class="line">        $.each(value.eventHandle, <span class="function"><span class="keyword">function</span><span class="params">(index, hb)</span> </span>{</div><div class="line">            hb.elem.live(hb.event, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">                <span class="keyword">var</span> isSend = <span class="literal">false</span>;</div><div class="line">                <span class="keyword">if</span> (hb.handle) {</div><div class="line">                    isSend = hb.handle(e);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    isSend = <span class="literal">true</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">if</span> (isSend) {</div><div class="line">                    <span class="keyword">if</span> (value.before) {</div><div class="line">                        value.before($(e.target));</div><div class="line">                    }</div><div class="line">                    send(value);</div><div class="line">                }</div><div class="line">            });</div><div class="line">        });</div><div class="line">    });</div><div class="line">    initPjax();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 发送操作信息</div><div class="line"> * @param  {Object} hb</div><div class="line"> * @return {void}</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">(hb)</span> </span>{</div><div class="line">    <span class="keyword">var</span> url = hb.url + (hb.params || <span class="string">''</span>);</div><div class="line">    $.ajax({</div><div class="line">        url: url,</div><div class="line">        type: hb.method,</div><div class="line">        data: hb.data ? hb.data : <span class="literal">null</span>,</div><div class="line">        dataType: <span class="string">"json"</span></div><div class="line">    }).done(<span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (data.opts) {</div><div class="line">            $.pjax.reload(<span class="string">'#pjax-container'</span>);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            alert(<span class="string">'something wrong!'</span>);</div><div class="line">        }</div><div class="line">    }).fail(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">        alert(<span class="string">'something wrong!'</span>);</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">bind();</div></pre></td></tr></table></figure>

<h3 id="整理联调">整理联调</h3>
<p>代码编写完成后，可以通过<code>gulp start</code>,进行代码联调。<br>看看有没有问题，修复开发过程中疏漏的点。在yo中，如果是开发环境，会自动启用smp的服务，对于拆散js的组合调用，可以用chrome dev tool进行前端调试，后端调试，可以使用<code>npm install -g node-inspector</code>,用<code>node-debug app.js</code>进行服务端的代码调试。<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/EE3F2819-9B70-4DF3-88F1-AB171750DD97.png" alt="chrome dev tool"></p>
<p>服务端的express传参，和变量数据，可以通过<code>express-debug</code>查看<br><img src="http://7wy47w.com1.z0.glb.clouddn.com/99C72E62-EC9C-4357-89B6-43902ACA9E34.png" alt="express-debug"></p>
<h3 id="构建项目">构建项目</h3>
<p>到此为止，已经把todos的功能已全部实现但是，工作流程，才走了一半，后面将会执行构建，将现有的项目，部署到测试环境，当测试环境测试没有问题，讲发布到生产。</p>
<p>而做这些事情，可以由gulp来完成，gulp可以编写管道式的构建过程，高效的将需要的自动化过程执行。<br>目前前端的gulp涉及如下的任务：</p>
<ul>
<li>运行server</li>
<li>compass的实时预处理</li>
<li>js的合并和库文件的合并</li>
<li>样式的合并</li>
<li>部署到CDN</li>
</ul>
<p>代码清单详见：client/gulpfile.js。</p>
<h4 id="测试代码打包">测试代码打包</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp</div></pre></td></tr></table></figure>

<p>测试环境运行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ..</div><div class="line">NODE_ENV=test node server/app</div></pre></td></tr></table></figure>

<h4 id="生产环境发布和运行">生产环境发布和运行</h4>
<p>把代码部署到CDN</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> client</div><div class="line">gulp dist</div></pre></td></tr></table></figure>

<p>运行生产环境,需要保证服务不会挂掉，所以需要使用MP2来进行进程守护，以及服务监控和治理。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ..</div><div class="line">NODE_ENV=production pm2 <span class="operator"><span class="keyword">start</span> <span class="keyword">server</span>/app</span></div></pre></td></tr></table></figure>

<h2 id="后续补充工作流">后续补充工作流</h2>
<ul>
<li>单元测试</li>
<li>持续集成</li>
<li>代码检查</li>
</ul>
<h2 id="后续待做事项">后续待做事项</h2>
<ul>
<li>组件化</li>
<li>前后端分离（接口规范）</li>
<li>docker化</li>
</ul>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/13/Render-HTML-From-Client-Or-Server/">服务端或客户端生成HTML的设计思想</a></h1>
  

      
      <time datetime="2015-09-13T03:53:49.000Z">Sep 13 2015</time>
      
    </header>
    <div class="entry">
      
        <p>如果说web前端主要是由：HTML,CSS,JavaScript这些技术的组合，那么HTML的生成，可以由服务端或者客户端去渲染，取决于数据和HTML的绑定在哪个端去执行。</p>
<p>当是SPA（Single Page Application）形态的应用时：天然的使HTML的生成或则说DOM生成可以由前端完成，大量的路由逻辑，界面逻辑都在浏览器端完成。主要是服务端提供“服务接口+数据响应”，浏览器端调用“服务接口”，数据绑定到视图渲染（可以是DOM生成或者HTML生成并修改DOM），以及路由视图的跳转。</p>
<p>SPA有一个问题需要解决，那就是如何做SEO，主要问题是两个：一个是URL友好，一个响应HTML结构语义化。</p>
<p>解决办法：</p>
<ol>
<li>url友好</li>
</ol>
<p>url友好，在SPA的大部分前端界面跳转都相对映射的URL（当然如果使用一些前端框架也实现了URL变化，如Angular，React-Router，vue-router），除非把url的变化考虑进去，使用Hash，或者HMTL5的history的push state接口，来改变url。</p>
<p>现有的大部分SPA的前端框架都有前端url路由功能，所以实现这个，难度不大。</p>
<ol>
<li>响应HTML结构语义化 </li>
</ol>
<p>如果数据在客户端绑定并渲染视图，在对于大多数搜索引擎的爬虫无法理解在客户端渲染的DOM，所以最好在服务端生成HTML。</p>
<p>针对SPA，如比较目前比较通用的有类似<a href="http://prerender.io/" target="_blank" rel="external">Prerender.io</a>，<a href="http://www.brombone.com/" target="_blank" rel="external">brombone</a>，<a href="http://www.seo4ajax.com/" target="_blank" rel="external">seojs</a>的服务，原理是：</p>
<ul>
<li>当一个搜索引擎的爬虫访问你的应用程序并且看到<code>&lt;meta name=&quot;fragment&quot; content=&quot;!&quot;&gt;</code>时，它会在你的URL中添加一个<code>?_escaped_fragment_=tag</code>。</li>
<li>你的服务器将会拦截这个请求，并把它发送给一个用来处理这个特殊的爬虫请求的中间件。在这篇文章中，我们选用Prerender.io，因此，下一步是针对Prerender.io的。</li>
<li>Prerender.io 将会检查请求的页面是否有一个现存的快照（或者缓存的页面），如果有，它会将这个页面响应给爬虫，如果没有的话，他会调用PhantomJS(一个服务端渲染DOM的中间键)来渲染这个完整页面，并将它响应给爬虫。</li>
</ul>
<p>优点：这个的做法的好处是和语言无关，比较解耦，可以和不同的后端语言结合使用。可以单独部署一组SEO的服务器来应对爬虫的访问，对于用户访问影响不大。</p>
<p>缺点：PhantomJS在生成界面的时候，比较消耗服务器资源，同时时间较长，需要做生成界面的缓存，以及页面缓存的更新。</p>
<p>SPA大量在现有互联网的使用，即将到来，只是现在囿于低版本IE浏览器的制约，约束在浏览器的发展。尽管现有前端框架都有优雅降级的做法，但是在大量低版本IE的用户面前，目前是无法大规模使用的。</p>
<p>主要原因：</p>
<ol>
<li>低版本IE(6,7,8)对于ES5的支持(Object.defineProperty)，甚至ES6的支持。</li>
<li>低版本IE(6,7,8)对CSS,DOM不是按照标准去理解的。</li>
<li>低版本IE(6,7,8)JS引擎性能较差，对于重度依赖Javascript的SPA会有性能瓶颈或编码不慎会导致无故内存泄露。</li>
</ol>
<p>但是还是比较看好SPA在浏览器的发展，毕竟新版的IE，以及其他的现代浏览器已经不存在以上的问题了，只是时间问题了。</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/12/7-Reasons-to-Upgrade-to-Node-v4-Now/">现在升级到Node V4的七个理由</a></h1>
  

      
      <time datetime="2015-09-12T15:36:53.000Z">Sep 12 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html" target="_blank" rel="external">http://www.cli-nerd.com/2015/09/09/7-reasons-to-upgrade-to-node-v4-now.html</a></p>
<p>今天<a href="https://nodejs.org/en/blog/release/v4.0.0/" target="_blank" rel="external">Node v4</a>发布了。这是第一个在io.js合并后的<br>第一个稳定版本，给我们带来了一堆亮点，如新的ES6语法的添加。虽然有已经增加了很好的ES6的描述，但是这篇文章展示了如何使用它们！</p>
<p>特别是，我要去以下ES6补充的地址看看：</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">Template Strings</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">Classes</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">Arrow Functions</a><br><a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">Object Literals</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="external">Promises</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_6_support_in_Mozilla#Additions_to_the_String_object" target="_blank" rel="external">String Methods</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">let and const</a></p>
<h2 id="1-_Template_Strings(模板字符串)">1. Template Strings(模板字符串)</h2>
<p>如果你要用Javascript创建多行字符串，你或许会像下面的做法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = [</div><div class="line">    <span class="string">'The quick brown fox'</span>,</div><div class="line">    <span class="string">'jumps over'</span>,</div><div class="line">    <span class="string">'the lazy dog'</span></div><div class="line">].join(<span class="string">'\n'</span>);</div></pre></td></tr></table></figure>

<p>虽然这适用于少量的文字，但会多个语句变得混乱。因此，聪明的开发者想出了一个叫hack called multiline的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> multiline = <span class="built_in">require</span>(<span class="string">'multiline'</span>);</div><div class="line"><span class="keyword">var</span> message = multiline(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{<span class="comment">/*</span></div><div class="line">    The quick brown fox</div><div class="line">    jumps over</div><div class="line">    the lazy dog</div><div class="line">*/});</div></pre></td></tr></table></figure>

<p>幸运的是，ES6给我们带来了模板字符串：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> message = `</div><div class="line">    The quick brown fox</div><div class="line">        jumps over</div><div class="line">        the lazy dog</div><div class="line">`;</div></pre></td></tr></table></figure>

<p>在这个特性里，还可以进行字符串的赋值操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> name = <span class="string">'Schroedinger'</span>;</div><div class="line"></div><div class="line"><span class="comment">// stop doing this ...</span></div><div class="line"><span class="keyword">var</span> message = <span class="string">'Hello '</span> + name + <span class="string">', how is your cat?'</span>;</div><div class="line"><span class="keyword">var</span> message = [<span class="string">'Hello '</span>, name, <span class="string">', how is your cat?'</span>].join(<span class="string">''</span>);</div><div class="line"><span class="keyword">var</span> message = <span class="built_in">require</span>(<span class="string">'util'</span>).format(<span class="string">'Hello %s, how is your cat?'</span>, name);</div><div class="line"></div><div class="line"><span class="comment">// and instead do that ...</span></div><div class="line"><span class="keyword">var</span> message = `Hello ${name}, how is your cat?`;</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="external">查看更多template strings的详情在MDN</a>.</p>
<h2 id="2-_Classes（类）">2. Classes（类）</h2>
<p>定义类ES5看起来有些奇怪，还需要一定的时间去习惯：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Pet = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    <span class="keyword">this</span>._name = name;</div><div class="line">};</div><div class="line"></div><div class="line">Pet.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(Pet.prototype, <span class="string">'name'</span>, {</div><div class="line">  get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">  }</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> Cat = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> </span>{</div><div class="line">    Pet.call(<span class="keyword">this</span>, name);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'util'</span>).inherits(Cat, Pet);</div><div class="line"></div><div class="line">Cat.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    Pet.prototype.sayHello.call(<span class="keyword">this</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">};</div></pre></td></tr></table></figure>


<p>幸运的是，在Node中我们可以使用新的ES6语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Pet {</div><div class="line">    constructor(name) {</div><div class="line">        <span class="keyword">this</span>._name = name;</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'*scratch*'</span>);</div><div class="line">    }</div><div class="line">    get name() {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._name;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class</span> Cat extends Pet {</div><div class="line">    constructor(name) {</div><div class="line">        super(name);</div><div class="line">    }</div><div class="line">    sayHello() {</div><div class="line">        super.sayHello();</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'miaaaauw'</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>一个extends关键字，constructors，调用父类和属性。多好？<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="external">更多在MDN有完整的指南</a></p>
<h2 id="3-_Arrow_Functions(箭头函数)">3. Arrow Functions(箭头函数)</h2>
<p>动态的绑定函数调用的结合总是会引起一些混乱，人们在多个方面围绕它的工作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        self.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(listener)</span> </span>{</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    }.bind(<span class="keyword">this</span>));</div><div class="line">};</div></pre></td></tr></table></figure>

<p>现在只需要使用箭头函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Cat.prototype.notifyListeners = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>._listeners.forEach((listener) =&gt; {</div><div class="line">        <span class="keyword">this</span>.notifyListener(listener);</div><div class="line">    });</div><div class="line">};</div></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">查看arrow functions更多详情</a>.</p>
<h2 id="4-_Object_Literals(对象直接量)">4. Object Literals(对象直接量)</h2>
<p>当使用对象直接量，你可以使用很不错的快捷方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> age = <span class="number">10</span>, name = <span class="string">'Petsy'</span>, size = <span class="number">32</span>;</div><div class="line"></div><div class="line"><span class="comment">// instead of this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age: age,</div><div class="line">    name: name,</div><div class="line">    size: size</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// ... do this ...</span></div><div class="line"><span class="keyword">var</span> cat = {</div><div class="line">    age,</div><div class="line">    name,</div><div class="line">    size</div><div class="line">};</div></pre></td></tr></table></figure>

<p>此外，您现在可以轻松的<a href="https://github.com/lukehoban/es6features#enhanced-object-literals" target="_blank" rel="external">将函数添加到您的对象直接量上</a>。</p>
<h2 id="5-_Promises">5. Promises</h2>
<p>可以替换掉用第三方的像bluebird和Q的依赖，直接使用原生的promises。就像如下的api：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Promise(<span class="function"><span class="keyword">function</span> <span class="params">(resolve, reject)</span> </span>{});</div><div class="line"><span class="keyword">var</span> p2 = Promise.resolve(<span class="number">20</span>);</div><div class="line"><span class="keyword">var</span> p3 = Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>());</div><div class="line"><span class="keyword">var</span> p4 = Promise.all(p1, p2);</div><div class="line"><span class="keyword">var</span> p5 = Promise.race(p1, p2);</div><div class="line"></div><div class="line"><span class="comment">// and obviously</span></div><div class="line">p1.then(() =&gt; {}).catch(() =&gt; {});</div></pre></td></tr></table></figure>

<h2 id="6-_String_Methods">6. String Methods</h2>
<p>我们还可以使用一些新的字符串工具方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// replace `indexOf()` in a number of cases</span></div><div class="line">name.startsWith(<span class="string">'a'</span>)</div><div class="line">name.endsWith(<span class="string">'c'</span>);</div><div class="line">name.includes(<span class="string">'b'</span>);</div><div class="line"></div><div class="line"><span class="comment">// repeat the string three times</span></div><div class="line">name.repeat(<span class="number">3</span>);</div></pre></td></tr></table></figure>

<p>去告诉那些写ruby的孩子！字符串现在还更好的支持unicode的处理。</p>
<h2 id="7-_let_and_const">7. let and const</h2>
<p>猜下这个在如下函数调用后返回的值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">var</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; undefined</span></div></pre></td></tr></table></figure>

<p>是的，undefined。替换掉var，使用let你可以保证预期的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> x = <span class="number">20</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (x === <span class="number">20</span>) {</div><div class="line">        <span class="keyword">let</span> x = <span class="number">30</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">}()); <span class="comment">// -&gt; 20</span></div></pre></td></tr></table></figure>

<p>理由是：var是函数作用域级的，然而let是块作用域级别的（这是人们所希望）。因为这个，说let是安全的var。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let" target="_blank" rel="external">你可以在MDN上获取更多关于let的信息</a>。</p>
<p>新增：Node现在支持const关键字，从而阻止您重新赋给一个不同的值相同的引用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> MY_CONST = <span class="number">42</span>; <span class="comment">// no, no</span></div><div class="line"><span class="keyword">const</span> MY_CONST = <span class="number">42</span>; <span class="comment">// yes, yes</span></div><div class="line"></div><div class="line">MY_CONST = <span class="number">10</span> <span class="comment">// with const, this is no longer possible</span></div></pre></td></tr></table></figure>

<p>综述所述</p>
<p>Node v4带来了更多的ES6的特性，同时我也希望这些7个例子已经使你信服升级和使用最新版本了。</p>
<p>这些更多的语言特性（像 maps/sets, symbols , generators,等）。请确保你已经查看过ES6补充的NodeV4概述。快乐升级！</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/11/40-npm-modules-we-can-t-live-without/">40个我们不可或缺的NPM包[译]</a></h1>
  

      
      <time datetime="2015-09-11T00:15:14.000Z">Sep 11 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a" target="_blank" rel="external">https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a</a></p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Cv7F9UtBMhsrcV2_rwqEgA.png" alt="npm picture"></p>
<p>Croissant按照字母顺序分享了他们用到的40个不可或缺的NPM模块：</p>
<p>agenda</p>
<p>这是一个类似于“cron”的作业，如每隔几分钟做一些事情。</p>
<p>agenda-ui</p>
<p>可视化的界面，用于管理agenda的作业，就像麦当劳的订单界面，让员工知道订单的状态。</p>
<p>async</p>
<p>用于对多个异步一次处理，主要用于异步编程，尽管我们也开始迁移到”q”,但是我们任然在一些地方使用，像“waterfall”和“each”对于一行数据在多数据相互依赖操作，会用到。</p>
<p>aws-sdk</p>
<p>我们用于上传文件到AWS S3上。</p>
<p>bcryptjs</p>
<p>担心你的密码的安全性？不用了！该算法是行业标准。即使我们遭受过黑客攻击，您的密码将仍然只是字母和符号混合的字符串。只要你的密码不是一个简单字典中的单词，虽然，因为如果有人没有得到这个数据，他们可以尝试在字典中的所有单词进行暴力破解。</p>
<p>body-parser</p>
<p>我们使用ExpressJS，所以我们需要序列化那些JSON的响应。</p>
<p>braintree</p>
<p>用于支付的一个智能（支付网关）依赖包。（国内用到不多）</p>
<p>chai</p>
<p>我们使用这个用于集成测试。（一个断言库）</p>
<p>compression</p>
<p>另一个像Express一样，你需要的包。用于压缩服务的响应，让数据在网络上传输更快。好东西。</p>
<p>express</p>
<p>这是个大魔法师。这是一个ExpressJS和NodeJS的web服务的核心模块，让我们可以不用写了大量的样板HTTP服务器代码。带来了一些很酷的特性，如指定一个静态目录作为一个简单的文件服务器，当然，以从它的充满活力的社区，创建的许多插件，可以很容易使用。</p>
<p>forever</p>
<p>如果一个node进程或者express服务崩溃了怎么办？这个小家伙会在后台为你重新启动。这实在是太聪明 - 你可以指定运行多久失败需要重新启动。这可以防止重启一遍又一遍自动失败进程。</p>
<p>fs-extra</p>
<p>当“fs”模块不够用时，“fs-extra”给你想要的更多功能。我们真的只是用它来满足使一个嵌套的文件夹如果在父文件夹不存在创建的能力。出于某种原因，对于“fs”来说，这是过分的要求。</p>
<p>gm</p>
<p>这个模块是一种法术。GraphicsMagick是一个包装已经由来已久的被用于许多图像操纵的很经典ImageMagick的C库。我们使用对上传图片的尺寸缩放和切图操作。你知道的那些放在AWS美丽场馆我们，我们会对它们用这个处理。</p>
<p>gulp</p>
<p>Gulp总是在我们编码背后运行着。它会自动的压缩我们的javascript和css文件。我们把它用于测试运行。它也有很多的包（如果你要找的话）！有人说它像“grunt”，其实是流运行的。</p>
<p>gulp-angular-templatecache</p>
<p>之前我们提到用Angular吗？我们是用Angular的。这个gulp插件允许我们在所有的HTML模板为一个文件以便更快的加载网站。Angular在加载页面时可以使用这些模板。</p>
<p>gulp-concat</p>
<p>记得我们前面谈到的呗？这需要找下。用于合并文件。</p>
<p>gulp-csso</p>
<p>做css最小化的。</p>
<p>gulp-istanbul</p>
<p>一个运行istanbul的单元测试覆盖率的gulp插件。</p>
<p>gulp-livereload</p>
<p>前端开发者的必备，可以连接你的浏览器当每一次文件修改它会刷新页面。做得好，gulp。</p>
<p>gulp-mocha</p>
<p>用于测试，这个插件封装了mocha，我们可以智能的进行测试，就像保证接口端可以正常运行。</p>
<p>gulp-plumber</p>
<p>由于我们所有事情用gulp的流和管道，我们需要一个小小的库，万一像gulp-csso运行失败，可以保证其他运行平滑。</p>
<p>gulp-sass</p>
<p>你以为我们使用CSS？ 再想一想。你看到的一切曾经是一个轻量的，顶尖的，SCSS（又名Sass）文件。Gulp 监听和编译每当我们作出改变时编译我们出主要的CSS的输出..超级快！</p>
<p>gulp-uglify</p>
<p>最后但并非最不重要的，这一插件确实不错的压缩前端JavaScript代码，所以我们可以超快速和超安全传输给你。</p>
<p>jwt-simple</p>
<p>JWT(JSON Web Token) 编码和解码的node包.</p>
<p>lodash</p>
<p>有用的Javascript的工具集，pick, omit, contains对于接口服务器响应时间大大缩短。</p>
<p>mime-types</p>
<p>用于跟踪文件扩展名的库，一个jpg图片文件得到的结果如“image/jpeg”。</p>
<p>mocha</p>
<p>mocha是一个测试平台，可以使用BDD的方式测试，使用“describe”和“it”，没有比这更简单的Javascript的测试了。 </p>
<p>moment</p>
<p>人性化的时间格式。</p>
<p>moment-timezone</p>
<p>moment的时区转化</p>
<p>mongoose</p>
<p>我们提到我们用MongoDB的？我们使用MongoDB的。Mongoose一直我们的团队所熟知，让我们总能看到一眼我们的数据结构是什么。没有它，你可能最终与各种数据库中的对象，造成谁知道什么样的混乱的后端和前端的。</p>
<p>morgan</p>
<p>express的http的访问日志中间件。</p>
<p>newrelic</p>
<p>New Relic是一家给你的应用提供信息的很酷的公司。你可以很简单的加一个包到你服务的第一行，然后去他们的网站观察神奇的事情发生。我们使用它来获取在产品化的服务上发生的错误。</p>
<p>nodemailer</p>
<p>如果你需要发邮件，不需要你自个发-使用一个邮件传输服务，就像SendGird。这个有一些很好的特性，就像给邮件封装一个漂亮的模板。Nodemailer就是一个让我们发生简单信息到SendGird的包。</p>
<p>prerender-node</p>
<p>还记得我们是用Angular吗？这个是用于因为搜索引擎无法解析Angular才用的。带来了陈显的援助，使用这个包，网络爬虫可以更容易的看到一个不是Angular版本的网站因为prerenderer让它发生变化。关闭JavaScript在Web浏览器您再次浏览Croissant，你就会明白我们的意思。</p>
<p>protractor</p>
<p>protractor是一个端对端的测试框架，可以在浏览器里面进行自动化的执行任务和测试</p>
<p>q</p>
<p>async是不错的瀑布楼和映射操作同时，“q”是不错的使用promises的库，通过它，我们意味着使用普通回调函数以及封装成“q”的promise语法。让我们像使用普通回调方式一样使用链式的异步函数，解决“callback hell”。</p>
<p>request</p>
<p>每当一旦我们需要使用http请求来扩展服务时，我们总是使用这个包即时在NodeJS初期，在内部使用扩展服务。</p>
<p>slug</p>
<p>这个是一个转化“Hello There” 到“hello-there”的库，完美的动态的转化标题成友好的链接。</p>
<p>stripe</p>
<p>值得时间考验。Stripe是我们的信用卡支付流程。这个足够好来存储用户的信用卡信息以PCI-compliant方式。我们使用它们的SDK存储卡到文件和支付。</p>
<p>supertest-as-promised</p>
<p>这个是我们核心的智能测试。使用promises让我么会能很容易导出某种响应状态码，同时使用响应数据在下一次测试中，我们在chai里使用。</p>
<p>这样啦，你有了我们的好东西的清单。我们总是会开放的问题，意见和建议。请友善些:)</p>
<p>Dave<br>Co-founder &amp; CEO, Croissant</p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/03/Co-Generator-Usage/">Generator库：co的用法</a></h1>
  

      
      <time datetime="2015-09-03T09:41:11.000Z">Sep 3 2015</time>
      
    </header>
    <div class="entry">
      
        <p>什么是Generator？</p>
<p>Generator是ES6里面新增的语法特性，是异步编程的一个语法级的解决方案。Generator在内部封装的多个状态，在执行Generator函数的时候，会返回一个遍历状态的迭代器对象。表现形式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span><span class="params">()</span> </span>{  <span class="comment">//*是Generator一个语法表示</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span>;<span class="comment">//yield 是返回状态的值</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'world'</span>;</div><div class="line">  <span class="keyword">return</span> <span class="string">'ending'</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> hw = helloWorldGenerator();</div><div class="line"></div><div class="line"></div><div class="line">hw.next();  <span class="comment">//在每次执行迭代器对象时，会返回当前获取的状态信息。</span></div><div class="line"><span class="comment">// { value: 'hello', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'world', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'ending', done: true }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: undefined, done: true }</span></div></pre></td></tr></table></figure>

<blockquote>
<p>Generator与协程<br>协程（coroutine）是一种程序运行的方式，可以理解成“协作的线程”或“协作的函数”。协程既可以用单线程实现，也可以用多线程实现。前者是一种特殊的子例程，后者是一种特殊的线程。</p>
<p>（1）协程与子例程的差异</p>
<p>传统的“子例程”（subroutine）采用堆栈式“后进先出”的执行方式，只有当调用的子函数完全执行完毕，才会结束执行父函数。协程与其不同，多个线程（单线程情况下，即多个函数）可以并行执行，但是只有一个线程（或函数）处于正在运行的状态，其他线程（或函数）都处于暂停态（suspended），线程（或函数）之间可以交换执行权。也就是说，一个线程（或函数）执行到一半，可以暂停执行，将执行权交给另一个线程（或函数），等到稍后收回执行权的时候，再恢复执行。这种可以并行执行、交换执行权的线程（或函数），就称为协程。</p>
<p>从实现上看，在内存中，子例程只使用一个栈（stack），而协程是同时存在多个栈，但只有一个栈是在运行状态，也就是说，协程是以多占用内存为代价，实现多任务的并行。</p>
<p>（2）协程与普通线程的差异</p>
<p>不难看出，协程适合用于多任务运行的环境。在这个意义上，它与普通的线程很相似，都有自己的执行上下文、可以分享全局变量。它们的不同之处在于，同一时间可以有多个线程处于运行状态，但是运行的协程只能有一个，其他协程都处于暂停状态。此外，普通的线程是抢先式的，到底哪个线程优先得到资源，必须由运行环境决定，但是协程是合作式的，执行权由协程自己分配。</p>
<p>由于ECMAScript是单线程语言，只能保持一个调用栈。引入协程以后，每个任务可以保持自己的调用栈。这样做的最大好处，就是抛出错误的时候，可以找到原始的调用栈。不至于像异步操作的回调函数那样，一旦出错，原始的调用栈早就结束。</p>
<p>Generator函数是ECMAScript 6对协程的实现，但属于不完全实现。Generator函数被称为“半协程”（semi-coroutine），意思是只有Generator函数的调用者，才能将程序的执行权还给Generator函数。如果是完全执行的协程，任何函数都可以让暂停的协程继续执行。</p>
<p>如果将Generator函数当作协程，完全可以将多个需要互相协作的任务写成Generator函数，它们之间使用yield语句交换控制权。</p>
</blockquote>
<p>co是什么？</p>
<p>co是tj写的一个用于 Generator 函数的自动执行的函数库。最新是4.0版本，支持promise等一些新特性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// yield any promise</span></div><div class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// resolve multiple promises in parallel</span></div><div class="line">  <span class="keyword">var</span> a = Promise.resolve(<span class="number">1</span>);</div><div class="line">  <span class="keyword">var</span> b = Promise.resolve(<span class="number">2</span>);</div><div class="line">  <span class="keyword">var</span> c = Promise.resolve(<span class="number">3</span>);</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</div><div class="line">  <span class="built_in">console</span>.log(res);</div><div class="line">  <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="comment">// errors can be try/catched</span></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="keyword">try</span> {</div><div class="line">    <span class="keyword">yield</span> Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'boom'</span>));</div><div class="line">  } <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="built_in">console</span>.error(err.message); <span class="comment">// "boom"</span></div><div class="line"> }</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(err)</span> </span>{</div><div class="line">  <span class="comment">// log any uncaught errors</span></div><div class="line">  <span class="comment">// co will not throw any errors you do not handle!!!</span></div><div class="line">  <span class="comment">// HANDLE ALL YOUR ERRORS!!!</span></div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>数组方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [</div><div class="line">    Promise.resolve(<span class="number">1</span>),</div><div class="line">    Promise.resolve(<span class="number">2</span>),</div><div class="line">    Promise.resolve(<span class="number">3</span>),</div><div class="line">  ];</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>对象方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> {</div><div class="line">    <span class="number">1</span>: Promise.resolve(<span class="number">1</span>),</div><div class="line">    <span class="number">2</span>: Promise.resolve(<span class="number">2</span>),</div><div class="line">  };</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; { 1: 1, 2: 2 }</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>co(fn*).then( val =&gt; )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">}, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>var fn = co.wrap(fn*)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fn = co.wrap(<span class="function"><span class="keyword">function</span>* <span class="params">(val)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(val);</div><div class="line">});</div><div class="line"></div><div class="line">fn(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line"></div><div class="line">});</div></pre></td></tr></table></figure>


      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/02/Bluebird-Promise-Usage/">Bluebird中Promise模式使用</a></h1>
  

      
      <time datetime="2015-09-02T00:55:32.000Z">Sep 2 2015</time>
      
    </header>
    <div class="entry">
      
        <p><img src="https://camo.githubusercontent.com/f67ead75c0654cefe0c5b791508731cf08cb5b0c/687474703a2f2f7065746b61616e746f6e6f762e6769746875622e696f2f626c7565626972642f6c6f676f2e706e67" alt="bluebird logo"><br>Bluebird是一个高性能全功能的Promise库，主要有以下特性：</p>
<blockquote>
<ul>
<li>实现了Promises A+规范</li>
<li>同步检查(promise状态，返回值，失败原因)</li>
<li>并发调用(调用多个异步处理)</li>
<li>异步模型转化到Promise模式</li>
<li>使用通过并行使用Python/C＃进行资源管理的取消和超时</li>
<li>并行的C#异步和等待</li>
<li>试用的工具方法，如：<br>.bind()<br>.call()<br>Promise.join()…</li>
<li>调试解决方案和合理的默认值</li>
<li>优越的性能表现</li>
</ul>
</blockquote>
<p>bluebird支持node.js和浏览器端</p>
<p>node.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="operator"><span class="keyword">install</span> bluebird</span></div></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Promise = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</div></pre></td></tr></table></figure>

<p>浏览器端支持（ES5）</p>
<p><img src="https://camo.githubusercontent.com/335f3fdee6026df48a9699235b03cd3e6bf3dba9/68747470733a2f2f73617563656c6162732e636f6d2f62726f777365722d6d61747269782f7065746b615f616e746f6e6f762e737667" alt="浏览器支持"></p>
<p>可见对于IE必须是IE9和以上</p>
<p>用法：</p>
<p>下载：<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js" target="_blank" rel="external">bluebird.js</a>或<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js" target="_blank" rel="external">bluebird.min.js</a></p>
<p>以解析一个json文件为例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fs.readFileAsync(<span class="string">"file.json"</span>).then(<span class="built_in">JSON</span>.parse).then(<span class="function"><span class="keyword">function</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(val.success);</div><div class="line">})</div><div class="line">.catch(<span class="built_in">SyntaxError</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"invalid json in file"</span>);</div><div class="line">})</div><div class="line">.catch(<span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"unable to read file"</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>具体需要看详细的可以查看<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">官方github</a></p>

      
    </div>
    
      
    
  </div>
</article>




  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/01/JQuery-Deferred-Promise/">JQuery中Deferred/Promise的使用</a></h1>
  

      
      <time datetime="2015-09-01T00:55:27.000Z">Sep 1 2015</time>
      
    </header>
    <div class="entry">
      
        <p>同样Deferred也是为了解决异步嵌套回调而存在的。早在JQuery 1.5就已经支持了。</p>
<p>使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dtd = $.Deferred(); <span class="comment">// 新建一个Deferred对象</span></div><div class="line"><span class="keyword">var</span> wait = <span class="function"><span class="keyword">function</span><span class="params">(dtd)</span></span>{</div><div class="line">    <span class="keyword">var</span> tasks = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">　　　　　　alert(<span class="string">"执行完毕！"</span>);</div><div class="line">　　　　　　dtd.resolve(); <span class="comment">// 改变Deferred对象的执行状态</span></div><div class="line">　　　　};</div><div class="line"></div><div class="line">　　　　setTimeout(tasks,<span class="number">5000</span>);</div><div class="line">　　　　<span class="keyword">return</span> dtd.promise(); <span class="comment">// 返回promise对象</span></div><div class="line">　　};</div><div class="line"><span class="keyword">var</span> d = wait(dtd); <span class="comment">// 新建一个d对象，改为对这个对象进行操作</span></div><div class="line">$.when(d)</div><div class="line"> .done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"哈哈，成功了！"</span>); })</div><div class="line"> .fail(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"出错啦！"</span>); });</div></pre></td></tr></table></figure>

<p>我们看下怎么样用，下面列举了几个场景：</p>
<ol>
<li>单个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$.ajax(<span class="string">'abc.php'</span>).done(<span class="function"><span class="keyword">function</span><span class="params">(result)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>多个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$.when($.ajax(<span class="string">'abc.php'</span>), $.ajax(<span class="string">'abc2.php'</span>), $.ajax(<span class="string">'abc3.php'</span>))</div><div class="line">.done(<span class="function"><span class="keyword">function</span><span class="params">(result1, result2, result3)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>动画链式调用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.when(preloadImage())</div><div class="line">.then(animation01)</div><div class="line">.then(animation02)</div><div class="line">.then(animation03)</div><div class="line">.then(transition)</div><div class="line">.then(merge)</div><div class="line">.then(zoom)</div><div class="line">.then(showContent)</div><div class="line">.then(flicker);</div></pre></td></tr></table></figure>

<p>和Promise/A+的规范有些出入，可能因为实现比较早，但是其意义和原理是差不多的。</p>

      
    </div>
    
      
    
  </div>
</article>





<div class="pagination">
  <table width='100%'>
    <tbody>
    <tr>
      <td width='120' align='left'>
        
      </td>
      <td width='auto' align='center'>
          <a href="/archives/">文章归档</a>
      </td>
      <td width='120' align='right'>
        
        <div class="alignright">
          <a href="/page/2/" class="alignright next">next ›</a>
        </div>
        
      </td>
    </tr>
    </tbody>
  </table>
</div></div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2016 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
