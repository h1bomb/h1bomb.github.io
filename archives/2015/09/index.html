<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！ › archive_b</title>
  <meta name="author" content="H1bomb">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">2015/9</h2>


<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/06/measuring-javascript-functions-performance/">测量javascript函数的性能[译]</a></h1>
  

      
      <time datetime="2015-09-06T00:49:32.000Z">Sep 6 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址:<a href="http://www.sitepoint.com/measuring-javascript-functions-performance/" target="_blank" rel="external">http://www.sitepoint.com/measuring-javascript-functions-performance</a></p>
<p>Performance has always played a crucial part in software. On the web, performance is even more important as our users can easily change website and visit one of our competitors if we offer them slow pages. As professional web developers, we have to take this issue into account. A lot of old web performance optimization best practices, such as minimizing requests, using a CDN and not writing rendering blocking code, still apply today. However, as more and more web apps are using JavaScript, it’s important to verify that our code is fast.</p>
<p>Suppose that you have a working function but you suspect it’s not as fast as it could be, and you have a plan to improve it. How do you prove this assumption? What’s the best practice for testing the performance of JavaScript functions today? Generally, the best way to achieve this task is to use the built-in <code>performance.now()</code> function and measure the time before and after your function executes.</p>
<p>In this article we’ll discuss how to measure code execution time and techniques to avoid some common pitfalls.</p>
<p><code>Performance.now()</code><br>The High Resolution Time API offers a function, named <code>now()</code> that returns a DOMHighResTimeStamp object. It’s a floating point number that reflects the current time in milliseconds accurate to a thousandth of a millisecond. Individually, the number doesn’t add much value to your analysis, but a difference between two such numbers gives an accurate description of how much time has passed.</p>
<p>In addition to the fact that it is more accurate than the built-in Date object, it’s also “monotonic”. That means, in simple terms, that it’s not affected by the system (e.g. your laptop OS) periodically correcting the system time. In even simpler terms, defining two instances of Date and calculating the difference isn’t representative of the time that has passed.</p>
<p>The mathematical definition of “monotonic” is (of a function or quantity) varying in such a way that it either never decreases or never increases.</p>
<p>Another way of explaining it, is by trying to imagine using it around the times of the year when the clocks go forward or go back. For example, when the clocks in your country all agree to skip an hour for the sake of maximizing daytime sunshine. If you were to make a Date instance before clocks go back an hour, and another Date instance afterwards, looking at the difference it would say something like “1 hour and 3 seconds and 123 milliseconds”. With two instances of performance.now() the difference would be “3 seconds 123 milliseconds and 456789 thousands of a millisecond”.</p>
<p>In this section, I won’t cover this API in detail. So if you want to learn more about it and see some example of its use, I suggest you to read the article Discovering the High Resolution Time API.</p>
<p>Now that you know what the High Resolution Time API is and how to use it, let’s delve into some potential pitfalls. But before doing so, let’s define a function called makeHash() that we’ll use for the remainder of the article.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHash</span><span class="params">(source)</span> </span>{</div><div class="line">  <span class="keyword">var</span> hash = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (source.length === <span class="number">0</span>) <span class="keyword">return</span> hash;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; source.length; i++) {</div><div class="line">    <span class="keyword">var</span> char = source.charCodeAt(i);</div><div class="line">    hash = ((hash&lt;&lt;<span class="number">5</span>)-hash)+char;</div><div class="line">    hash = hash & hash; <span class="comment">// Convert to 32bit integer</span></div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>The execution of such function can be measured as shown below:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> result = makeHash(<span class="string">'Peter'</span>);</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>If you run this code in a browser, you should see something like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>live demo of this code is shown below:</p>
<p>See the Pen YXmdNJ by SitePoint (@SitePoint) on CodePen.</p>
<p>With this example in mind, let’s start our discussion.</p>
<p>Pitfall #1 – Accidentally Measuring Unimportant Things<br>In the example above, you can note that the only thing that we do between one performance.now() and the other is calling the function makeHash() and assigning its value to a variable result. This gives us the time it takes to execute that function and nothing else. This measurement could also be made as detailed below:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(makeHash(<span class="string">'Peter'</span>));  <span class="comment">// bad idea!</span></div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>A live demo of this snippet is shown below:</p>
<p>See the Pen PqMXWv by SitePoint (@SitePoint) on CodePen.</p>
<p>But in this case, we would be measuring the time it takes to call the function makeHash(‘Peter’) and how long it takes to send and print that output on the console. We don’t know how long each of those two operations took. You only know the combined time. Also, the time it takes to send and print the output will vary greatly depending on the browser and even on what’s going on in it at that time.</p>
<p>Perhaps you’re perfectly aware that console.log is unpredictably slow. But it would be equally wrong to execute more than one function, even if each function does not involve any I/O. For example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">var</span> name = <span class="string">'Peter'</span>;</div><div class="line"><span class="keyword">var</span> result = makeHash(name.toLowerCase()).toString();</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, (t1 - t0).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate:'</span>, result);</div></pre></td></tr></table></figure>

<p>Again, we won’t know how the execution time was distributed. Was it the variable assignment, the <code>toLowerCase()</code> call, or the <code>toString()</code> call?</p>
<p>Pitfall #2 – Measuring only Once<br>Another common mistake is to make just one measurement, summarize the time taken and draw conclusions based on that. It’s likely to be totally different at different times. The execution time greatly depends on various factors:</p>
<p>Time for the compiler to warm up (e.g. time to compile the code into byte code)<br>The main thread being busy doing other things we didn’t realize were going on<br>Your computer’s CPU(s) being busy with something that slows down your whole browser<br>An incremental improvement is to execute the function repeatedly, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t0 = performance.now();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">}</div><div class="line"><span class="keyword">var</span> t1 = performance.now();</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Took'</span>, ((t1 - t0) / <span class="number">10</span>).toFixed(<span class="number">4</span>), <span class="string">'milliseconds to generate'</span>);</div></pre></td></tr></table></figure>

<p>A live demo of this example is shown below:</p>
<p>See the Pen Qbezpj by SitePoint (@SitePoint) on CodePen.</p>
<p>The risk with this approach is that our browser’s JavaScript engine might make sub-optimizations which means that the second time the function is called with the same input, it can benefit from remembering the first output and simply use that again. To solve this issue, you can use many different input strings instead of repeatedly sending in the same input string (e.g. ‘Peter’). Obviously, the problem with testing with different inputs is that naturally the function we’re measuring takes different amounts of time. Perhaps some of the inputs cause longer execution time than others.</p>
<p>Pitfall #3 – Relying too Much on the Average<br>In the last section we learned that it’s a good practice to run something repeatedly, ideally with different inputs. However, we have to remember that the problem with different inputs is that the execution might take much longer than all the other inputs. So let’s take a step back and send in the same input. Suppose that we send in the same input ten times and for each, print out how long that took. The output might look something like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Took <span class="number">0.2730</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0234</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0200</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0281</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0162</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0245</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0677</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0289</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0240</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div><div class="line">Took <span class="number">0.0311</span> <span class="built_in">milliseconds</span> <span class="built_in">to</span> generate: <span class="number">77005292</span></div></pre></td></tr></table></figure>

<p>Note how the very first time, the number is totally different from the other nine times. Most likely, that’s because the JavaScript engine in our browser makes some sub-optimizations and needs some warm-up. There’s little we can do to avoid that but there are some good remedies we can consider to prevent a faulty conclusion.</p>
<p>One way is to calculate the average of the last nine times. Another more practical way is to collect all results and calculate a median. Basically, it’s all the results lined up, sorted in order and picking the middle one. This is where performance.now() is so useful, because you get a number you can do whatever with.</p>
<p>Let’s try again but this time we’ll use a median function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> numbers = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</div><div class="line">  <span class="keyword">var</span> t0 = performance.now();</div><div class="line">  makeHash(<span class="string">'Peter'</span>);</div><div class="line">  <span class="keyword">var</span> t1 = performance.now();</div><div class="line">  numbers.push(t1 - t0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Median time'</span>, median(numbers).toFixed(<span class="number">4</span>), <span class="string">'milliseconds'</span>);</div></pre></td></tr></table></figure>

<p>Pitfall #4 – Comparing Functions in a Predictable Order<br>We’ve understood that it’s always a good idea to measure something many times and take the average. Moreover, the last example taught us that it’s preferable to use the median instead of the average.</p>
<p>Now, realistically, a good use of measuring function execution time is to learn which of several functions is faster. Suppose we have two functions that take the same type of input and yield the same result but internally they work differently.</p>
<p>Let’s say we want to have a function that returns true or false if a certain string is in an array of other strings, but does this case insensitively. In other words we can’t use Array.prototype.indexOf because it’s not case insensitive. Here’s one such implementation:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>Immediately we notice that this can be improved because the haystack.forEach loop always goes through all the elements even if we have an early match. Let’s try to write a better version using a good old for loop.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div></pre></td></tr></table></figure>

<p>Now let’s see which one is the fastest. We do this by running each function 10 times and collecting all the measurements:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn1</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">var</span> found = <span class="literal">false</span>;</div><div class="line">  haystack.forEach(<span class="function"><span class="keyword">function</span><span class="params">(element)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (element.toLowerCase() === needle.toLowerCase()) {</div><div class="line">      found = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="keyword">return</span> found;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIn2</span><span class="params">(haystack, needle)</span> </span>{</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = haystack.length; i &lt; len; i++) {</div><div class="line">    <span class="keyword">if</span> (haystack[i].toLowerCase() === needle.toLowerCase()) {</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn1([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'B'</span>));  <span class="comment">// true</span></div><div class="line"><span class="built_in">console</span>.log(isIn2([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], <span class="string">'d'</span>));  <span class="comment">// false</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">median</span><span class="params">(sequence)</span> </span>{</div><div class="line">  sequence.sort();  <span class="comment">// note that direction doesn't matter</span></div><div class="line">  <span class="keyword">return</span> sequence[<span class="built_in">Math</span>.ceil(sequence.length / <span class="number">2</span>)];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">measureFunction</span><span class="params">(func)</span> </span>{</div><div class="line">  <span class="keyword">var</span> letters = <span class="string">'a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z'</span>.split(<span class="string">','</span>);</div><div class="line">  <span class="keyword">var</span> numbers = [];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; letters.length; i++) {</div><div class="line">    <span class="keyword">var</span> t0 = performance.now();</div><div class="line">    func(letters, letters[i]);</div><div class="line">    <span class="keyword">var</span> t1 = performance.now();</div><div class="line">    numbers.push(t1 - t0);</div><div class="line">  }</div><div class="line">  <span class="built_in">console</span>.log(func.name, <span class="string">'took'</span>, median(numbers).toFixed(<span class="number">4</span>));</div><div class="line">}</div><div class="line"></div><div class="line">measureFunction(isIn1);</div><div class="line">measureFunction(isIn2);</div></pre></td></tr></table></figure>

<p>We run that and get following output:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line">isIn1 took <span class="number">0.0050</span></div><div class="line">isIn2 took <span class="number">0.0150</span></div></pre></td></tr></table></figure>

<p>A live demo of this example is shown below:</p>
<p>See the Pen YXmdZJ by SitePoint (@SitePoint) on CodePen.</p>
<p>What the heck has just happened? The first function was three times faster. That was not supposed to happen!</p>
<p>The explanation is simple but subtle. The first function which uses haystack.forEach benefits from some low-level optimizations in the browser’s JavaScript engine that we don’t get when we use an array index technique. It proves our point: you never know until you measure it!</p>
<p>Conclusions<br>In our attempt to demonstrate how to use performance.now() to get an accurate execution time in JavaScript, we stumbled across a benchmarking scenario where our intuition turned out to be quite the opposite of what our empirical results conclude. The point is that, if you want to write faster web apps your JavaScript code needs to be optimized. Because computers are (almost) living breathing things, they are unpredictable and surprising. The most reliable way to know that our code improvements yield faster execution, is to measure and compare.</p>
<p>The other reason we never know which code is faster, if we have multiple ways of doing the same thing, is because context matters. In the previous section we perform a case insensitive string search looking for one string among 26 other strings. It’s likely that the conclusion would be totally different if we instead had to look for one string among 100,000 other strings.</p>
<p>The list above isn’t exhaustive as there are more pitfalls to be aware of. For example, measuring unrealistic scenarios or only measuring on one JavaScript engine. But the sure thing is that a great asset for JavaScript developers who want to write faster and better web apps is performance.now(). Last but not least, remember that measuring execution time only yields one dimension of “better code”. There’s also memory and code complexity considerations to bear in mind.</p>
<p>What about you? Have you ever used this function to test your code’s performance? If not, how do you proceed in this stage? Please share your thoughts in the comments below. Let’s start a discussion!</p>

      
    </div>
    
      
    
  </div>
</article>




<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/06/40-npm-modules-we-can-t-live-without/">40个我们不可或缺的NPM包[译]</a></h1>
  

      
      <time datetime="2015-09-06T00:41:42.000Z">Sep 6 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原地址：<a href="https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a" target="_blank" rel="external">https://medium.com/startup-study-group/40-npm-modules-we-can-t-live-without-36e29e352e3a</a></p>
<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*Cv7F9UtBMhsrcV2_rwqEgA.png" alt="npm picture"></p>
<p>Croissant按照字母顺序分享了他们用到的40个不可或缺的NPM模块：</p>
<p>agenda</p>
<p>这是一个类似于“cron”的作业，如每隔几分钟做一些事情。</p>
<p>agenda-ui</p>
<p>可视化的界面，用于管理agenda的作业，就像麦当劳的订单界面，让员工知道订单的状态。</p>
<p>async</p>
<p>用于对多个异步一次处理，主要用于异步编程，尽管我们也开始迁移到”q”,但是我们任然在一些地方使用，像“waterfall”和“each”对于一行数据在多数据相互依赖操作，会用到。</p>
<p>aws-sdk</p>
<p>我们用于上传文件到AWS S3上。</p>
<p>bcryptjs</p>
<p>担心你的密码的安全性？不用了！该算法是行业标准。即使我们遭受过黑客攻击，您的密码将仍然只是字母和符号混合的字符串。只要你的密码不是一个简单字典中的单词，虽然，因为如果有人没有得到这个数据，他们可以尝试在字典中的所有单词进行暴力破解。</p>
<p>body-parser</p>
<p>我们使用ExpressJS，所以我们需要序列化那些JSON的响应。</p>
<p>braintree</p>
<p>用于支付的一个智能（支付网关）依赖包。（国内用到不多）</p>
<p>chai</p>
<p>我们使用这个用于集成测试。（一个断言库）</p>
<p>compression</p>
<p>另一个像Express一样，你需要的包。用于压缩服务的响应，让数据在网络上传输更快。好东西。</p>
<p>express</p>
<p>这是个大魔法师。这是一个ExpressJS和NodeJS的web服务的核心模块，让我们可以不用写了大量的样板HTTP服务器代码。带来了一些很酷的特性，如指定一个静态目录作为一个简单的文件服务器，当然，以从它的充满活力的社区，创建的许多插件，可以很容易使用。</p>
<p>forever</p>
<p>如果一个node进程或者express服务崩溃了怎么办？这个小家伙会在后台为你重新启动。这实在是太聪明 - 你可以指定运行多久失败需要重新启动。这可以防止重启一遍又一遍自动失败进程。</p>
<p>fs-extra</p>
<p>当“fs”模块不够用时，“fs-extra”给你想要的更多功能。我们真的只是用它来满足使一个嵌套的文件夹如果在父文件夹不存在创建的能力。出于某种原因，对于“fs”来说，这是过分的要求。</p>
<p>gm</p>
<p>This module is wizardry. GraphicsMagick is a wrapper for the long-lived ImageMagick C library that has been used through the ages by many an image manipulator. We use this to resize and crop our image uploads. You know all those beautiful venue images that we put on AWS? We used this on them first.</p>
<p>gulp</p>
<p>Gulp is always running in the background while we code. It automatically compresses our javascript and css files. We also use it to spawn our test runners. It has tons of packages (which you’re about to find out about)! Some people say it’s like “grunt”, but with streams.</p>
<p>gulp-angular-templatecache</p>
<p>Did we mention we use Angular? We use Angular. This gulp plugin allows us to smush together all our html templates into one file for a quicker load time on the website. Angular can then use this template to load the pages.</p>
<p>gulp-concat</p>
<p>Remember that smushing thing we talked about earlier? This takes care of that.</p>
<p>gulp-csso</p>
<p>Remember how we like smushing things? This lets us smush things into even smaller files by first minifying the css files that are about to be smushed.</p>
<p>gulp-istanbul</p>
<p>Gulp is also a great test runner, runner. While running tests, “istanbul” will output a report showing our unit and integration test coverage, with percentages showing how much code was covered in the test. Magical.</p>
<p>gulp-livereload</p>
<p>A must for front-end developers, this connects to your web browser and refreshes it every time you make a change to an html file. Good job, gulp.</p>
<p>gulp-mocha</p>
<p>More test stuff. This is just a wrapper for mocha, which we use for integration tests, such as making sure an API endpoint works as expected.</p>
<p>gulp-plumber</p>
<p>Because of all our streaming and piping with gulp, we need this little library. In case something like gulp-csso fails, this will keep things running smoothly.</p>
<p>gulp-sass</p>
<p>You thought we use CSS? Think again. Everything you see was once a young, budding, scss (a.k.a. Sass) file. Gulp watches and compiles our master css output every time we make a change.. super quick!</p>
<p>gulp-uglify</p>
<p>Last but not least, this gulp plugin does good ol’ uglification of front end JavaScript code so we can send it to you super fast and super securely.</p>
<p>jwt-simple</p>
<p>Back to reality, away from the gulpies, next we have the package that makes authorization easy. When you log in to Croissant, we take your information and smush it all together and encode it with jwt-simple and tell your browser what came out. Then, your browser uses the token we gave you each time it does something that requires you to be logged in.</p>
<p>lodash</p>
<p>Lodash embodies winning at life. All the stuff you ever needed for working with collections of objects and arrays in JavaScript all in one simple library. We are big fans of pick, omit, and contains — useful for limiting API server responses for quicker load times.</p>
<p>mime-types</p>
<p>We run a tight ship here at Croissant, and that means keeping track of the file types that we upload to AWS S3. One trick to doing this is taking the file extension and feeding it into this library, resulting in something like “image/jpeg” for a jpg file.</p>
<p>mocha</p>
<p>With this, all we need to do is type “mocha” and it runs a plethora of tests that we drew up using the “describe” and “it” functions for organizing tests. It doesn’t get much simpler than this for running JavaScript tests.</p>
<p>moment</p>
<p>Everyone who has ever programmed in anything has run into dealing with dates and times. JavaScript by itself is very basic, but moment makes it all better. With moment, you just pass in the raw JavaScript date object, and in return, you get a nice little ball of date and time functionality that you can play with, such as formatting, adding time, and altering.</p>
<p>moment-timezone</p>
<p>Don’t fall into the trap of forgetting about timezones though. If you’re not careful, someone on the other side of the world will think your store opens at 3 am instead of noon. This package is useful in converting our UTC server times into the timezone of the venue, so you know when to show up, no matter where you are in the world.</p>
<p>mongoose</p>
<p>Did we mention we use MongoDB? We use MongoDB. Mongoose keeps our team in the know, allowing us to always see at a glance what the structure of our data is. Without it, you might end up with all sorts of objects in the database, causing who knows what kind of chaos on the back and front ends.</p>
<p>morgan</p>
<p>Just like body-parser, this is another one of those packages that you simply cannot do without when running an Express server. Not only does it output all sorts of info, such as response time and path name whenever there is an HTTP request, but it also lets you customize (using a function!) what you want to see in the output.</p>
<p>newrelic</p>
<p>New Relic is a cool company that gives you info about your app. You simply add the package to the first line of code in your server, and then go onto their website to watch the magic happen. We use it to get notified if there are a bunch of errors happening on our server in production.</p>
<p>nodemailer</p>
<p>If you ever need to send email, don’t send it yourself — use a transactional email service, such as SendGrid. It comes with some great features, such as the ability to make a nice template that wraps all of our emails. Nodemailer is the package that lets us send simple messages to SendGrid.</p>
<p>prerender-node</p>
<p>Remember that Angular thing we use? It sucks for SEO because most search engines can’t understand it. In comes prerendering to the rescue. With it, web crawlers can easily see a non-Angular version of your website because the prerenderer estimated what it looks like. Turn off JavaScript in your web browser next time you browse Croissant and you’ll see what we mean.</p>
<p>protractor</p>
<p>Anyone who has ever worked with webdriver for automating browser tasks and tests, will quickly see the value in having an Angular wrapper. This wrapper waits for Angular to load on the page and waits for any promises to resolve before going to the next line of tests. This is handy for our app which is rich in asynchronous events.</p>
<p>q</p>
<p>While async is good for waterfalls and map operations, “q” is great for making promises. By that, we mean taking a normal callback function and wrapping it up in the “q” promise syntax. This lets us make promise chains involving asynchronous functions that normally use callbacks, a.k.a. callback hell.</p>
<p>request</p>
<p>Every once in a while we need to make a manual HTTP request to an external server. We’ve always stuck to using this package for doing this kind of task since the dawn of NodeJS. Mostly however, the sdk’s for the external services we use do this for us, using “request” under the hood.</p>
<p>slug</p>
<p>This is the library that turns “Hello There” into “hello-there”, perfect for making dynamic titles into URL-friendly links. We use this for taking the names of our venues and making that unique link that you can share with your buddies so they know where to find you.</p>
<p>stripe</p>
<p>Time to get paid. Stripe is our payment processor for credit cards. They’re nice enough to store customer credit card information in a PCI-compliant way so we don’t have to. We use their sdk to put cards on file and make charges.</p>
<p>supertest-as-promised</p>
<p>This is the core of our integration tests. Using promises we can easily expect a certain response status code, while also using the response data in the next step of the test. We use this with chai.</p>
<p>Welp, there you have it folks. Our list of goodies. We’re always open to questions, comments, and suggestions. Please be gentle :)</p>
<p>Dave<br>Co-founder &amp; CEO, Croissant</p>

      
    </div>
    
      
    
  </div>
</article>




<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/03/Co-Generator-Usage/">Generator库：co的用法</a></h1>
  

      
      <time datetime="2015-09-03T09:41:11.000Z">Sep 3 2015</time>
      
    </header>
    <div class="entry">
      
        <p>什么是Generator？</p>
<p>Generator是ES6里面新增的语法特性，是异步编程的一个语法级的解决方案。Generator在内部封装的多个状态，在执行Generator函数的时候，会返回一个遍历状态的迭代器对象。表现形式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span><span class="params">()</span> </span>{  <span class="comment">//*是Generator一个语法表示</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span>;<span class="comment">//yield 是返回状态的值</span></div><div class="line">  <span class="keyword">yield</span> <span class="string">'world'</span>;</div><div class="line">  <span class="keyword">return</span> <span class="string">'ending'</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> hw = helloWorldGenerator();</div><div class="line"></div><div class="line"></div><div class="line">hw.next();  <span class="comment">//在每次执行迭代器对象时，会返回当前获取的状态信息。</span></div><div class="line"><span class="comment">// { value: 'hello', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'world', done: false }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: 'ending', done: true }</span></div><div class="line"></div><div class="line">hw.next();</div><div class="line"><span class="comment">// { value: undefined, done: true }</span></div></pre></td></tr></table></figure>

<blockquote>
<p>Generator与协程<br>协程（coroutine）是一种程序运行的方式，可以理解成“协作的线程”或“协作的函数”。协程既可以用单线程实现，也可以用多线程实现。前者是一种特殊的子例程，后者是一种特殊的线程。</p>
<p>（1）协程与子例程的差异</p>
<p>传统的“子例程”（subroutine）采用堆栈式“后进先出”的执行方式，只有当调用的子函数完全执行完毕，才会结束执行父函数。协程与其不同，多个线程（单线程情况下，即多个函数）可以并行执行，但是只有一个线程（或函数）处于正在运行的状态，其他线程（或函数）都处于暂停态（suspended），线程（或函数）之间可以交换执行权。也就是说，一个线程（或函数）执行到一半，可以暂停执行，将执行权交给另一个线程（或函数），等到稍后收回执行权的时候，再恢复执行。这种可以并行执行、交换执行权的线程（或函数），就称为协程。</p>
<p>从实现上看，在内存中，子例程只使用一个栈（stack），而协程是同时存在多个栈，但只有一个栈是在运行状态，也就是说，协程是以多占用内存为代价，实现多任务的并行。</p>
<p>（2）协程与普通线程的差异</p>
<p>不难看出，协程适合用于多任务运行的环境。在这个意义上，它与普通的线程很相似，都有自己的执行上下文、可以分享全局变量。它们的不同之处在于，同一时间可以有多个线程处于运行状态，但是运行的协程只能有一个，其他协程都处于暂停状态。此外，普通的线程是抢先式的，到底哪个线程优先得到资源，必须由运行环境决定，但是协程是合作式的，执行权由协程自己分配。</p>
<p>由于ECMAScript是单线程语言，只能保持一个调用栈。引入协程以后，每个任务可以保持自己的调用栈。这样做的最大好处，就是抛出错误的时候，可以找到原始的调用栈。不至于像异步操作的回调函数那样，一旦出错，原始的调用栈早就结束。</p>
<p>Generator函数是ECMAScript 6对协程的实现，但属于不完全实现。Generator函数被称为“半协程”（semi-coroutine），意思是只有Generator函数的调用者，才能将程序的执行权还给Generator函数。如果是完全执行的协程，任何函数都可以让暂停的协程继续执行。</p>
<p>如果将Generator函数当作协程，完全可以将多个需要互相协作的任务写成Generator函数，它们之间使用yield语句交换控制权。</p>
</blockquote>
<p>co是什么？</p>
<p>co是tj写的一个用于 Generator 函数的自动执行的函数库。最新是4.0版本，支持promise等一些新特性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// yield any promise</span></div><div class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="comment">// resolve multiple promises in parallel</span></div><div class="line">  <span class="keyword">var</span> a = Promise.resolve(<span class="number">1</span>);</div><div class="line">  <span class="keyword">var</span> b = Promise.resolve(<span class="number">2</span>);</div><div class="line">  <span class="keyword">var</span> c = Promise.resolve(<span class="number">3</span>);</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</div><div class="line">  <span class="built_in">console</span>.log(res);</div><div class="line">  <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="comment">// errors can be try/catched</span></div><div class="line">co(<span class="function"><span class="keyword">function</span> *<span class="params">()</span></span>{</div><div class="line">  <span class="keyword">try</span> {</div><div class="line">    <span class="keyword">yield</span> Promise.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'boom'</span>));</div><div class="line">  } <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="built_in">console</span>.error(err.message); <span class="comment">// "boom"</span></div><div class="line"> }</div><div class="line">}).catch(onerror);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(err)</span> </span>{</div><div class="line">  <span class="comment">// log any uncaught errors</span></div><div class="line">  <span class="comment">// co will not throw any errors you do not handle!!!</span></div><div class="line">  <span class="comment">// HANDLE ALL YOUR ERRORS!!!</span></div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>数组方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [</div><div class="line">    Promise.resolve(<span class="number">1</span>),</div><div class="line">    Promise.resolve(<span class="number">2</span>),</div><div class="line">    Promise.resolve(<span class="number">3</span>),</div><div class="line">  ];</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; [1, 2, 3]</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>对象方式调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> {</div><div class="line">    <span class="number">1</span>: Promise.resolve(<span class="number">1</span>),</div><div class="line">    <span class="number">2</span>: Promise.resolve(<span class="number">2</span>),</div><div class="line">  };</div><div class="line">  <span class="built_in">console</span>.log(res); <span class="comment">// =&gt; { 1: 1, 2: 2 }</span></div><div class="line">}).catch(onerror);</div></pre></td></tr></table></figure>

<p>co(fn*).then( val =&gt; )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">co(<span class="function"><span class="keyword">function</span>* <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(<span class="literal">true</span>);</div><div class="line">}).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">}, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.error(err.stack);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>var fn = co.wrap(fn*)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fn = co.wrap(<span class="function"><span class="keyword">function</span>* <span class="params">(val)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> Promise.resolve(val);</div><div class="line">});</div><div class="line"></div><div class="line">fn(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> </span>{</div><div class="line"></div><div class="line">});</div></pre></td></tr></table></figure>


      
    </div>
    
      
    
  </div>
</article>




<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/02/Bluebird-Promise-Usage/">Bluebird中Promise模式使用</a></h1>
  

      
      <time datetime="2015-09-02T00:55:32.000Z">Sep 2 2015</time>
      
    </header>
    <div class="entry">
      
        <p><img src="https://camo.githubusercontent.com/f67ead75c0654cefe0c5b791508731cf08cb5b0c/687474703a2f2f7065746b61616e746f6e6f762e6769746875622e696f2f626c7565626972642f6c6f676f2e706e67" alt="bluebird logo"><br>Bluebird是一个高性能全功能的Promise库，主要有以下特性：</p>
<blockquote>
<ul>
<li>实现了Promises A+规范</li>
<li>同步检查(promise状态，返回值，失败原因)</li>
<li>并发调用(调用多个异步处理)</li>
<li>异步模型转化到Promise模式</li>
<li>使用通过并行使用Python/C＃进行资源管理的取消和超时</li>
<li>并行的C#异步和等待</li>
<li>试用的工具方法，如：<br>.bind()<br>.call()<br>Promise.join()…</li>
<li>调试解决方案和合理的默认值</li>
<li>优越的性能表现</li>
</ul>
</blockquote>
<p>bluebird支持node.js和浏览器端</p>
<p>node.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="operator"><span class="keyword">install</span> bluebird</span></div></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Promise = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</div></pre></td></tr></table></figure>

<p>浏览器端支持（ES5）</p>
<p><img src="https://camo.githubusercontent.com/335f3fdee6026df48a9699235b03cd3e6bf3dba9/68747470733a2f2f73617563656c6162732e636f6d2f62726f777365722d6d61747269782f7065746b615f616e746f6e6f762e737667" alt="浏览器支持"></p>
<p>可见对于IE必须是IE9和以上</p>
<p>用法：</p>
<p>下载：<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js" target="_blank" rel="external">bluebird.js</a>或<a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js" target="_blank" rel="external">bluebird.min.js</a></p>
<p>以解析一个json文件为例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fs.readFileAsync(<span class="string">"file.json"</span>).then(<span class="built_in">JSON</span>.parse).then(<span class="function"><span class="keyword">function</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(val.success);</div><div class="line">})</div><div class="line">.catch(<span class="built_in">SyntaxError</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"invalid json in file"</span>);</div><div class="line">})</div><div class="line">.catch(<span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">"unable to read file"</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>具体需要看详细的可以查看<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">官方github</a></p>

      
    </div>
    
      
    
  </div>
</article>




<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/09/01/JQuery-Deferred-Promise/">JQuery中Deferred/Promise的使用</a></h1>
  

      
      <time datetime="2015-09-01T00:55:27.000Z">Sep 1 2015</time>
      
    </header>
    <div class="entry">
      
        <p>同样Deferred也是为了解决异步嵌套回调而存在的。早在JQuery 1.5就已经支持了。</p>
<p>使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dtd = $.Deferred(); <span class="comment">// 新建一个Deferred对象</span></div><div class="line"><span class="keyword">var</span> wait = <span class="function"><span class="keyword">function</span><span class="params">(dtd)</span></span>{</div><div class="line">    <span class="keyword">var</span> tasks = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">　　　　　　alert(<span class="string">"执行完毕！"</span>);</div><div class="line">　　　　　　dtd.resolve(); <span class="comment">// 改变Deferred对象的执行状态</span></div><div class="line">　　　　};</div><div class="line"></div><div class="line">　　　　setTimeout(tasks,<span class="number">5000</span>);</div><div class="line">　　　　<span class="keyword">return</span> dtd.promise(); <span class="comment">// 返回promise对象</span></div><div class="line">　　};</div><div class="line"><span class="keyword">var</span> d = wait(dtd); <span class="comment">// 新建一个d对象，改为对这个对象进行操作</span></div><div class="line">$.when(d)</div><div class="line"> .done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"哈哈，成功了！"</span>); })</div><div class="line"> .fail(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"出错啦！"</span>); });</div></pre></td></tr></table></figure>

<p>我们看下怎么样用，下面列举了几个场景：</p>
<ol>
<li>单个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$.ajax(<span class="string">'abc.php'</span>).done(<span class="function"><span class="keyword">function</span><span class="params">(result)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>多个Ajax异步交互</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$.when($.ajax(<span class="string">'abc.php'</span>), $.ajax(<span class="string">'abc2.php'</span>), $.ajax(<span class="string">'abc3.php'</span>))</div><div class="line">.done(<span class="function"><span class="keyword">function</span><span class="params">(result1, result2, result3)</span> </span>{</div><div class="line">    alert(<span class="string">'success'</span>);</div><div class="line">}).fail(<span class="function"><span class="keyword">function</span> <span class="params">(jqXHR, textStatus, errorThrown)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<ol>
<li>动画链式调用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.when(preloadImage())</div><div class="line">.then(animation01)</div><div class="line">.then(animation02)</div><div class="line">.then(animation03)</div><div class="line">.then(transition)</div><div class="line">.then(merge)</div><div class="line">.then(zoom)</div><div class="line">.then(showContent)</div><div class="line">.then(flicker);</div></pre></td></tr></table></figure>

<p>和Promise/A+的规范有些出入，可能因为实现比较早，但是其意义和原理是差不多的。</p>

      
    </div>
    
      
    
  </div>
</article>




<div class="pagination">
  <table width='100%'>
    <tbody>
    <tr>
      <td width='120' align='left'>
        
      </td>
      <td width='auto' align='center'>
          <a href="/archives/">文章归档</a>
      </td>
      <td width='120' align='right'>
        
      </td>
    </tr>
    </tbody>
  </table>
</div>




</div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2015 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
