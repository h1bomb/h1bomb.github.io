<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uupup！ › archive_b</title>
  <meta name="author" content="H1bomb">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="uupup！"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="uupup！" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-63097959-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">uupup！</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">2015/10</h2>


<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/10/09/debugging-memory-leaks-node-js-applications/">调试node.js应用的内存泄漏[译]</a></h1>
  

      
      <time datetime="2015-10-09T15:46:52.000Z">Oct 9 2015</time>
      
    </header>
    <div class="entry">
      
        <p>原文：<a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external">http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications</a></p>
<p>有一次，我开着一辆内部是V8双涡轮增压发动机的奥迪，其性能令人难以置信。凌晨3点，我行驶在芝加哥附近没有人的IL-80高速公路，时速达到140MPH。从那时起，“V8”这个术语成为我对高性能的认识。</p>
<blockquote>
<p>Node.js是一个建立在Chrome的JavaScript引擎V8之上的易于快速构建可伸缩的网络应用的平台。</p>
</blockquote>
<p>尽管奥迪的V8非常强大，但仍然限于用你的油箱的容量大小。这同样适用于谷歌的V8引擎 - 在node.js背后的JavaScript引擎。有很多因素使Node.js的性能是难以置信的，<a href="http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js" target="_blank" rel="external">适用于许多应用案例</a>，但是你总是受限于内存堆的大小。当你的Node.js应用程序需要处理更多的请求时，你有两个选择：就是规模垂直或水平扩展。水平扩展意味着你必须运行多个并发的应用程序实例。如果做得对，你最终能够服务更多的请求。垂直扩展意味着你要为你的应用实例提高应用程序的内存使用情况和可用的性能或增加资源。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg" alt="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg"></p>
<p>最近有为我的Toptal（一个开放外包的平台）客户修复一个运行在Node.js上应用程序的内存泄漏问题。该应用程序是一个能够在每一分钟处理成千上万请求的API服务器。最初的应用几乎占据了600MB的RAM，所以我们决定采取热API端来重新实现它们。当你需要服务于许多请求开销变得非常昂贵。</p>
<p>对于新的API，我们选择的restify以及本地的MongoDB的驱动程序和Kue后台服务。听起来像是一个非常轻量级的栈，对不对？其实不然。在高峰负荷新的应用程序实例可以消耗高达270MB的RAM。因此起两个每1X的Heroku Dyno应用实的想法破灭了。</p>
<h2 id="Node-js_内存泄露调试军火库">Node.js 内存泄露调试军火库</h2>
<h3 id="Memwatch">Memwatch</h3>
<p>如果你搜索“如何在node里发现泄露”这个第一个你或许会搜到的工具就是memwatch。原始的包很久以前就被遗弃，不再保留。但是你可以很容易地找到在GitHub上的fork的库的更新版本。该模块是有用的，如果它看到堆增长超过5个连续的垃圾收集，它可以触发泄漏事件。</p>
<h3 id="Heapdump">Heapdump</h3>
<p>伟大的工具，它允许开发人员使用Chrome开发人员工具对Node.js采取堆快照后对其进行检查。</p>
<h3 id="Node-inspector">Node-inspector</h3>
<p>即使是被更为有用的heapdump替代，但它任然可以让你连接到运行的应用程序，采取堆转储，甚至调试，并重新编译在程序运行中。</p>
<h2 id="针对“node-inspector”_的说明">针对“node-inspector” 的说明</h2>
<p>不幸的是，将不能连接到被在Heroku运行生产的应用中，因为不允许信号被发送到运行的进程。然而，Heroku的是不是唯一的托管平台。</p>
<p>为了在实战中体验node-inspector，我们将使用的RESTify编写一个简单的Node.一点点内存泄漏的根源放在js应用程序中。这里所有的实验都是用Node.js v0.12.7和已编译的V8 v3.28.71.19。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = restify.createServer();</div><div class="line"></div><div class="line"><span class="keyword">var</span> tasks = [];</div><div class="line"></div><div class="line">server.pre(<span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  tasks.push(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> req.headers;</div><div class="line">  });</div><div class="line"></div><div class="line">  <span class="comment">// Synchronously get user from session, maybe jwt token</span></div><div class="line">  req.user = {</div><div class="line">    id: <span class="number">1</span>,</div><div class="line">    username: <span class="string">'Leaky Master'</span>,</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>{</div><div class="line">  res.send(<span class="string">'Hi '</span> + req.user.username);</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">});</div><div class="line"></div><div class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'%s listening at %s'</span>, server.name, server.url);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这个应用有个很简单且明显的内存泄漏。这个tasks的数组在应用的生命周期内引发变慢，并最终导致崩溃。这个问题是，不仅仅是闭包泄漏，而是波及了整个请求对象。</p>
<p>在V8里使用了stop-the-world这种GC策略，因此，这意味着越多的对象在内存中驻留，回收的时间就越长。在下面的日志你可以清楚地看到，在应用程序的生命的开始，平均回收内存是20毫秒，但几十万的请求后，则需要大约230ms。如果这时访问我们的应用程序将不得不等待230ms之久，因为正在GC。你也可以看到每隔几秒钟调用GC，这意味着每隔几秒钟，用户访问我们的应用程序会遇到问题。随着延迟时间增长，直到程序崩溃。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[<span class="number">28093</span>]     <span class="number">7644</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">25.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7717</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">10.9</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.0</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">7866</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">23.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]     <span class="number">8001</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">11.0</span> <span class="function"><span class="params">(<span class="number">48.5</span>)</span> -&gt;</span> <span class="number">10.9</span> (<span class="number">48.5</span>) MB, <span class="number">18.4</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">633891</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.3</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">635672</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">331.5</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div><div class="line"></div><div class="line">[<span class="number">28093</span>]   <span class="number">637508</span> <span class="attribute">ms</span>: Mark-sweep <span class="number">235.7</span> <span class="function"><span class="params">(<span class="number">290.5</span>)</span> -&gt;</span> <span class="number">235.7</span> (<span class="number">290.5</span>) MB, <span class="number">357.2</span> ms [<span class="attribute">HeapObjectsMap</span>::UpdateHeapObjectsMap] [GC <span class="keyword">in</span> old space requested].</div></pre></td></tr></table></figure>

<p>当在启动一个Node.js的应用时加上–trace_gc这个标示，就可以逐行打印这些日志。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">node</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">trace_gc</span> <span class="comment">app</span><span class="string">.</span><span class="comment">js</span></div></pre></td></tr></table></figure>

<p>Let us assume that we have already started our Node.js application with this flag. Before connecting the application with node-inspector, we need to send it the SIGUSR1 signal to the running process. If you run Node.js in cluster, make sure you connect to one of the slave processes.<br>假设我们已经在这个Node.js的应用设置标示。在连接node-inspector到应用程序之前，我们需要把SIGUSR1信号发送到正在运行的进程。如果在群集中运行Node.js，请确保您连接到其中一个从属进程。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kill</span> -SIGUSR1 <span class="variable">$pid</span> <span class="comment"># Replace $pid with the actual process ID</span></div></pre></td></tr></table></figure>

<p>通过这样做，我们正在让Node.js的应用（准确地说是V8）进入调试模式。在这种模式下，应用自动将打开的端口5858<a href="https://code.google.com/p/v8-wiki/wiki/DebuggerProtocol" target="_blank" rel="external">V8调试协议</a>。</p>
<p>我们下一步运行node-inspector连接到运行应用的调试接口，并打开8080端口的web接口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>node-inspector</div><div class="line"><span class="constant">Node</span> <span class="constant">Inspector</span> v<span class="number">0</span>.<span class="number">12.2</span></div><div class="line"><span class="constant">Visit</span> <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:8080/</span>?ws=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8080</span>&port=<span class="number">5858</span> to start debugging.</div></pre></td></tr></table></figure>

<p>如果应用程序在生产中运行，并且有一个防火墙，我们可以通过隧道远程端口8080到本地主机：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">ssh</span> <span class="tag">-L</span> 8080<span class="pseudo">:localhost</span><span class="pseudo">:8080</span> <span class="tag">admin</span><span class="at_rule">@<span class="keyword">example.com</span></span></div></pre></td></tr></table></figure>

<p>现在，你可以打开你的Chrome网络浏览器即可获得完全的访问连接到远程生产应用程序的Chrome开发工具。不幸的是，Chrome开发人员工具将不能在其他浏览器。</p>
<h2 id="让我们发现泄漏">让我们发现泄漏</h2>
<p>在V8内存泄漏是不是真正的内存泄漏就像我们从C / C++应用程序的理解的那样。在JavaScript变量为空值时并不消失，他们只是“被遗忘”。我们的目标是要找到这些被遗忘的变量，并使这些内存释放。</p>
<p>在Chrome开发工具里我们有多个profiler。我们在记录堆分配而运行，并随着时间的推移需要多堆快照特别感兴趣。这给了我们一个明确的窥视到哪些对象正在泄漏。</p>
<p>开始录制堆分配，让我们模拟使用Apache基准在我们的主页上50个并发用户。</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg" alt="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ab -<span class="built_in">c</span> <span class="number">50</span> -n <span class="number">1000000</span> -k http:<span class="comment">//example.com/</span></div></pre></td></tr></table></figure>

<p>Before taking new snapshots, V8 would perform mark-sweep garbage collection, so we definitely know that there is no old garbage in the snapshot.</p>
<h2 id="Fixing_the_Leak_on_the_Fly">Fixing the Leak on the Fly</h2>
<p>After collecting heap allocation snapshots over a period of 3 minutes we end up with something like the following:</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg" alt="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg"></p>
<p>We can clearly see that there are some gigantic arrays, a lot of IncomingMessage, ReadableState, ServerResponse and Domain objects as well in heap. Let’s try to analyze the source of the leak.</p>
<p>Upon selecting heap diff on chart from 20s to 40s, we will only see objects which were added after 20s from when you started the profiler. This way you could exclude all normal data.</p>
<p>Keeping note of how many objects of each type are in the system, we expand the filter from 20s to 1min. We can see that the arrays, already quite gigantic, keeps growing. Under “(array)” we can see that there are a lot of objects “(object properties)” with equal distance. Those objects are the source of our memory leak.</p>
<p>Also we can see that “(closure)” objects grow rapidly as well.</p>
<p>It might be handy to look at the strings as well. Under the strings list there are a lot of “Hi Leaky Master” phrases. Those might give us some clue too.</p>
<p>In our case we know that the string ”Hi Leaky Master” could only be assembled under the “GET /” route.</p>
<p>If you open retainers path you will see this string is somehow referenced via req, then there is context created and all this added to some giant array of closures.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg" alt="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg"></p>
<p>So at this point we know that we have some kind of gigantic array of closures. Let’s actually go and give a name to all our closures at real-time under sources tab.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg" alt="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg"></p>
<p>After we are done editing the code, we can hit CTRL+S to save and recompile code on the fly!</p>
<p>Now let’s record another Heap Allocations Snapshot and see which closures are occupying the memory.</p>
<p>It’s clear that SomeKindOfClojure() is our villain. Now we can see that SomeKindOfClojure() closures are being added to some array named tasks in the global space.</p>
<p>It’s easy to see that this array is just useless. We can comment it out. But how do we free memory the memory already occupied? Very easy, we just assign an empty array to tasks and with the next request it will be overridden and memory will be freed after next GC event.</p>
<p><img src="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg" alt="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg"></p>
<p>Dobby is free!</p>
<h2 id="Life_of_Garbage_in_V8">Life of Garbage in V8</h2>
<p><img src="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg" alt="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg"></p>
<p>Well, V8 JS does not have memory leaks, only forgotten variables.</p>
<p>V8 heap is divided into several different spaces:</p>
<p>New Space: This space is relatively small and has a size of between 1MB and 8MB. Most of the objects are allocated here.</p>
<ul>
<li>Old Pointer Space: Has objects which may have pointers to other objects. If object survives long enough in New Space it gets promoted to Old Pointer Space.</li>
<li>Old Data Space: Contains only raw data like strings, boxed numbers and arrays of unboxed doubles. Objects that have survived GC in the New Space for long enough are moved here as well.</li>
<li>Large Object Space: Objects which are too big to fit in other spaces are created in this space. Each object has it’s own mmap‘ed region in memory</li>
<li>Code space: Contains assembly code generated by the JIT compiler.</li>
<li>Cell space, property cell space, map space: This space contains Cells, PropertyCells, and Maps. This is used to simplify garbage collection.</li>
</ul>
<p>Each space is composed of pages. A page is a region of memory allocated from the operating system with mmap. Each page is always 1MB in size except for pages in large object space.</p>
<p>V8 has two built in garbage collection mechanisms: Scavenge, Mark-Sweep and Mark-Compact.</p>
<p>Scavenge is a very fast garbage collection technique and operates with objects in New Space. Scavenge is the implementation of <a href="http://en.wikipedia.org/wiki/Cheney&#39;s_algorithm" target="_blank" rel="external">Cheney’s Algorithm</a>. The idea is very simple, New Space is divided in two equal semi-spaces: To-Space and From-Space. Scavenge GC occurs when To-Space is full. It simply swaps To and From spaces and copy all live objects to To-Space or promote them to one of the old spaces if they survived two scavenges, and is then entirely erased from the space. Scavenges are very fast however they have the overhead of keeping double sized heap and constantly copying objects in memory. The reason to use scavenges is because most objects die young.</p>
<p>Mark-Sweep &amp; Mark-Compact is another type of garbage collector used in V8. The other name is full garbage collector. It marks all live nodes, then sweeps all dead nodes and defragments memory.</p>
<h3 id="GC_Performance_and_Debugging_Tips">GC Performance and Debugging Tips</h3>
<p>While for web applications high performance might not be such a big problem, you will still want to avoid leaks at all costs. During the mark phase in full GC the application is actually paused until garbage collection is completed. This means the more objects you have in the heap, the longer it will take to perform GC and the longer users will have to wait.</p>
<h3 id="Always_give_names_to_closures_and_functions">Always give names to closures and functions</h3>
<p>It’s much easier to inspect stack traces and heaps when all your closures and functions have names.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">db.query(<span class="string">'GIVE THEM ALL'</span>, <span class="function"><span class="keyword">function</span> <span class="title">GiveThemAllAName</span><span class="params">(error, data)</span> </span>{</div><div class="line">    ...</div><div class="line">})</div></pre></td></tr></table></figure>

<h3 id="Avoid_large_objects_in_hot_functions">Avoid large objects in hot functions</h3>
<p>Ideally you want to avoid large objects inside of hot functions so that all data is fit into New Space. All CPU and memory bound operations should be executed in background. Also avoid deoptimization triggers for hot functions, optimized hot function uses less memory than non-optimized ones.</p>
<h3 id="Hot_functions_should_be_optimized">Hot functions should be optimized</h3>
<p>Hot functions that run faster but also consume less memory cause GC to run less often. V8 provides some helpful debugging tools to spot non-optimized functions or deoptimized functions.</p>
<p>Avoid polymorphism for IC’s in hot functions</p>
<p>Inline Caches (IC) are used to speed up execution of some chunks of code, either by caching object property access obj.key or some simple function.</p>
<figure class="highlight javscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">(a, b)</span> <span class="comment">{</span></span></div><div class="line">  return a + b;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="title">x</span><span class="params">(1, 2)</span>; <span class="comment">// monomorphic</span></div><div class="line">x(<span class="number">1</span>, “<span class="keyword">string</span>”); <span class="comment">// polymorphic, level 2</span></div><div class="line">x(<span class="number">3.14</span>, <span class="number">1</span>); <span class="comment">// polymorphic, level 3</span></div></pre></td></tr></table></figure>

<p>When <code>x(a,b)</code> is run for the first time, V8 creates a monomorphic IC. When you call x a second time, V8 erases the old IC and creates a new polymorphic IC which supports both types of operands integer and string. When you call IC the third time, V8 repeats the same procedure and creates another polymorphic IC of level 3.</p>
<p>However, there is a limitation. After IC level reaches 5 (could be changed with <code>–max_inlining_levels</code> flag) the function becomes megamorphic and is no longer considered optimizable.</p>
<p>It’s intuitively understandable that monomorphic functions run the fastest and also have a smaller memory footprint.</p>
<h3 id="Don’t_add_large_files_to_memory">Don’t add large files to memory</h3>
<p>This one is obvious and well known. If you have large files to process, for example a large CSV file, read it line-by-line and process in little chunks instead of loading the entire file to memory. There are rather rare cases where a single line of csv would be larger than 1mb, thus allowing you to fit it in New Space.</p>
<h3 id="Do_not_block_main_server_thread">Do not block main server thread</h3>
<p>If you have some hot API which takes some time to process, such as an API to resize images, move it to a separate thread or turn it into a background job. CPU intensive operations would block main thread forcing all other customers to wait and keep sending requests. Unprocessed request data would stack in memory, thus forcing full GC to take longer time to finish.</p>
<h3 id="Do_not_create_unnecessary_data">Do not create unnecessary data</h3>
<p>I once had a weird experience with restify. If you send a few hundred thousand requests to an invalid URL then the application memory would rapidly grow on up to hundred megabytes until a full GC kicks in a few seconds later, which is when everything would go back to normal. Turns out that for each invalid URL, restify generates a new error object which includes long stack traces. This forced newly created objects to be allocated in Large Object Space rather than in New Space.</p>
<p>Having access to such data could be very helpful during development, but obviously not required on production. Therefore the rule is simple - do not generate data unless you certainly need it.</p>
<h3 id="Know_your_tools">Know your tools</h3>
<p>Last, but certainly not the least, is to know your tools. There are various debuggers, leak cathers, and usage graphs generators. All those tools can help you make your software faster and more efficient.</p>
<h3 id="Conclusion">Conclusion</h3>
<p>Understanding how V8’s garbage collection and code optimizer works is a key to application performance. V8 compiles JavaScript to native assembly and in some cases well written code could achieve performance comparable with GCC compiled applications.</p>
<p>And in case you are wondering, the new API application for my Toptal client, although there is room for improvement, is working very well!</p>
<p>Joyent recently released a new version of Node.js which uses one of the latest versions of V8. Some applications written for Node.js v0.12.x may not be compatible with the new v4.x release. However, applications will experience tremendous performance and memory usage improvement within the new version of Node.js.</p>

      
    </div>
    
      
    
  </div>
</article>




<article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2015/10/09/debugging-memory-leaks-node-js-applications/"></a></h1>
  

      
      <time datetime="2015-10-09T15:26:09.000Z">Oct 9 2015</time>
      
    </header>
    <div class="entry">
      
        <!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headeranchor-link {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .headeranchor-link:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .headeranchor,
.markdown-body h2 .headeranchor,
.markdown-body h3 .headeranchor,
.markdown-body h4 .headeranchor,
.markdown-body h5 .headeranchor,
.markdown-body h6 .headeranchor {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .headeranchor-link,
.markdown-body h2:hover .headeranchor-link,
.markdown-body h3:hover .headeranchor-link,
.markdown-body h4:hover .headeranchor-link,
.markdown-body h5:hover .headeranchor-link,
.markdown-body h6:hover .headeranchor-link {
  height: 1em;
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .headeranchor-link .headeranchor,
.markdown-body h2:hover .headeranchor-link .headeranchor,
.markdown-body h3:hover .headeranchor-link .headeranchor,
.markdown-body h4:hover .headeranchor-link .headeranchor,
.markdown-body h5:hover .headeranchor-link .headeranchor,
.markdown-body h6:hover .headeranchor-link .headeranchor {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* Multimarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\f05c';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><title>调试node.js应用的内存泄漏[译]</title></head><body><article class="markdown-body"><hr>
<p>原文：<a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external"><a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external"><a href="http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications" target="_blank" rel="external">http://www.toptal.com/nodejs/debugging-memory-leaks-node-js-applications</a></a></a></p>
<p>有一次，我开着一辆内部是V8双涡轮增压发动机的奥迪，其性能令人难以置信。凌晨3点，我行驶在芝加哥附近没有人的IL-80高速公路，时速达到140MPH。从那时起，“V8”这个术语成为我对高性能的认识。</p>
<blockquote>
<p>Node.js是一个建立在Chrome的JavaScript引擎V8之上的易于快速构建可伸缩的网络应用的平台。</p>
</blockquote>
<p>尽管奥迪的V8非常强大，但仍然限于用你的油箱的容量大小。这同样适用于谷歌的V8引擎 - 在node.js背后的JavaScript引擎。有很多因素使Node.js的性能是难以置信的，<a href="http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js" target="_blank" rel="external">适用于许多应用案例</a>，但是你总是受限于内存堆的大小。当你的Node.js应用程序需要处理更多的请求时，你有两个选择：就是规模垂直或水平扩展。水平扩展意味着你必须运行多个并发的应用程序实例。如果做得对，你最终能够服务更多的请求。垂直扩展意味着你要为你的应用实例提高应用程序的内存使用情况和可用的性能或增加资源。</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg" src="http://assets.toptal.io/uploads/blog/image/91676/toptal-blog-image-1442927311924-3c41bb7d7b1a8306609bcbe5570ccc63.jpg"></p>
<p>最近有为我的Toptal（一个开放外包的平台）客户修复一个运行在Node.js上应用程序的内存泄漏问题。该应用程序是一个能够在每一分钟处理成千上万请求的API服务器。最初的应用几乎占据了600MB的RAM，所以我们决定采取热API端来重新实现它们。当你需要服务于许多请求开销变得非常昂贵。</p>
<p>对于新的API，我们选择的restify以及本地的MongoDB的驱动程序和Kue后台服务。听起来像是一个非常轻量级的栈，对不对？其实不然。在高峰负荷新的应用程序实例可以消耗高达270MB的RAM。因此起两个每1X的Heroku Dyno应用实的想法破灭了。</p>
<h2 id="nodejs"><a name="user-content-nodejs" href="#nodejs" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Node.js 内存泄露调试军火库</h2>
<h3 id="memwatch"><a name="user-content-memwatch" href="#memwatch" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Memwatch</h3>
<p>如果你搜索“如何在node里发现泄露”这个第一个你或许会搜到的工具就是memwatch。原始的包很久以前就被遗弃，不再保留。但是你可以很容易地找到在GitHub上的fork的库的更新版本。该模块是有用的，如果它看到堆增长超过5个连续的垃圾收集，它可以触发泄漏事件。</p>
<h3 id="heapdump"><a name="user-content-heapdump" href="#heapdump" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Heapdump</h3>
<p>伟大的工具，它允许开发人员使用Chrome开发人员工具对Node.js采取堆快照后对其进行检查。</p>
<h3 id="node-inspector"><a name="user-content-node-inspector" href="#node-inspector" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Node-inspector</h3>
<p>即使是被更为有用的heapdump替代，但它任然可以让你连接到运行的应用程序，采取堆转储，甚至调试，并重新编译在程序运行中。</p>
<h2 id="node-inspector_1"><a name="user-content-node-inspector_1" href="#node-inspector_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>针对“node-inspector” 的说明</h2>
<p>不幸的是，将不能连接到被在Heroku运行生产的应用中，因为不允许信号被发送到运行的进程。然而，Heroku的是不是唯一的托管平台。</p>
<p>为了在实战中体验node-inspector，我们将使用的RESTify编写一个简单的Node.一点点内存泄漏的根源放在js应用程序中。这里所有的实验都是用Node.js v0.12.7和已编译的V8 v3.28.71.19。</p>
<pre><code class="javascript">var restify = require('restify');

var server = restify.createServer();

var tasks = [];

server.pre(function(req, res, next) {
  tasks.push(function() {
    return req.headers;
  });

  // Synchronously get user from session, maybe jwt token
  req.user = {
    id: 1,
    username: 'Leaky Master',
  };

  return next();
});

server.get('/', function(req, res, next) {
  res.send('Hi ' + req.user.username);
  return next();
});

server.listen(3000, function() {
  console.log('%s listening at %s', server.name, server.url);
});

</code></pre>

<p>这个应用有个很简单且明显的内存泄漏。这个tasks的数组在应用的生命周期内引发变慢，并最终导致崩溃。这个问题是，不仅仅是闭包泄漏，而是波及了整个请求对象。</p>
<p>在V8里使用了stop-the-world这种GC策略，因此，这意味着越多的对象在内存中驻留，回收的时间就越长。在下面的日志你可以清楚地看到，在应用程序的生命的开始，平均回收内存是20毫秒，但几十万的请求后，则需要大约230ms。如果这时访问我们的应用程序将不得不等待230ms之久，因为正在GC。你也可以看到每隔几秒钟调用GC，这意味着每隔几秒钟，用户访问我们的应用程序会遇到问题。随着延迟时间增长，直到程序崩溃。<br>
<pre><code>[28093]     7644 ms: Mark-sweep 10.9 (48.5) -&gt; 10.9 (48.5) MB, 25.0 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     7717 ms: Mark-sweep 10.9 (48.5) -&gt; 10.9 (48.5) MB, 18.0 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     7866 ms: Mark-sweep 11.0 (48.5) -&gt; 10.9 (48.5) MB, 23.2 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]     8001 ms: Mark-sweep 11.0 (48.5) -&gt; 10.9 (48.5) MB, 18.4 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

...

[28093]   633891 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 357.3 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]   635672 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 331.5 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

[28093]   637508 ms: Mark-sweep 235.7 (290.5) -&gt; 235.7 (290.5) MB, 357.2 ms [HeapObjectsMap::UpdateHeapObjectsMap] [GC in old space requested].

</code></pre></p>
<p>当在启动一个Node.js的应用时加上–trace_gc这个标示，就可以逐行打印这些日志。</p>
<pre><code>node --trace_gc app.js
</code></pre>

<p>Let us assume that we have already started our Node.js application with this flag. Before connecting the application with node-inspector, we need to send it the SIGUSR1 signal to the running process. If you run Node.js in cluster, make sure you connect to one of the slave processes.</p>
<p><pre><code>kill -SIGUSR1 $pid # Replace $pid with the actual process ID
</code></pre><br>
By doing this, we are making the Node.js application (V8 to be precise) enter debugging mode. In this mode, the application automatically opens the port 5858 with <a href="https://code.google.com/p/v8-wiki/wiki/DebuggerProtocol" target="_blank" rel="external">V8 Debugging Protocol</a>.</p>
<p>Our next step is to run node-inspector which will connect to the debugging interface of the running application and open another web interface on port 8080.</p>
<p><pre><code>$ node-inspector
Node Inspector v0.12.2
Visit http://127.0.0.1:8080/?ws=127.0.0.1:8080&amp;port=5858 to start debugging.
</code></pre><br>
In case the application is running on production and you have a firewall in place, we can tunnel remote port 8080 to localhost:</p>
<p><pre><code>ssh -L 8080:localhost:8080 admin@example.com
</code></pre><br>
Now you could open your Chrome web browser and get full access to Chrome Development Tools attached to your remote production application. Unfortunately, Chrome Developer Tools will not work in other browsers.</p>
<h2 id="lets-find-a-leak"><a name="user-content-lets-find-a-leak" href="#lets-find-a-leak" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Let’s Find a Leak!</h2>
<p>Memory leaks in V8 are not real memory leaks as we know them from C/C++ applications. In JavaScript variables do not disappear into the void, they just get “forgotten”. Our goal is to find these forgotten variables and remind them that Dobby is free.</p>
<p>Inside Chrome Developer Tools we have access to multiple profilers. We are particularly interested in Record Heap Allocations which runs and takes multiple heap snapshots over time. This gives us a clear peek into which objects are leaking.</p>
<p>Start recording heap allocations and let’s simulate 50 concurrent users on our home page using Apache Benchmark.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg" src="http://assets.toptal.io/uploads/blog/image/91677/toptal-blog-image-1442927477717.3-7c74dfceddd0955f27de9129eedf4261.jpg"></p>
<pre><code>ab -c 50 -n 1000000 -k http://example.com/
</code></pre>

<p>Before taking new snapshots, V8 would perform mark-sweep garbage collection, so we definitely know that there is no old garbage in the snapshot.</p>
<h2 id="fixing-the-leak-on-the-fly"><a name="user-content-fixing-the-leak-on-the-fly" href="#fixing-the-leak-on-the-fly" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Fixing the Leak on the Fly</h2>
<p>After collecting heap allocation snapshots over a period of 3 minutes we end up with something like the following:</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg" src="http://assets.toptal.io/uploads/blog/image/91678/toptal-blog-image-1442927547865.5-d0c4450569bc2a285b3007eca57dfa25.jpg"></p>
<p>We can clearly see that there are some gigantic arrays, a lot of IncomingMessage, ReadableState, ServerResponse and Domain objects as well in heap. Let’s try to analyze the source of the leak.</p>
<p>Upon selecting heap diff on chart from 20s to 40s, we will only see objects which were added after 20s from when you started the profiler. This way you could exclude all normal data.</p>
<p>Keeping note of how many objects of each type are in the system, we expand the filter from 20s to 1min. We can see that the arrays, already quite gigantic, keeps growing. Under “(array)” we can see that there are a lot of objects “(object properties)” with equal distance. Those objects are the source of our memory leak.</p>
<p>Also we can see that “(closure)” objects grow rapidly as well.</p>
<p>It might be handy to look at the strings as well. Under the strings list there are a lot of “Hi Leaky Master” phrases. Those might give us some clue too.</p>
<p>In our case we know that the string ”Hi Leaky Master” could only be assembled under the “GET /” route.</p>
<p>If you open retainers path you will see this string is somehow referenced via req, then there is context created and all this added to some giant array of closures.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg" src="http://assets.toptal.io/uploads/blog/image/91679/toptal-blog-image-1442927578118.2-af56af07dcf63ead26df3f9b9cd1aa78.jpg"></p>
<p>So at this point we know that we have some kind of gigantic array of closures. Let’s actually go and give a name to all our closures at real-time under sources tab.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg" src="http://assets.toptal.io/uploads/blog/image/91680/toptal-blog-image-1442927612747.1-102c5cf7bb68bcfc12181ab69333a520.jpg"></p>
<p>After we are done editing the code, we can hit CTRL+S to save and recompile code on the fly!</p>
<p>Now let’s record another Heap Allocations Snapshot and see which closures are occupying the memory.</p>
<p>It’s clear that SomeKindOfClojure() is our villain. Now we can see that SomeKindOfClojure() closures are being added to some array named tasks in the global space.</p>
<p>It’s easy to see that this array is just useless. We can comment it out. But how do we free memory the memory already occupied? Very easy, we just assign an empty array to tasks and with the next request it will be overridden and memory will be freed after next GC event.</p>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg" src="http://assets.toptal.io/uploads/blog/image/91681/toptal-blog-image-1442927629279.4-24b223edd5e9b530625bd595fc50c4d1.jpg"></p>
<p>Dobby is free!</p>
<h2 id="life-of-garbage-in-v8"><a name="user-content-life-of-garbage-in-v8" href="#life-of-garbage-in-v8" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Life of Garbage in V8</h2>
<p><img alt="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg" src="http://assets.toptal.io/uploads/blog/image/91682/toptal-blog-image-1442928276284-e3da8ab85a898674f8f39088768b617a.jpg"></p>
<p>Well, V8 JS does not have memory leaks, only forgotten variables.</p>
<p>V8 heap is divided into several different spaces:</p>
<p>New Space: This space is relatively small and has a size of between 1MB and 8MB. Most of the objects are allocated here.</p>
<ul>
<li>Old Pointer Space: Has objects which may have pointers to other objects. If object survives long enough in New Space it gets promoted to Old Pointer Space.</li>
<li>Old Data Space: Contains only raw data like strings, boxed numbers and arrays of unboxed doubles. Objects that have survived GC in the New Space for long enough are moved here as well.</li>
<li>Large Object Space: Objects which are too big to fit in other spaces are created in this space. Each object has it’s own mmap‘ed region in memory</li>
<li>Code space: Contains assembly code generated by the JIT compiler.</li>
<li>Cell space, property cell space, map space: This space contains Cells, PropertyCells, and Maps. This is used to simplify garbage collection.</li>
</ul>
<p>Each space is composed of pages. A page is a region of memory allocated from the operating system with mmap. Each page is always 1MB in size except for pages in large object space.</p>
<p>V8 has two built in garbage collection mechanisms: Scavenge, Mark-Sweep and Mark-Compact.</p>
<p>Scavenge is a very fast garbage collection technique and operates with objects in New Space. Scavenge is the implementation of <a href="http://en.wikipedia.org/wiki/Cheney's_algorithm" target="_blank" rel="external">Cheney’s Algorithm</a>. The idea is very simple, New Space is divided in two equal semi-spaces: To-Space and From-Space. Scavenge GC occurs when To-Space is full. It simply swaps To and From spaces and copy all live objects to To-Space or promote them to one of the old spaces if they survived two scavenges, and is then entirely erased from the space. Scavenges are very fast however they have the overhead of keeping double sized heap and constantly copying objects in memory. The reason to use scavenges is because most objects die young.</p>
<p>Mark-Sweep &amp; Mark-Compact is another type of garbage collector used in V8. The other name is full garbage collector. It marks all live nodes, then sweeps all dead nodes and defragments memory.</p>
<h3 id="gc-performance-and-debugging-tips"><a name="user-content-gc-performance-and-debugging-tips" href="#gc-performance-and-debugging-tips" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>GC Performance and Debugging Tips</h3>
<p>While for web applications high performance might not be such a big problem, you will still want to avoid leaks at all costs. During the mark phase in full GC the application is actually paused until garbage collection is completed. This means the more objects you have in the heap, the longer it will take to perform GC and the longer users will have to wait.</p>
<h3 id="always-give-names-to-closures-and-functions"><a name="user-content-always-give-names-to-closures-and-functions" href="#always-give-names-to-closures-and-functions" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Always give names to closures and functions</h3>
<p>It’s much easier to inspect stack traces and heaps when all your closures and functions have names.<br>
<pre><code class="javascript">db.query('GIVE THEM ALL', function GiveThemAllAName(error, data) {
    ...
})
</code></pre></p>
<h3 id="avoid-large-objects-in-hot-functions"><a name="user-content-avoid-large-objects-in-hot-functions" href="#avoid-large-objects-in-hot-functions" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Avoid large objects in hot functions</h3>
<p>Ideally you want to avoid large objects inside of hot functions so that all data is fit into New Space. All CPU and memory bound operations should be executed in background. Also avoid deoptimization triggers for hot functions, optimized hot function uses less memory than non-optimized ones.</p>
<h3 id="hot-functions-should-be-optimized"><a name="user-content-hot-functions-should-be-optimized" href="#hot-functions-should-be-optimized" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Hot functions should be optimized</h3>
<p>Hot functions that run faster but also consume less memory cause GC to run less often. V8 provides some helpful debugging tools to spot non-optimized functions or deoptimized functions.</p>
<p>Avoid polymorphism for IC’s in hot functions</p>
<p>Inline Caches (IC) are used to speed up execution of some chunks of code, either by caching object property access obj.key or some simple function.<br>
<pre><code class="javscript">function x(a, b) {
  return a + b;
}

x(1, 2); // monomorphic
x(1, “string”); // polymorphic, level 2
x(3.14, 1); // polymorphic, level 3
</code></pre><br>
When <code>x(a,b)</code> is run for the first time, V8 creates a monomorphic IC. When you call x a second time, V8 erases the old IC and creates a new polymorphic IC which supports both types of operands integer and string. When you call IC the third time, V8 repeats the same procedure and creates another polymorphic IC of level 3.</p>
<p>However, there is a limitation. After IC level reaches 5 (could be changed with <code>–max_inlining_levels</code> flag) the function becomes megamorphic and is no longer considered optimizable.</p>
<p>It’s intuitively understandable that monomorphic functions run the fastest and also have a smaller memory footprint.</p>
<h3 id="dont-add-large-files-to-memory"><a name="user-content-dont-add-large-files-to-memory" href="#dont-add-large-files-to-memory" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Don’t add large files to memory</h3>
<p>This one is obvious and well known. If you have large files to process, for example a large CSV file, read it line-by-line and process in little chunks instead of loading the entire file to memory. There are rather rare cases where a single line of csv would be larger than 1mb, thus allowing you to fit it in New Space.</p>
<h3 id="do-not-block-main-server-thread"><a name="user-content-do-not-block-main-server-thread" href="#do-not-block-main-server-thread" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Do not block main server thread</h3>
<p>If you have some hot API which takes some time to process, such as an API to resize images, move it to a separate thread or turn it into a background job. CPU intensive operations would block main thread forcing all other customers to wait and keep sending requests. Unprocessed request data would stack in memory, thus forcing full GC to take longer time to finish.</p>
<h3 id="do-not-create-unnecessary-data"><a name="user-content-do-not-create-unnecessary-data" href="#do-not-create-unnecessary-data" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Do not create unnecessary data</h3>
<p>I once had a weird experience with restify. If you send a few hundred thousand requests to an invalid URL then the application memory would rapidly grow on up to hundred megabytes until a full GC kicks in a few seconds later, which is when everything would go back to normal. Turns out that for each invalid URL, restify generates a new error object which includes long stack traces. This forced newly created objects to be allocated in Large Object Space rather than in New Space.</p>
<p>Having access to such data could be very helpful during development, but obviously not required on production. Therefore the rule is simple - do not generate data unless you certainly need it.</p>
<h3 id="know-your-tools"><a name="user-content-know-your-tools" href="#know-your-tools" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Know your tools</h3>
<p>Last, but certainly not the least, is to know your tools. There are various debuggers, leak cathers, and usage graphs generators. All those tools can help you make your software faster and more efficient.</p>
<h3 id="conclusion"><a name="user-content-conclusion" href="#conclusion" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Conclusion</h3>
<p>Understanding how V8’s garbage collection and code optimizer works is a key to application performance. V8 compiles JavaScript to native assembly and in some cases well written code could achieve performance comparable with GCC compiled applications.</p>
<p>And in case you are wondering, the new API application for my Toptal client, although there is room for improvement, is working very well!</p>
<p>Joyent recently released a new version of Node.js which uses one of the latest versions of V8. Some applications written for Node.js v0.12.x may not be compatible with the new v4.x release. However, applications will experience tremendous performance and memory usage improvement within the new version of Node.js.</p></article></body></html>
      
    </div>
    
      
    
  </div>
</article>




<div class="pagination">
  <table width='100%'>
    <tbody>
    <tr>
      <td width='120' align='left'>
        
      </td>
      <td width='auto' align='center'>
          <a href="/archives/">文章归档</a>
      </td>
      <td width='120' align='right'>
        
      </td>
    </tr>
    </tbody>
  </table>
</div>




</div></div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="inner"><div class="alignleft">
  <p>
  
    &copy; 2015 H1bomb
  
  </p>
  <p>
    <a href="http://github.com/willerce/hexo-theme-noderce">Noderce</a> Theme By <a href="http://willerce.com" >willerce</a>
  </p>

</div>
<div class="clearfix"></div></div></footer>
  <script type="text/javascript">

</script>

</body>
</html>
